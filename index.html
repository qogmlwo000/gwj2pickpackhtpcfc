<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GWJ2 CFC PICK & PACK HTP TOOL_Bennett (v2.5)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/qogmlwo000/gwj2pickpackhtp/main/Bennett.ico" type="image/x-icon">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="CFC PICK & PACK HTP TOOL_Bennett">
    <meta property="og:description" content="엑셀 파일을 업로드하여 실시간으로 HTP 데이터를 공유하고 분석하세요.">
    <meta property="og:image" content="https://github.com/qogmlwo000/gwj2pickpackhtp/blob/main/Bennett.png?raw=true">
    <meta property="og:url" content="https://qogmlwo000.github.io/gwj2pickpackhtp/">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
	
		:root {
            --transition-speed: 0s;
        }
        
        /* Light Mode Colors */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-hover: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #06b6d4;
        }

        /* Dark Mode Colors */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-hover: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* 필요한 요소만 transition 적용 */
        body,
        #sidebar,
        #main-content,
        .card,
        button,
        input,
        .filter-btn,
        .view-tab,
        .kpi-card,
        label {
            transition: background-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease;
        }

        /* Forms - 체크박스 스타일 (별도로 작성) */
        .form-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.1rem;
            height: 1.1rem;
            border: 2px solid #94a3b8; /* 기본 회색 테두리 */
            border-radius: 4px;
            background-color: #f1f5f9; /* 라이트 배경 */
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            flex-shrink: 0;
        }
        
        /* 다크모드에서 명확하게 보이도록 */
        [data-theme="dark"] .form-checkbox {
            background-color: #0f172a; /* 더 어두운 배경 */
            border: 2px solid #60a5fa; /* 밝은 파란색 테두리 */
        }
        
        .form-checkbox:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }
        
        .form-checkbox:checked {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-color: var(--accent-primary);
        }
        
        .form-checkbox:checked::after {
            content: '✔';
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
        }
        
        .form-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            scrollbar-width: thin;
        }
        
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 5px; border: 2px solid var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
		
		/* Layout */
        .app-container { display: flex; height: 100vh; background-color: var(--bg-primary); }
        
        #sidebar {
            width: 300px;
            transition: margin-left var(--transition-speed) ease-in-out, transform var(--transition-speed) ease-in-out;
            position: fixed; top: 0; left: 0; height: 100%; z-index: 40;
            transform: translateX(-100%);
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }
        #sidebar.open { transform: translateX(0); }
        #main-content { transition: margin-left var(--transition-speed) ease-in-out; width: 100%; background-color: var(--bg-primary); }

        @media (min-width: 1024px) {
            #sidebar { position: static; transform: translateX(0); }
            #main-content { flex: 1; min-width: 0; }
            .app-container.sidebar-collapsed #sidebar { margin-left: -300px; }
            #sidebar-toggle-desktop { display: block; }
            #sidebar-toggle-mobile { display: none; }
        }
        @media (max-width: 1023px) {
            #sidebar-toggle-desktop { display: none; }
            #sidebar-toggle-mobile { display: block; }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: relative; width: 60px; height: 30px;
            background: var(--bg-tertiary); border-radius: 30px;
            cursor: pointer; display: flex; align-items: center; padding: 3px;
            border: 2px solid var(--border-color);
        }
        .theme-toggle-slider {
            width: 22px; height: 22px;
            background: var(--accent-primary); border-radius: 50%;
            transition: transform var(--transition-speed) ease;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-md);
        }
        [data-theme="dark"] .theme-toggle-slider { transform: translateX(30px); }

        /* Status & Loader */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 8px currentColor; }
        .status-connected { background-color: var(--success); animation: pulse-success 2s infinite; }
        .status-disconnected { background-color: var(--error); }
        .status-loading { background-color: var(--warning); animation: pulse-warning 1.5s infinite; }
        @keyframes pulse-success { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes pulse-warning { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Buttons & Filters */
        .filter-btn { background-color: var(--bg-tertiary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.2s ease; }
        .filter-btn:hover { background-color: var(--bg-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .filter-btn.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .filter-group-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; }

        button { background-color: var(--bg-tertiary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 8px; padding: 8px 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        button:hover { background-color: var(--bg-hover); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        button:active { transform: translateY(0); }
        .bg-blue-600 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important; color: white !important; border-color: #3b82f6 !important; }
        .bg-blue-600:hover { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important; }

        /* Cards & Views */
        .card { background-color: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); transition: all 0.3s ease; }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .view-tab { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 2px solid var(--border-color); transition: all 0.2s ease; font-weight: 600; }
        .view-tab:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .view-tab.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        /* Title & Ticker */
        #main-title { animation: color-cycle 10s infinite linear; font-weight: 800; letter-spacing: -0.5px; }
        @keyframes color-cycle { 0% { color: #ef4444; } 14% { color: #f59e0b; } 28% { color: #eab308; } 42% { color: #10b981; } 57% { color: #3b82f6; } 71% { color: #6366f1; } 85% { color: #a855f7; } 100% { color: #ef4444; } }
        #ticker-container { overflow: hidden; white-space: nowrap; position: relative; background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-tertiary) 50%, var(--bg-secondary) 100%); border-radius: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        #ticker-text { position: absolute; animation: ticker-scroll 20s linear infinite; font-weight: 700; background: linear-gradient(90deg, #f59e0b, #eab308, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        @keyframes ticker-scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* Table */
        .table-container { flex-grow: 1; overflow: auto; -webkit-overflow-scrolling: touch; background-color: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); }
        #data-table { background-color: var(--bg-secondary); }
        #data-table thead { background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-hover) 100%); backdrop-filter: blur(10px); }
        #data-table th { color: var(--text-primary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid var(--border-color); white-space: nowrap; padding: 16px; }
        #data-table td { border-right: 1px solid var(--border-color); white-space: nowrap; padding: 12px 16px; color: var(--text-secondary); }
        #data-table th:last-child, #data-table td:last-child { border-right: none; }
        #data-table tbody tr { background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
        #data-table tbody tr:hover { background-color: var(--bg-hover); box-shadow: var(--shadow-sm); }
        .sortable { cursor: pointer; position: relative; user-select: none; }
        .sort-indicator { display: inline-block; width: 1em; height: 1em; margin-left: 4px; vertical-align: middle; opacity: 0.4; transition: opacity 0.2s, color 0.2s; }
        .sortable:hover .sort-indicator { opacity: 0.8; }
        .sort-indicator.asc, .sort-indicator.desc { opacity: 1; color: var(--accent-primary); font-weight: bold; }
        .hidden-col { display: none; }

        /* Forms */
        .form-checkbox { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 1.1rem; height: 1.1rem; border: 2px solid var(--border-color); border-radius: 4px; background-color: var(--bg-tertiary); transition: all 0.2s ease; cursor: pointer; position: relative; vertical-align: middle; flex-shrink: 0; }
        .form-checkbox:hover { border-color: var(--accent-primary); transform: scale(1.05); }
        .form-checkbox:checked { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); border-color: var(--accent-primary); }
        .form-checkbox:checked::after { content: '✔'; font-size: 0.8rem; font-weight: bold; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); line-height: 1; }
        .form-checkbox:focus { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        input[type="text"], input[type="number"] { background-color: var(--bg-tertiary); border: 2px solid var(--border-color); color: var(--text-primary); transition: all 0.2s ease; }
        input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); background-color: var(--bg-secondary); }
        input[type="text"]::placeholder { color: var(--text-tertiary); }

        /* Dashboard */
        .kpi-card { background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border-left: 4px solid var(--accent-primary); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .kpi-card h4 { color: var(--text-tertiary); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-card p { color: var(--text-primary); font-size: 2rem; font-weight: 800; margin-top: 0.5rem; }

        /* Modals */
        #chart-modal-backdrop { background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); }
        #chart-modal-content { max-height: 80vh; background-color: var(--bg-secondary); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); }
        #sidebar-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }

        /* Text Colors */
        .text-gray-200, .text-white { color: var(--text-primary) !important; }
        .text-gray-300 { color: var(--text-secondary) !important; }
        .text-gray-400, .text-gray-500 { color: var(--text-tertiary) !important; }
        .text-blue-400 { color: #60a5fa !important; }
        .text-yellow-400 { color: #fbbf24 !important; }
        .text-red-400 { color: #f87171 !important; }
        .text-green-400 { color: #4ade80 !important; }
        .text-yellow-300 { color: #fcd34d !important; }
        .text-lime-400 { color: #a3e635 !important; }
        
        /* 라이트모드에서는 더 진한 녹색 */
        [data-theme="light"] .text-lime-400 {
            color: #16a34a !important;
            font-weight: 600;
        }
		
		/* 라이트모드에서는 더 진한 노란색/주황색 */
        [data-theme="light"] .text-yellow-300 {
            color: #d97706 !important; /* amber-600 - 더 진한 주황색 */
        }

        /* Utility */
        .bg-gray-800, .bg-gray-700 { background-color: var(--bg-secondary) !important; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        .bg-gray-700 { background-color: var(--bg-tertiary) !important; }
        label { color: var(--text-secondary); transition: color 0.2s ease; }
        label:hover { color: var(--text-primary); }
        .rounded-lg { border-radius: 12px !important; }
        .rounded-md { border-radius: 8px !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { animation: fadeIn 0.3s ease-out; }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">

<div id="app-container" class="app-container">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-gray-800 p-4 flex-shrink-0 flex flex-col space-y-4 overflow-y-auto">
        <div class="flex items-center justify-between border-b pb-3" style="border-color: var(--border-color);">
            <h2 class="text-xl font-bold text-white">⚙️ 필터 및 설정</h2>
            <!-- Theme Toggle -->
            <div class="theme-toggle" id="theme-toggle">
                <div class="theme-toggle-slider">
                    <span id="theme-icon">🌙</span>
                </div>
            </div>
        </div>
        
        <!-- Time Filters -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">⏰ 시간대별 필터</h3>
            <div class="space-y-2">
                <label class="flex items-center space-x-2 text-sm cursor-pointer"><input type="checkbox" id="all-hours-checkbox" class="form-checkbox" checked><span>전체 시간</span></label>
                <div id="hour-filters" class="filter-group-grid pt-2 border-t" style="border-color: var(--border-color);"></div>
                <div class="flex space-x-2 pt-2 border-t" style="border-color: var(--border-color);">
                    <button id="select-all-hours" class="text-xs py-1 px-2 rounded w-full">모두 선택</button>
                    <button id="deselect-all-hours" class="text-xs py-1 px-2 rounded w-full">모두 해제</button>
                </div>
            </div>
        </div>

        <!-- Floor Filters -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">📶 층별 필터 (집품)</h3>
            <div id="floor-filters" class="space-y-2"></div>
            <div class="flex space-x-2 pt-2 mt-2 border-t" style="border-color: var(--border-color);">
                <button id="select-all-floors" class="text-xs py-1 px-2 rounded w-full">모두 선택</button>
                <button id="deselect-all-floors" class="text-xs py-1 px-2 rounded w-full">모두 해제</button>
            </div>
        </div>

        <!-- Pack Type Filters -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">📦 팩 종류 필터 (포장)</h3>
            <div id="pack-type-filters" class="space-y-2"></div>
             <div class="flex space-x-2 pt-2 mt-2 border-t" style="border-color: var(--border-color);">
                <button id="select-all-packtypes" class="text-xs py-1 px-2 rounded w-full">모두 선택</button>
                <button id="deselect-all-packtypes" class="text-xs py-1 px-2 rounded w-full">모두 해제</button>
            </div>
        </div>
        
        <!-- Target HTP Settings -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">🎯 Target HTP 설정</h3>
            <div id="target-htp-settings" class="space-y-2 text-sm"></div>
        </div>
    </aside>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 flex flex-col">
        <div class="w-full bg-gray-800 shadow-lg p-4 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button id="sidebar-toggle-desktop" class="p-2 rounded-md hover:bg-gray-700 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <button id="sidebar-toggle-mobile" class="p-2 rounded-md hover:bg-gray-700 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div>
                        <h1 id="main-title" class="text-2xl font-extrabold">🚀 GWJ2 CFC OB PICK & PACK HTP TOOL</h1>
                        <p class="text-gray-400 text-sm">한 명이 엑셀을 올리면 모두에게 실시간으로 반영됩니다.</p>
                    </div>
                </div>
                <div id="status-indicator" class="flex items-center">
                    <div class="status-dot status-disconnected"></div>
                    <span class="font-medium text-sm">연결 상태: 확인 중...</span>
                </div>
            </div>
        </div>

        <div class="p-4 space-y-4 flex flex-col flex-shrink-0">
            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-800 p-3 rounded-lg flex items-center space-x-2">
                    <button id="filter-all" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md active">전체</button>
                    <button id="filter-pick" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md">🟦 PICK</button>
                    <button id="filter-pack" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md">🟨 PACK</button>
                </div>
                <div class="bg-gray-800 p-3 rounded-lg flex items-center">
                    <input type="text" id="search-input" placeholder="🔍 이름(원바코드) 검색..." class="w-full rounded-md py-2 px-3 text-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="bg-gray-800 p-3 rounded-lg flex items-center space-x-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="low-htp-toggle" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                        <span class="ml-3 text-sm font-medium">🚨 저조자만 보기</span>
                    </label>
                    <button id="capture-btn" class="py-2 px-3 text-sm font-semibold rounded-md">📷 캡처</button>
                    <button id="export-btn" class="py-2 px-3 text-sm font-semibold rounded-md">📊 엑셀</button>
                </div>
            </div>
            
            <!-- Ticker -->
            <div id="ticker-container" class="p-2 rounded-lg text-sm">
                <div id="ticker-text-wrapper" class="relative w-full h-5 overflow-hidden">
                    <span id="ticker-text">Top/Low HTP 정보가 여기에 표시됩니다.</span>
                </div>
            </div>

            <!-- Stats & Upload -->
            <div class="bg-gray-800 p-3 rounded-lg flex flex-col md:flex-row justify-between items-center text-sm">
                 <div id="stats-display" class="text-gray-300 mb-2 md:mb-0 text-center md:text-left">
                    표시 그룹: <span class="font-bold text-white">-</span> | 
                    작업자 수: <span class="font-bold text-white">-</span> | 
                    총 작업량: <span class="font-bold text-white">-</span> | 
                    평균 HTP: <span class="font-bold text-white">-</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p>마지막 업데이트: <span id="last-updated" class="font-semibold text-gray-200">데이터 없음</span></p>
                        <p>업로더: <span id="last-uploader" class="font-semibold text-gray-200">데이터 없음</span></p>
                    </div>
                    <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls">
                    <label for="file-upload" class="cursor-pointer py-2 px-4 rounded-lg border-0 text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700">엑셀 업로드</label>
                </div>
            </div>
        </div>

        <!-- View Switcher -->
        <div class="px-4 pt-2">
            <div class="bg-gray-800 p-1 rounded-lg flex space-x-1">
                <button id="table-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md active">데이터 보기</button>
                <button id="dashboard-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md">대시보드</button>
            </div>
        </div>
		
		<!-- Table View -->
        <div id="table-view" class="flex flex-col flex-grow min-h-0">
            <div id="loader-container" class="flex-1 flex justify-center items-center hidden"><div class="loader"></div></div>
            <div class="table-container px-4 pb-4">
                <table id="data-table" class="min-w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="processType">집품/포장<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="employee">이름(원바코드)<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="unitQty">작업량<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="location">로케이션 및 작업대<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="processPathName">PP<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="packType">팩 종류<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="mh">M/H<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="htp">HTP<span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-gray-800">
                        <tr id="placeholder-row"><td colspan="8" class="text-center py-10 text-gray-500">엑셀 파일을 업로드하여 데이터를 확인하세요.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">총 작업자 수</h4>
                    <p id="kpi-total-workers" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">총 작업량 (Unit)</h4>
                    <p id="kpi-total-qty" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">전체 평균 HTP</h4>
                    <p id="kpi-avg-htp" class="text-3xl font-bold text-white">0.0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow border-l-red-500">
                    <h4 class="text-gray-400 text-sm font-medium">저조자 수</h4>
                    <p id="kpi-low-performers" class="text-3xl font-bold text-red-400">0</p>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                <div class="bg-gray-800 p-4 rounded-lg xl:col-span-1">
                    <h3 class="text-lg font-semibold mb-2 text-white">프로세스별 비교</h3>
                    <div class="relative h-64 md:h-80"><canvas id="process-comparison-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg xl:col-span-2">
                    <h3 class="text-lg font-semibold mb-2 text-white">시간대별 HTP 트렌드</h3>
                    <div class="relative h-64 md:h-80"><canvas id="hourly-htp-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-white">층별 평균 HTP (집품)</h3>
                    <div class="relative h-96"><canvas id="floor-htp-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-white">팩 종류별 작업량 (포장)</h3>
                    <div class="relative h-96"><canvas id="pack-type-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg lg:col-span-2 xl:col-span-1">
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 h-full">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-white">🏆 Top 5 PICK</h3>
                            <ul id="top-pick-performers-list" class="space-y-2 text-sm"></ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-white">🏆 Top 5 PACK</h3>
                            <ul id="top-pack-performers-list" class="space-y-2 text-sm"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Chart Modal -->
<div id="chart-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="chart-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl p-6 relative flex flex-col">
        <h3 id="chart-modal-title" class="text-xl font-bold text-white mb-4">개인 HTP 추이</h3>
        <div class="flex-grow min-h-0"><canvas id="individual-htp-chart"></canvas></div>
        <button id="chart-modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
</div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, Bytes } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Theme Management ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = theme === 'dark' ? '🌙' : '☀️';
            }
        }

        // Initialize theme immediately
        initTheme();

        // --- UI Elements ---
        const ui = {
            appContainer: document.getElementById('app-container'),
            fileUpload: document.getElementById('file-upload'),
            tableBody: document.getElementById('data-table-body'),
            tableHeader: document.querySelector('#data-table thead'),
            placeholderRow: document.getElementById('placeholder-row'),
            loaderContainer: document.getElementById('loader-container'),
            statusIndicator: document.getElementById('status-indicator'),
            lastUpdatedEl: document.getElementById('last-updated'),
            lastUploaderEl: document.getElementById('last-uploader'),
            sidebar: document.getElementById('sidebar'),
            sidebarToggleDesktop: document.getElementById('sidebar-toggle-desktop'),
            sidebarToggleMobile: document.getElementById('sidebar-toggle-mobile'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            floorFilters: document.getElementById('floor-filters'),
            packTypeFilters: document.getElementById('pack-type-filters'),
            hourFilters: document.getElementById('hour-filters'),
            searchInput: document.getElementById('search-input'),
            lowHtpToggle: document.getElementById('low-htp-toggle'),
            statsDisplay: document.getElementById('stats-display'),
            captureBtn: document.getElementById('capture-btn'),
            exportBtn: document.getElementById('export-btn'),
            targetHtpSettings: document.getElementById('target-htp-settings'),
            tickerText: document.getElementById('ticker-text'),
            tableViewBtn: document.getElementById('table-view-btn'),
            dashboardViewBtn: document.getElementById('dashboard-view-btn'),
            tableView: document.getElementById('table-view'),
            dashboardView: document.getElementById('dashboard-view'),
            chartModalBackdrop: document.getElementById('chart-modal-backdrop'),
            chartModalTitle: document.getElementById('chart-modal-title'),
            chartModalClose: document.getElementById('chart-modal-close'),
            kpi: {
                totalWorkers: document.getElementById('kpi-total-workers'),
                totalQty: document.getElementById('kpi-total-qty'),
                avgHtp: document.getElementById('kpi-avg-htp'),
                lowPerformers: document.getElementById('kpi-low-performers'),
            },
            topPickPerformersList: document.getElementById('top-pick-performers-list'),
            topPackPerformersList: document.getElementById('top-pack-performers-list'),
        };

        // --- Global State ---
        let globalRawData = []; 
        let state = {
            filters: {
                process: 'all', search: '', lowHtp: false,
                hours: new Set(), floors: new Set(), packTypes: new Set()
            },
            sort: { key: 'htp', direction: 'asc' },
            charts: { floorHtp: null, packType: null, individualHtp: null, processComparison: null, hourlyHtp: null }
        };
        let targetHtpValues = {};

        // --- Constants ---
        const PACK_TYPE_MAP = {
            "메뉴얼팩": "179_1.3F_MA_S_OG_", "메뉴얼팩 멀티": "179_1.3F_MA_M_OG_", "ACE LINE": "179-1.2F-MA-ACE-OG-",
            "오토백 1.2": "179_1.3F_AB_R1.2_OG_", "오토백 2.5": "179_1.3F_AB_R2.5_OG_", "오토백 4.0": "179_1.3F_AB_R4.0_OG_",
            "오토백 RTPB": "179_1.3F_AB_T1_OG_", "오토백 멀티": "179_1.3F_AB_M_OG_", "CFC 메뉴얼팩": "190_6.2F_MA_S_OG_",
            "CFC 메뉴얼팩 멀티": "190_6.2F_MA_M_OG_", "CFC 오토백 2.5": "190_6.2F_AB_R2.5_OG_", "CFC 오토백 4.0": "190_6.2F_AB_R4.0_OG_",
            "CFC 오토백 RTPB": "190_6.2G_AB_T1_OG_"
        };
        const DEFAULT_PACK_TYPE = "기타";
        const MANAGERS_LIST = ['26485305', '94354606', '66476877', '21284456', '24856615', '21019991', '87406548', '29801698', '27407697', '92816677', '65712250', '29787775', '37005613', '24304330', '27507426', '97224272', '92718820', '83689729', '36148186', '98659377', '97724155', '96792527', '24624169', '64118293', '50908038', '21220693', '41310393', '30997520', '66536830', '92733138', '77358628', '39359504', '25657753', '29229926', '46802436', '58548628', '93246435', '42103385', '26152514', '95383395', '55540763', '53909931', '28996527', '96358817', '56805916', '62613130', '47848283', '39678603', '58728654', '38876677', '68100618', '56334308'];
        
        const TARGET_HTP_DEFAULTS = {
            "Manual SINGULATION": { value: 100, keywords: ['ManualPack', '179_1.3F_MA_S_OG_'] },
            "Manual MULTI": { value: 120, keywords: ['7F_Multi_AGV', '179_1.3F_MA_M_OG_'] },
            "ACE LINE": { value: 150, keywords: ['ACE', '179-1.2F-MA-ACE-OG-'] },
            "Autobagger 1.2": { value: 380, keywords: ['Autobag1.2', '179_1.3F_AB_R1.2_OG_', 'AGV_Autobag1.2DW'] },
            "Autobagger 2.5": { value: 350, keywords: ['Autobag2.5', '179_1.3F_AB_R2.5_OG_'] },
            "Autobagger 4.0": { value: 280, keywords: ['Autobag4.0', '179_1.3F_AB_R4.0_OG_'] },
            "Autobagger RTPB": { value: 150, keywords: ['Autobag_RTPB1', '179_1.3F_AB_T1_OG_'] },
            "Auto MULTI": { value: 250, keywords: ['AGV_Multi_Autobag4.0', '179_1.3F_AB_M_OG_'] },
            "CFC Manual S": { value: 100, keywords: ['190_6.2F_MA_S_OG_'] },
            "CFC Manual M": { value: 120, keywords: ['190_6.2F_MA_M_OG_'] },
            "CFC Autobag 2.5": { value: 350, keywords: ['190_6.2F_AB_R2.5_OG_'] },
            "CFC Autobag 4.0": { value: 280, keywords: ['190_6.2F_AB_R4.0_OG_'] },
            "CFC Autobag RTPB": { value: 150, keywords: ['190_6.2G_AB_T1_OG_'] },
            "PICK": { value: 90, keywords: [] }
        };
        for(const key in TARGET_HTP_DEFAULTS) {
            targetHtpValues[key] = TARGET_HTP_DEFAULTS[key].value;
        }

        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyAKxH0QXnVTQMpfWJYdMUhHoMIwF89bgjU",
			authDomain: "gwj2-cfchtp-tool.firebaseapp.com",
			projectId: "gwj2-cfchtp-tool",
			storageBucket: "gwj2-cfchtp-tool.firebasestorage.app",
			messagingSenderId: "870169870004",
			appId: "1:870169870004:web:aaf9034bb1dd5eb07621e1",
			measurementId: "G-0E55KNF6GB"
        };
        let db, auth, userId, dataDocRef;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            dataDocRef = doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'htpData', 'latestCompressed');
        } catch(e) {
            console.error("Firebase 초기화 오류:", e);
            updateStatus('disconnected', 'Firebase 초기화에 실패했습니다.');
        }
		
		onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                updateStatus('connected', '실시간 서버에 연결되었습니다.');
                ui.fileUpload.disabled = false;
                setupRealtimeListener();
            } else {
                try { await signInAnonymously(auth); } catch (error) {
                    console.error("익명 로그인 오류:", error);
                    updateStatus('disconnected', '서버에 연결할 수 없습니다.');
                }
            }
        });

        function setupRealtimeListener() {
            onSnapshot(dataDocRef, (docSnap) => {
                showLoader();
                if (docSnap.exists()) {
                    const dataPayload = docSnap.data();
                    try {
                        const compressedBytes = dataPayload.compressedData;
                        if (!compressedBytes) throw new Error("압축된 데이터가 없습니다.");
                        const compressedUint8Array = compressedBytes.toUint8Array();
                        const decompressedString = pako.ungzip(compressedUint8Array, { to: 'string' });
                        const parsedData = JSON.parse(decompressedString);
                        globalRawData = parsedData.map(item => ({
                            ...item,
                            htpStart: new Date(item.htpStart),
                            htpEnd: new Date(item.htpEnd),
                        }));
                        ui.lastUploaderEl.textContent = dataPayload.uploaderId.substring(0, 8) + '...';
                        ui.lastUpdatedEl.textContent = new Date(dataPayload.timestamp).toLocaleString('ko-KR');
                        initializeFiltersFromData(globalRawData);
                        applyFiltersAndRender();
                    } catch (error) {
                        console.error("데이터 압축 해제 또는 파싱 오류:", error);
                        showModal("서버로부터 받은 데이터를 처리하는 데 실패했습니다.");
                        globalRawData = [];
                        applyFiltersAndRender();
                    }
                } else {
                    globalRawData = [];
                    initializeFiltersFromData([]);
                    applyFiltersAndRender();
                }
                hideLoader();
            }, (error) => {
                console.error("실시간 데이터 수신 오류:", error);
                updateStatus('disconnected', '데이터 수신 중 오류 발생');
                hideLoader();
            });
        }

        // --- Event Listeners ---
        function toggleMobileSidebar() {
            const isOpen = ui.sidebar.classList.toggle('open');
            ui.sidebarOverlay.classList.toggle('hidden', !isOpen);
        }
        function toggleDesktopSidebar() {
            ui.appContainer.classList.toggle('sidebar-collapsed');
        }

        ui.sidebarToggleMobile.addEventListener('click', toggleMobileSidebar);
        ui.sidebarToggleDesktop.addEventListener('click', toggleDesktopSidebar);
        ui.sidebarOverlay.addEventListener('click', toggleMobileSidebar);

        // Theme toggle
        const themeToggleBtn = document.getElementById('theme-toggle');
        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', toggleTheme);
        }

        ui.fileUpload.addEventListener('change', handleFileUpload);
        ui.searchInput.addEventListener('input', (e) => {
            state.filters.search = e.target.value.toLowerCase();
            applyFiltersAndRender();
        });
        ui.lowHtpToggle.addEventListener('change', (e) => {
            state.filters.lowHtp = e.target.checked;
            applyFiltersAndRender();
        });
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                state.filters.process = e.currentTarget.id.replace('filter-', '');
                applyFiltersAndRender();
            });
        });
        ui.captureBtn.addEventListener('click', captureTable);
        ui.exportBtn.addEventListener('click', exportToExcel);
        ui.tableHeader.addEventListener('click', (e) => {
            const headerCell = e.target.closest('.sortable');
            if (!headerCell) return;
            const sortKey = headerCell.dataset.sortKey;
            if (state.sort.key === sortKey) {
                if (state.sort.direction === 'asc') state.sort.direction = 'desc';
                else if (state.sort.direction === 'desc') { state.sort.key = 'htp'; state.sort.direction = 'asc'; }
            } else {
                state.sort.key = sortKey;
                state.sort.direction = 'asc';
            }
            applyFiltersAndRender();
        });

        ui.tableViewBtn.addEventListener('click', () => {
            ui.tableView.classList.remove('hidden');
            ui.dashboardView.classList.add('hidden');
            ui.tableViewBtn.classList.add('active');
            ui.dashboardViewBtn.classList.remove('active');
        });
        ui.dashboardViewBtn.addEventListener('click', () => {
            ui.tableView.classList.add('hidden');
            ui.dashboardView.classList.remove('hidden');
            ui.dashboardView.classList.add('flex');
            ui.tableViewBtn.classList.remove('active');
            ui.dashboardViewBtn.classList.add('active');
        });

        ui.tableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row || row.id === 'placeholder-row') return;
            const employeeCell = row.querySelector('td:nth-child(2)');
            const processCell = row.querySelector('td:nth-child(1)');
            if(employeeCell && processCell) {
                const employeeName = employeeCell.textContent.replace(/[👑]\s*/g, '');
                const processType = processCell.textContent;
                showIndividualTrend(employeeName, processType);
            }
        });
        ui.chartModalClose.addEventListener('click', () => {
            ui.chartModalBackdrop.classList.add('hidden');
            ui.chartModalBackdrop.classList.remove('flex');
        });
        ui.chartModalBackdrop.addEventListener('click', (e) => {
            if (e.target === ui.chartModalBackdrop) {
                ui.chartModalBackdrop.classList.add('hidden');
                ui.chartModalBackdrop.classList.remove('flex');
            }
        });

        // --- Helper Functions ---
        function getPackType(location, processTask, processPathName) {
            if (processTask === 'PACK(PACKING)' && processPathName.includes('AGV_Multi_Autobag4.0') && location.startsWith('Pack at Rebin (Test')) return "오토백 멀티";
            if (typeof location !== 'string') return DEFAULT_PACK_TYPE;
            for (const [name, prefix] of Object.entries(PACK_TYPE_MAP)) {
                if (location.startsWith(prefix)) return name;
            }
            return DEFAULT_PACK_TYPE;
        }

        function getTargetHtp(item) {
            if (item.processType.includes('PICK')) return targetHtpValues['PICK'] || 0;
            if (item.processType.includes('PACK')) {
                const processPathName = item.processPathName || "";
                for (const name in TARGET_HTP_DEFAULTS) {
                    if (name === "PICK") continue;
                    const config = TARGET_HTP_DEFAULTS[name];
                    if (config.keywords.some(keyword => processPathName.includes(keyword))) return targetHtpValues[name] || 0;
                }
                return targetHtpValues["Manual SINGULATION"] || 0;
            }
            return 0;
        }

        function parseExcelData(data) {
            if (data.length < 2) return [];
            const headers = data[0].map(h => h ? h.toString().toLowerCase().trim() : '');
            const COLS_TO_LOAD = {
                workDate: 'work date', employee: 'employee', unitQty: 'unit qty', location: 'location', floor: 'floor',
                processPathName: 'process path name', htpStart: 'htp start', htpEnd: 'htp end', processTask: 'process(task)',
                contractType: 'contract type'
            };
            const colIndices = {};
            const missingCols = [];
            for (const key in COLS_TO_LOAD) {
                const index = headers.indexOf(COLS_TO_LOAD[key]);
                if (index === -1 && key !== 'contractType') missingCols.push(COLS_TO_LOAD[key]);
                colIndices[key] = index;
            }
            if (missingCols.length > 0) throw new Error(`엑셀 파일에 다음 필수 컬럼이 없습니다:\n[${missingCols.join(', ')}]`);

            const rawData = data.slice(1).map(row => {
                const combineDateTime = (dateValue, timeValue) => {
                    if (!dateValue || !timeValue) return null;
                    let datePart = (typeof dateValue === 'number') ? new Date(Date.UTC(1899, 11, 30) + dateValue * 24 * 60 * 60 * 1000) : new Date(dateValue);
                    if (isNaN(datePart.getTime())) return null;
                    let timePart;
                    if (typeof timeValue === 'number') timePart = new Date(Date.UTC(1899, 11, 30) + timeValue * 24 * 60 * 60 * 1000);
                    else if (typeof timeValue === 'string') {
                        const parts = timeValue.split(':');
                        timePart = new Date(0);
                        timePart.setUTCHours(parts[0] || 0, parts[1] || 0, parts[2] || 0, 0);
                    } else timePart = timeValue;
                    if (isNaN(timePart.getTime())) return null;
                    return new Date(Date.UTC(datePart.getUTCFullYear(), datePart.getUTCMonth(), datePart.getUTCDate(), timePart.getUTCHours(), timePart.getUTCMinutes(), timePart.getUTCSeconds()));
                };
                const htpStart = combineDateTime(row[colIndices.workDate], row[colIndices.htpStart]);
                const htpEnd = combineDateTime(row[colIndices.workDate], row[colIndices.htpEnd]);
                if (!htpStart || !htpEnd) return null;
                const durationSeconds = (htpEnd - htpStart) / 1000;
                if (durationSeconds <= 0) return null;
                let processTask = row[colIndices.processTask] || '';
                const location = row[colIndices.location] || '';
                const processPathName = row[colIndices.processPathName] || '';
                if (processTask === 'REBIN(REBIN)' && location.startsWith('Pack at Rebin (Test') && processPathName === '0. AGV_Multi_Autobag4.0 + 일반존 통합') processTask = 'PACK(PACKING)';
                return {
                    employee: row[colIndices.employee] || '', unitQty: parseInt(row[colIndices.unitQty] || 0),
                    location: location, floor: row[colIndices.floor] || '',
                    processPathName: processPathName, processTask: processTask,
                    contractType: colIndices.contractType !== -1 ? (row[colIndices.contractType] || '').toUpperCase() : '',
                    htpStart: htpStart, htpEnd: htpEnd
                };
            }).filter(item => {
                if (!item || !item.employee || item.unitQty <= 0) return false;
                if (item.employee === 'AGV_Agent') return false;
                return item.processTask === 'PICK(PICKING)' || item.processTask === 'PACK(PACKING)';
            });
            return rawData;
        }

        function aggregateData(rawData) {
            const aggregatedMap = new Map();
            rawData.forEach(item => {
                let key, packType = null;
                if (item.processTask === 'PICK(PICKING)') {
                    key = `${item.employee}|${item.floor}|PICK`;
                    packType = '집품';
                } else {
                    packType = getPackType(item.location, item.processTask, item.processPathName);
                    key = `${item.employee}|${packType}|PACK`;
                }
                const durationSeconds = (item.htpEnd - item.htpStart) / 1000;
                if (durationSeconds <= 0) return;
                if (!aggregatedMap.has(key)) {
                    const empIdMatch = item.employee.match(/\((.*?)\)/);
                    const empId = empIdMatch ? empIdMatch[1] : '';
                    aggregatedMap.set(key, {
                        processType: item.processTask.includes('PICK') ? 'PICK(집품)' : 'PACK(포장)',
                        employee: item.employee, floor: item.floor, unitQty: 0, totalSeconds: 0,
                        location: item.location, processPathName: item.processPathName, packType: packType,
                        isManager: MANAGERS_LIST.includes(empId), isPerm: item.contractType === 'PERM'
                    });
                }
                const group = aggregatedMap.get(key);
                group.unitQty += item.unitQty;
                group.totalSeconds += durationSeconds;
                group.location = item.location;
                group.processPathName = item.processPathName;
                group.floor = item.floor;
            });
            const finalData = [];
            for (const group of aggregatedMap.values()) {
                const mh = group.totalSeconds > 0 ? group.totalSeconds / 3600 : 0;
                finalData.push({ ...group, mh: mh.toFixed(4), htp: (mh > 0 ? group.unitQty / mh : 0).toFixed(1) });
            }
            return finalData;
        }
		
		function initializeFiltersFromData(rawData) {
            const allPackTypes = new Set();
            const floors = new Set();
            rawData.forEach(item => {
                if(item.processTask.includes('PICK')) {
                    if(item.floor) floors.add(item.floor);
                } else if (item.processTask.includes('PACK')) {
                    allPackTypes.add(getPackType(item.location, item.processTask, item.processPathName));
                }
            });
            createFilterCheckboxes(ui.packTypeFilters, Array.from(allPackTypes).sort(), 'packTypes', 'packtypes');
            createFilterCheckboxes(ui.floorFilters, Array.from(floors).sort(), 'floors', 'floors');
            createTimeFilters();
            createTargetHtpSettings();
        }

        function createTimeFilters() {
            const allHoursCheckbox = document.getElementById('all-hours-checkbox');
            ui.hourFilters.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const hour = i.toString().padStart(2, '0');
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-sm cursor-pointer';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.value = i;
                checkbox.className = 'form-checkbox hour-checkbox';
                checkbox.addEventListener('change', (e) => {
                    const hourVal = parseInt(e.target.value);
                    if (e.target.checked) {
                        state.filters.hours.add(hourVal);
                        allHoursCheckbox.checked = false;
                    } else {
                        state.filters.hours.delete(hourVal);
                    }
                    if (state.filters.hours.size === 0) allHoursCheckbox.checked = true;
                    applyFiltersAndRender();
                });
                label.appendChild(checkbox);
                const text = document.createElement('span');
                text.textContent = hour;
                label.appendChild(text);
                ui.hourFilters.appendChild(label);
            }
            allHoursCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.querySelectorAll('.hour-checkbox').forEach(cb => cb.checked = false);
                    state.filters.hours.clear();
                    applyFiltersAndRender();
                }
            });
            document.getElementById('select-all-hours').addEventListener('click', () => {
                allHoursCheckbox.checked = false;
                document.querySelectorAll('.hour-checkbox').forEach(cb => {
                    cb.checked = true;
                    state.filters.hours.add(parseInt(cb.value));
                });
                applyFiltersAndRender();
            });
            document.getElementById('deselect-all-hours').addEventListener('click', () => {
                allHoursCheckbox.checked = true;
                document.querySelectorAll('.hour-checkbox').forEach(cb => cb.checked = false);
                state.filters.hours.clear();
                applyFiltersAndRender();
            });
        }

        function createFilterCheckboxes(container, items, filterType, type) {
            container.innerHTML = '';
            items.forEach(item => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-sm cursor-pointer';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.value = item;
                checkbox.className = `form-checkbox ${type}-checkbox`;
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) state.filters[filterType].add(item);
                    else state.filters[filterType].delete(item);
                    applyFiltersAndRender();
                });
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${item}`));
                container.appendChild(label);
            });
            const selectAllBtn = document.getElementById(`select-all-${type}`);
            const deselectAllBtn = document.getElementById(`deselect-all-${type}`);
            if (selectAllBtn && deselectAllBtn) {
                selectAllBtn.onclick = () => {
                    container.querySelectorAll('input').forEach(cb => { cb.checked = true; state.filters[filterType].add(cb.value); });
                    applyFiltersAndRender();
                };
                deselectAllBtn.onclick = () => {
                    container.querySelectorAll('input').forEach(cb => { cb.checked = false; state.filters[filterType].delete(cb.value); });
                    applyFiltersAndRender();
                };
            }
        }

        function createTargetHtpSettings() {
            ui.targetHtpSettings.innerHTML = '';
            for (const key in TARGET_HTP_DEFAULTS) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between';
                const label = document.createElement('label');
                label.textContent = key + ':';
                const input = document.createElement('input');
                input.type = 'number';
                input.value = targetHtpValues[key];
                input.className = 'w-20 rounded-md py-1 px-2 text-sm text-right';
                input.addEventListener('change', (e) => {
                    targetHtpValues[key] = parseFloat(e.target.value) || 0;
                    applyFiltersAndRender();
                });
                div.appendChild(label);
                div.appendChild(input);
                ui.targetHtpSettings.appendChild(div);
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showLoader();
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    const parsedData = parseExcelData(jsonData);
                    await saveDataToFirestore(parsedData);
                } catch (error) {
                    console.error("파일 처리 오류:", error);
                    showModal(error.message || "파일을 처리하는 중 오류가 발생했습니다.");
                    hideLoader();
                }
            };
            reader.onerror = (error) => { console.error("파일 읽기 오류:", error); showModal("파일을 읽을 수 없습니다."); hideLoader(); };
            reader.readAsArrayBuffer(file);
        }

        async function saveDataToFirestore(data) {
            try {
                const serializableData = data.map(item => ({ ...item, htpStart: item.htpStart.toISOString(), htpEnd: item.htpEnd.toISOString() }));
                const jsonString = JSON.stringify(serializableData);
                const compressedData = pako.gzip(jsonString);
                const compressedBytes = Bytes.fromUint8Array(compressedData);
                const payload = { compressedData: compressedBytes, uploaderId: userId, timestamp: new Date().toISOString() };
                await setDoc(dataDocRef, payload);
            } catch (error) {
                console.error("Firestore 저장 오류:", error);
                showModal("데이터를 서버에 저장하는 데 실패했습니다.");
                hideLoader();
            }
        }

        function applyFiltersAndRender() {
            if (globalRawData.length === 0) {
                renderTable([]);
                updateDashboard([], []);
                return;
            }
            let timeFilteredRawData = [...globalRawData];
            if (state.filters.hours.size > 0) {
                timeFilteredRawData = timeFilteredRawData.filter(item => state.filters.hours.has(item.htpStart.getUTCHours()));
            }
            let aggregatedData = aggregateData(timeFilteredRawData);
            let displayFilteredData = aggregatedData;
            if (state.filters.process === 'pick') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PICK(집품)');
            else if (state.filters.process === 'pack') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PACK(포장)');
            if (state.filters.search) displayFilteredData = displayFilteredData.filter(item => item.employee.toLowerCase().includes(state.filters.search));
            if (state.filters.lowHtp) displayFilteredData = displayFilteredData.filter(item => parseFloat(item.htp) < getTargetHtp(item));
            let finalDisplayData = displayFilteredData;
            if (state.filters.floors.size > 0 && state.filters.packTypes.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => 
                    (item.processType.includes('PICK') && state.filters.floors.has(item.floor)) ||
                    (item.processType.includes('PACK') && state.filters.packTypes.has(item.packType))
                );
            } else if (state.filters.floors.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => item.processType.includes('PICK') && state.filters.floors.has(item.floor));
            } else if (state.filters.packTypes.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => item.processType.includes('PACK') && state.filters.packTypes.has(item.packType));
            }
            if (state.sort.key && state.sort.direction) {
                const numericKeys = ['unitQty', 'mh', 'htp'];
                finalDisplayData.sort((a, b) => {
                    const key = state.sort.key;
                    const valA = a[key], valB = b[key];
                    let compareResult;
                    if (numericKeys.includes(key)) compareResult = parseFloat(valA) - parseFloat(valB);
                    else compareResult = (valA || '').toString().localeCompare((valB || '').toString());
                    return state.sort.direction === 'asc' ? compareResult : -compareResult;
                });
            }
            renderTable(finalDisplayData);
            updateDashboard(finalDisplayData, timeFilteredRawData);
            updateColumnVisibility(finalDisplayData);
            updateStats(finalDisplayData);
            updateTicker(finalDisplayData);
            updateSortIndicators();
        }
		
		function renderTable(data) {
            ui.tableBody.innerHTML = '';
            if (data.length === 0) {
                ui.tableBody.appendChild(ui.placeholderRow);
                ui.placeholderRow.classList.remove('hidden');
                updateStats([]);
                updateTicker([]);
                return;
            }
            ui.placeholderRow.classList.add('hidden');

            // TOP10 계산
            const pickData = data.filter(d => d.processType.includes('PICK')).sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            const packData = data.filter(d => d.processType.includes('PACK')).sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            
            const topPickSet = new Set(pickData.slice(0, 3).map(d => d.employee));
            const topPackSet = new Set(packData.slice(0, 3).map(d => d.employee));
            const lowPickSet = new Set(pickData.slice(-3).map(d => d.employee));
            const lowPackSet = new Set(packData.slice(-3).map(d => d.employee));

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-gray-700';
                
                let processTypeColor = item.processType.includes('PICK') ? 'text-blue-400' : 'text-yellow-400';
                const targetHtp = getTargetHtp(item);
                let htpColor = parseFloat(item.htp) < targetHtp ? 'text-red-400' : 'text-green-400';
                
                let empDisplay = item.employee;
                let empColor = 'text-gray-200';

                if (item.isManager) {
                    empDisplay = `👑 ${item.employee}`;
                    empColor = 'text-yellow-300 font-bold';
                } else if (item.isPerm) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    empColor = isDark ? 'text-lime-400' : 'text-green-600 font-semibold';
                }

                // 뱃지 추가
                let badge = '';
                if (item.processType.includes('PICK')) {
                    if (topPickSet.has(item.employee)) badge = ' 🔥';
                    else if (lowPickSet.has(item.employee)) badge = ' 🐢';
                } else {
                    if (topPackSet.has(item.employee)) badge = ' 🔥';
                    else if (lowPackSet.has(item.employee)) badge = ' 🐢';
                }
                
                empDisplay += badge;

                row.innerHTML = `
                    <td class="px-4 py-3 font-medium ${processTypeColor}">${item.processType}</td>
                    <td class="px-4 py-3 ${empColor}">${empDisplay}</td>
                    <td class="px-4 py-3 text-gray-200">${item.unitQty}</td>
                    <td class="px-4 py-3 text-gray-200">${item.location || '-'}</td>
                    <td class="px-4 py-3 text-gray-200">${item.processPathName || '-'}</td>
                    <td class="px-4 py-3 text-gray-200">${item.packType}</td>
                    <td class="px-4 py-3 text-gray-200">${item.mh}</td>
                    <td class="px-4 py-3 font-bold ${htpColor}">${parseFloat(item.htp) < targetHtp && targetHtp > 0 ? '🚨 ' : ''}${item.htp}</td>
                `;
                ui.tableBody.appendChild(row);
            });
        }

        function updateColumnVisibility(data) {
            const locationColHeader = ui.tableHeader.querySelector('th[data-sort-key="location"]');
            if (!locationColHeader) return;
            const locationColIndex = Array.from(locationColHeader.parentNode.children).indexOf(locationColHeader);
            const isLocationEmpty = data.length > 0 && data.every(item => !item.location);
            document.querySelectorAll(`#data-table th:nth-child(${locationColIndex + 1}), #data-table td:nth-child(${locationColIndex + 1})`)
                .forEach(cell => cell.classList.toggle('hidden-col', isLocationEmpty));
        }

        function updateSortIndicators() {
            ui.tableHeader.querySelectorAll('.sortable').forEach(th => {
                const indicator = th.querySelector('.sort-indicator');
                const key = th.dataset.sortKey;
                indicator.classList.remove('asc', 'desc');
                indicator.textContent = '';
                if (key === state.sort.key && state.sort.direction) {
                    indicator.classList.add(state.sort.direction);
                    indicator.textContent = state.sort.direction === 'asc' ? '▲' : '▼';
                }
            });
        }

        function updateStats(data) {
            const visibleRows = data.length;
            const visibleWorkers = new Set(data.map(d => d.employee)).size;
            const totalQty = data.reduce((sum, d) => sum + d.unitQty, 0);
            const totalMh = data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const avgHtp = totalMh > 0 ? (totalQty / totalMh).toFixed(2) : '0.00';
            ui.statsDisplay.innerHTML = `
                표시 그룹: <span class="font-bold text-white">${visibleRows}</span> | 
                작업자 수: <span class="font-bold text-white">${visibleWorkers}</span> | 
                총 작업량: <span class="font-bold text-white">${totalQty.toLocaleString()}</span> | 
                평균 HTP: <span class="font-bold text-white">${avgHtp}</span>`;
        }

        function updateTicker(data) {
            if (data.length === 0) {
                ui.tickerText.textContent = "Top/Low HTP 정보가 여기에 표시됩니다.";
                return;
            }
            const sortedByHtp = [...data].sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            const top3 = sortedByHtp.slice(0, 3);
            const low3 = sortedByHtp.filter(d => d.htp > 0).slice(-3).reverse();
            const formatTickerItem = (item) => `${item.employee.split('(')[0].trim()} (${item.htp})`;
            const topStr = "🏆Top3: " + (top3.length > 0 ? top3.map(formatTickerItem).join(', ') : '-');
            const lowStr = "🚨Low3: " + (low3.length > 0 ? low3.map(formatTickerItem).join(', ') : '-');
            ui.tickerText.textContent = `${topStr}        ${lowStr}`;
        }

        function captureTable() {
            const tableEl = document.getElementById('data-table');
            showModal('캡처 중...', 1500);
            html2canvas(tableEl).then(canvas => {
                canvas.toBlob(blob => {
                    try {
                        navigator.clipboard.write([new ClipboardItem({'image/png': blob})])
                            .then(() => showModal('테이블이 클립보드에 복사되었습니다.'))
                            .catch(err => {
                                console.error('클립보드 복사 실패:', err);
                                showModal('클립보드 복사에 실패했습니다.');
                            });
                    } catch (error) {
                         console.error('클립보드 API 오류:', error);
                         showModal('클립보드 API를 사용할 수 없는 환경입니다.');
                    }
                });
            });
        }

        function exportToExcel() {
            if (globalRawData.length === 0) {
                showModal('내보낼 데이터가 없습니다.');
                return;
            }
            let timeFilteredRawData = [...globalRawData];
            if (state.filters.hours.size > 0) {
                timeFilteredRawData = timeFilteredRawData.filter(item => state.filters.hours.has(item.htpStart.getUTCHours()));
            }
            let aggregatedData = aggregateData(timeFilteredRawData);
            let displayFilteredData = aggregatedData;
            if (state.filters.process === 'pick') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PICK(집품)');
            else if (state.filters.process === 'pack') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PACK(포장)');
            if (state.filters.search) displayFilteredData = displayFilteredData.filter(item => item.employee.toLowerCase().includes(state.filters.search));
            if (state.filters.lowHtp) displayFilteredData = displayFilteredData.filter(item => parseFloat(item.htp) < getTargetHtp(item));
            let dataToExport = displayFilteredData;
            if (state.filters.floors.size > 0 && state.filters.packTypes.size > 0) {
                 dataToExport = displayFilteredData.filter(item => 
                    (item.processType.includes('PICK') && state.filters.floors.has(item.floor)) ||
                    (item.processType.includes('PACK') && state.filters.packTypes.has(item.packType))
                );
            } else if (state.filters.floors.size > 0) {
                dataToExport = displayFilteredData.filter(item => item.processType.includes('PICK') && state.filters.floors.has(item.floor));
            } else if (state.filters.packTypes.size > 0) {
                dataToExport = displayFilteredData.filter(item => item.processType.includes('PACK') && state.filters.packTypes.has(item.packType));
            }
            if (dataToExport.length === 0) {
                showModal('내보낼 데이터가 없습니다.');
                return;
            }
            const pickData = [], packData = [];
            dataToExport.forEach(item => {
                const rowData = {
                    '집품/포장': item.processType,
                    '이름(원바코드)': item.employee.replace(/[👑]\s*/g, ''),
                    '계약직 여부': item.isPerm ? 'PERM' : 'TEMP',
                    '작업량': Number(item.unitQty),
                    '로케이션 및 작업대': item.location || '-',
                    'PP': item.processPathName || '-',
                    '팩 종류': item.packType,
                    'M/H': parseFloat(item.mh),
                    'HTP': parseFloat(item.htp.replace('🚨 ', ''))
                };
                if (rowData['집품/포장'].includes('PICK')) pickData.push(rowData);
                else packData.push(rowData);
            });
            pickData.sort((a, b) => a.HTP - b.HTP);
            packData.sort((a, b) => a.HTP - b.HTP);
            const wb = XLSX.utils.book_new();
            const createStyledSheet = (data, sheetName) => {
                if (!data || data.length === 0) return;
                const headers = Object.keys(data[0]);
                const ws = XLSX.utils.json_to_sheet(data, { header: headers });
                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4F81BD" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
                };
                const cellStyle = {
                    alignment: { horizontal: "center", vertical: "center" },
                    border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
                };
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const headerAddr = XLSX.utils.encode_cell({ c: C, r: 0 });
                    if (ws[headerAddr]) ws[headerAddr].s = headerStyle;
                    for (let R = 1; R <= range.e.r; ++R) {
                        const cellAddr = XLSX.utils.encode_cell({ c: C, r: R });
                        if (ws[cellAddr]) {
                            if (!ws[cellAddr].s) ws[cellAddr].s = {};
                            Object.assign(ws[cellAddr].s, cellStyle);
                            if (typeof ws[cellAddr].v === 'number') {
                                if (headers[C] === 'M/H') ws[cellAddr].z = '0.0000';
                                else if (headers[C] === 'HTP') ws[cellAddr].z = '0.0';
                                else if (headers[C] === '작업량') ws[cellAddr].z = '0';
                            }
                        }
                    }
                }
                const colWidths = headers.map((header, i) => {
                    const maxLength = Math.max(header.length, ...data.map(row => (row[header] ? row[header].toString().length : 0)));
                    return { wch: maxLength + 2 };
                });
                ws['!cols'] = colWidths;
                ws['!autofilter'] = { ref: ws['!ref'] };
                ws['!freeze'] = { ySplit: 1 };
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            };
            createStyledSheet(pickData, "PICK(집품)");
            createStyledSheet(packData, "PACK(포장)");
            if (wb.SheetNames.length > 0) XLSX.writeFile(wb, "HTP_Data_Export_Styled.xlsx");
            else showModal('내보낼 데이터가 없습니다.');
        }
		
		function updateStatus(status, message) {
            const dot = ui.statusIndicator.querySelector('.status-dot');
            const text = ui.statusIndicator.querySelector('span');
            dot.className = 'status-dot';
            if (status === 'connected') dot.classList.add('status-connected');
            else if (status === 'disconnected') dot.classList.add('status-disconnected');
            else if (status === 'loading') dot.classList.add('status-loading');
            text.textContent = message;
        }

        function showLoader() { ui.loaderContainer.classList.remove('hidden'); ui.tableView.classList.add('hidden'); }
        function hideLoader() { ui.loaderContainer.classList.add('hidden'); ui.tableView.classList.remove('hidden'); }
        
        function showModal(message, duration = 3000) {
            const modal = document.createElement('div');
            modal.className = 'fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-fade-in-out';
            modal.textContent = message;
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fade-in-out {
                    0% { opacity: 0; transform: translateY(-20px); }
                    10% { opacity: 1; transform: translateY(0); }
                    90% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-20px); }
                }
                .animate-fade-in-out { animation: fade-in-out ${duration / 1000}s ease-in-out forwards; }
            `;
            document.head.appendChild(style);
            document.body.appendChild(modal);
            setTimeout(() => { modal.remove(); style.remove(); }, duration);
        }

        // --- Chart Functions ---
        Chart.register(ChartDataLabels);

        function updateDashboard(filteredAggregatedData, timeFilteredRawData) {
            updateKpiCards(filteredAggregatedData);
            updatePerformersLists(filteredAggregatedData);
            updateFloorHtpChart(filteredAggregatedData);
            updatePackTypeChart(filteredAggregatedData);
            updateProcessComparisonChart(filteredAggregatedData);
            updateHourlyTrendChart(timeFilteredRawData);
        }

        function generateColors(numColors) {
            const colors = ['rgba(59, 130, 246, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(99, 102, 241, 0.7)'];
            const result = [];
            for (let i = 0; i < numColors; i++) result.push(colors[i % colors.length]);
            return result;
        }

        function updateKpiCards(data) {
            const totalWorkers = new Set(data.map(d => d.employee)).size;
            const totalQty = data.reduce((sum, d) => sum + d.unitQty, 0);
            const totalMh = data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
            const lowPerformers = data.filter(d => parseFloat(d.htp) < getTargetHtp(d)).length;
            ui.kpi.totalWorkers.textContent = totalWorkers.toLocaleString();
            ui.kpi.totalQty.textContent = totalQty.toLocaleString();
            ui.kpi.avgHtp.textContent = avgHtp.toFixed(1);
            ui.kpi.lowPerformers.textContent = lowPerformers.toLocaleString();
        }

        function updatePerformersLists(data) {
            ui.topPickPerformersList.innerHTML = '';
            ui.topPackPerformersList.innerHTML = '';
            if (data.length === 0) {
                ui.topPickPerformersList.innerHTML = '<li class="text-gray-500">데이터 없음</li>';
                ui.topPackPerformersList.innerHTML = '<li class="text-gray-500">데이터 없음</li>';
                return;
            }
            const pickData = data.filter(d => d.processType.includes('PICK'));
            const packData = data.filter(d => d.processType.includes('PACK'));
            pickData.sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            packData.sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            const top5Pick = pickData.slice(0, 5);
            const top5Pack = packData.slice(0, 5);
            const createListItem = (item) => `<li class="flex justify-between items-center bg-gray-700 p-2 rounded-md"><span>${item.employee.split('(')[0].trim()}</span><span class="font-bold text-green-400">${item.htp}</span></li>`;
            if (top5Pick.length > 0) top5Pick.forEach(item => ui.topPickPerformersList.innerHTML += createListItem(item));
            else ui.topPickPerformersList.innerHTML = '<li class="text-gray-500">데이터 없음</li>';
            if (top5Pack.length > 0) top5Pack.forEach(item => ui.topPackPerformersList.innerHTML += createListItem(item));
            else ui.topPackPerformersList.innerHTML = '<li class="text-gray-500">데이터 없음</li>';
        }

        function updateFloorHtpChart(data) {
            const pickData = data.filter(d => d.processType.includes('PICK'));
            const floorData = new Map();
            pickData.forEach(item => {
                if (!floorData.has(item.floor)) floorData.set(item.floor, { totalQty: 0, totalMh: 0 });
                const floor = floorData.get(item.floor);
                floor.totalQty += item.unitQty;
                floor.totalMh += parseFloat(item.mh);
            });
            const sortedFloors = Array.from(floorData.keys()).sort();
            const labels = sortedFloors;
            const avgHtps = sortedFloors.map(floor => {
                 const d = floorData.get(floor);
                 const weightedAvgHtp = d.totalMh > 0 ? (d.totalQty / d.totalMh) : 0;
                 return weightedAvgHtp.toFixed(1);
            });
            const ctx = document.getElementById('floor-htp-chart').getContext('2d');
            if (state.charts.floorHtp) state.charts.floorHtp.destroy();
            state.charts.floorHtp = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: '평균 HTP', data: avgHtps, backgroundColor: generateColors(labels.length), borderColor: '#4b5563', borderWidth: 1 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } },
                    plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', color: '#FFFFFF', font: { weight: 'bold' }, formatter: (value) => value > 0 ? value : '' } }
                }
            });
        }

        function updatePackTypeChart(data) {
            const packData = data.filter(d => d.processType.includes('PACK'));
            let packTypeData = new Map(), totalQuantity = 0;
            packData.forEach(item => {
                if (!packTypeData.has(item.packType)) packTypeData.set(item.packType, 0);
                const currentQty = packTypeData.get(item.packType);
                packTypeData.set(item.packType, currentQty + item.unitQty);
                totalQuantity += item.unitQty;
            });
            const otherThreshold = 0.02;
            let otherQuantity = 0;
            const finalPackData = new Map();
            packTypeData.forEach((qty, type) => {
                if (totalQuantity > 0 && (qty / totalQuantity) < otherThreshold) otherQuantity += qty;
                else finalPackData.set(type, qty);
            });
            if (otherQuantity > 0) finalPackData.set('기타', (finalPackData.get('기타') || 0) + otherQuantity);
            const labels = Array.from(finalPackData.keys());
            const quantities = Array.from(finalPackData.values());
            const ctx = document.getElementById('pack-type-chart').getContext('2d');
            if (state.charts.packType) state.charts.packType.destroy();
            state.charts.packType = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ label: '작업량', data: quantities, backgroundColor: generateColors(labels.length), borderColor: '#374151', borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#d1d5db' } },
                        datalabels: { color: '#FFFFFF', textAlign: 'center', font: { weight: 'bold' }, formatter: (value, context) => {
                            const percentage = totalQuantity > 0 ? (value / totalQuantity * 100).toFixed(1) : 0;
                            const label = context.chart.data.labels[context.dataIndex];
                            if (parseFloat(percentage) < 5) return '';
                            return `${label}\n${percentage}%`;
                        }}
                    }
                }
            });
        }

        function updateProcessComparisonChart(data) {
            const processStats = { PICK: { totalQty: 0, totalMh: 0 }, PACK: { totalQty: 0, totalMh: 0 } };
            data.forEach(item => {
                const type = item.processType.includes('PICK') ? 'PICK' : 'PACK';
                processStats[type].totalQty += item.unitQty;
                processStats[type].totalMh += parseFloat(item.mh);
            });
            const pickHtp = processStats.PICK.totalMh > 0 ? (processStats.PICK.totalQty / processStats.PICK.totalMh) : 0;
            const packHtp = processStats.PACK.totalMh > 0 ? (processStats.PACK.totalQty / processStats.PACK.totalMh) : 0;
            const ctx = document.getElementById('process-comparison-chart').getContext('2d');
            if (state.charts.processComparison) state.charts.processComparison.destroy();
            state.charts.processComparison = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['PICK(집품)', 'PACK(포장)'], datasets: [{ label: '총 작업량', data: [processStats.PICK.totalQty, processStats.PACK.totalQty], backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)'], borderColor: '#374151', borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#d1d5db' } },
                        datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (value, context) => {
                            const label = context.chart.data.labels[context.dataIndex];
                            const htp = label.includes('PICK') ? pickHtp : packHtp;
                            return `${value.toLocaleString()}\n(Avg ${htp.toFixed(0)} HTP)`;
                        }}
                    }
                }
            });
        }
		
		function updateHourlyTrendChart(rawData) {
             const hourlyData = new Map();
             for(let i=0; i<24; i++) hourlyData.set(i, { unitQty: 0, totalSeconds: 0 });
             rawData.forEach(item => {
                const hour = item.htpStart.getUTCHours();
                const stats = hourlyData.get(hour);
                if(stats){
                    stats.unitQty += item.unitQty;
                    stats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
                }
             });
            const sortedHours = Array.from(hourlyData.keys()).sort((a, b) => a - b);
            const labels = sortedHours.map(hour => `${hour.toString().padStart(2, '0')}:00`);
            const htpValues = sortedHours.map(hour => {
                const stats = hourlyData.get(hour);
                if (!stats || stats.totalSeconds <= 0) return 0;
                const mh = stats.totalSeconds / 3600;
                return (stats.unitQty / mh).toFixed(1);
            });
            const ctx = document.getElementById('hourly-htp-chart').getContext('2d');
            if (state.charts.hourlyHtp) state.charts.hourlyHtp.destroy();
            state.charts.hourlyHtp = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: '시간별 평균 HTP', data: htpValues, fill: true, backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)', tension: 0.3 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false, ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db', maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } } },
                    plugins: { legend: { display: false }, datalabels: { display: false } }
                }
            });
        }

        function showIndividualTrend(employeeName, processType) {
		// 모든 이모지 제거 (왕관, 불, 거북이 등)
            employeeName = employeeName.replace(/[👑🔥🐢]\s*/g, '').trim();
            const targetProcessTask = processType.includes('PICK') ? 'PICK(PICKING)' : 'PACK(PACKING)';
            const employeeData = globalRawData.filter(d => d.employee === employeeName && d.processTask === targetProcessTask);
            
            if (employeeData.length === 0) {
                showModal(`${employeeName.split('(')[0]} 님의 해당 공정 데이터가 없습니다.`);
                return;
            }

            const hourlyData = new Map();
            employeeData.forEach(item => {
                const hour = item.htpStart.getUTCHours();
                if (!hourlyData.has(hour)) hourlyData.set(hour, { unitQty: 0, totalSeconds: 0 });
                const hourStats = hourlyData.get(hour);
                hourStats.unitQty += item.unitQty;
                hourStats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
            });

            const sortedHours = Array.from(hourlyData.keys()).sort((a, b) => a - b);
            const labels = sortedHours.map(hour => `${hour}시`);
            const htpValues = sortedHours.map(hour => {
                const stats = hourlyData.get(hour);
                const mh = stats.totalSeconds / 3600;
                return mh > 0 ? (stats.unitQty / mh).toFixed(1) : 0;
            });

            // 통계 계산
            const totalQty = employeeData.reduce((sum, item) => sum + item.unitQty, 0);
            const totalSeconds = employeeData.reduce((sum, item) => sum + (item.htpEnd - item.htpStart) / 1000, 0);
            const totalMh = totalSeconds / 3600;
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
            const maxHtp = Math.max(...htpValues.map(v => parseFloat(v)));
            const minHtp = Math.min(...htpValues.filter(v => v > 0).map(v => parseFloat(v)));
            const maxHour = sortedHours[htpValues.indexOf(maxHtp.toString())];
            
            // 시간대별 순위 계산
            const hourlyRanks = sortedHours.map(hour => {
                const stats = hourlyData.get(hour);
                const mh = stats.totalSeconds / 3600;
                const employeeHtp = mh > 0 ? stats.unitQty / mh : 0;
                
                // 같은 시간대의 모든 작업자 HTP 계산
                const sameHourData = globalRawData.filter(d => 
                    d.processTask === targetProcessTask && 
                    d.htpStart.getUTCHours() === hour
                );
                
                const employeeHtps = new Map();
                sameHourData.forEach(item => {
                    if (!employeeHtps.has(item.employee)) {
                        employeeHtps.set(item.employee, { unitQty: 0, totalSeconds: 0 });
                    }
                    const empStats = employeeHtps.get(item.employee);
                    empStats.unitQty += item.unitQty;
                    empStats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
                });
                
                const htpList = Array.from(employeeHtps.values())
                    .map(s => s.totalSeconds > 0 ? s.unitQty / (s.totalSeconds / 3600) : 0)
                    .sort((a, b) => b - a);
                
                const rank = htpList.findIndex(h => h <= employeeHtp) + 1;
                const total = htpList.length;
                
                return { hour, rank, total };
            });

            // 모달 HTML 구성
            ui.chartModalTitle.textContent = `${employeeName} 님의 상세 분석 (${processType.split('(')[0]})`;
            const modalContent = document.getElementById('chart-modal-content');
            modalContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4" style="color: var(--text-primary);">${employeeName} 님의 상세 분석 (${processType.split('(')[0]})</h3>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <!-- 통계 요약 카드 -->
                    <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">
                        <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">📊 오늘의 성과 요약</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">평균 HTP</div>
                                <div style="color: var(--text-primary); font-size: 20px; font-weight: 700;">${avgHtp.toFixed(1)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">최고 HTP</div>
                                <div style="color: #4ade80; font-size: 20px; font-weight: 700;">${maxHtp.toFixed(1)}</div>
                                <div style="color: var(--text-tertiary); font-size: 10px;">${maxHour}시</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">최저 HTP</div>
                                <div style="color: #f87171; font-size: 20px; font-weight: 700;">${minHtp > 0 ? minHtp.toFixed(1) : '-'}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">총 작업량</div>
                                <div style="color: var(--text-primary); font-size: 18px; font-weight: 700;">${totalQty.toLocaleString()}</div>
                                <div style="color: var(--text-tertiary); font-size: 10px;">Unit</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">총 작업시간</div>
                                <div style="color: var(--text-primary); font-size: 18px; font-weight: 700;">${totalMh.toFixed(1)}</div>
                                <div style="color: var(--text-tertiary); font-size: 10px;">시간</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 11px;">목표 대비</div>
                                <div style="color: ${avgHtp >= getTargetHtp({processType: processType}) ? '#4ade80' : '#f87171'}; font-size: 18px; font-weight: 700;">
                                    ${((avgHtp / getTargetHtp({processType: processType}) - 1) * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 시간대별 순위 -->
                    <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; max-height: 180px; overflow-y: auto;">
                        <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">🏆 시간대별 순위</h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${hourlyRanks.map(r => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--bg-secondary); border-radius: 6px;">
                                    <span style="color: var(--text-primary); font-weight: 600; font-size: 13px;">${r.hour}시</span>
                                    <span style="color: ${r.rank <= 3 ? '#fbbf24' : r.rank <= r.total / 2 ? '#4ade80' : '#94a3b8'}; font-weight: 700; font-size: 13px;">
                                        ${r.rank}위 / ${r.total}명 ${r.rank === 1 ? '👑' : r.rank <= 3 ? '⭐' : ''}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- 차트 -->
                <div class="flex-grow" style="min-height: 300px;">
                    <canvas id="individual-htp-chart"></canvas>
                </div>
            `;

            const ctx = document.getElementById('individual-htp-chart').getContext('2d');
            if (state.charts.individualHtp) state.charts.individualHtp.destroy();
            state.charts.individualHtp = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: '시간별 HTP', data: htpValues, fill: false, borderColor: 'rgb(75, 192, 192)', tension: 0.1 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } },
                    plugins: { legend: { labels: { color: '#d1d5db' } }, datalabels: { align: 'top', color: '#FFFFFF' } }
                }
            });

            ui.chartModalBackdrop.classList.remove('hidden');
            ui.chartModalBackdrop.classList.add('flex');
        }

        // Initialize on page load
        initializeFiltersFromData([]);

    </script>
</body>
</html>