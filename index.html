<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GWJ2 CFC OB PICK & PACK HTP TOOL_Bennett (v3.1)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/qogmlwo000/gwj2pickpackhtp/main/Bennett.ico" type="image/x-icon">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="CFC PICK & PACK HTP TOOL_Bennett">
    <meta property="og:description" content="ÏóëÏÖÄ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏó¨ Ïã§ÏãúÍ∞ÑÏúºÎ°ú HTP Îç∞Ïù¥ÌÑ∞Î•º Í≥µÏú†ÌïòÍ≥† Î∂ÑÏÑùÌïòÏÑ∏Ïöî.">
    <meta property="og:image" content="https://github.com/qogmlwo000/gwj2pickpackhtp/blob/main/Bennett.png?raw=true">
    <meta property="og:url" content="https://qogmlwo000.github.io/gwj2pickpackhtp/">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --transition-speed: 0s;
        }
        
        /* Light Mode Colors */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-hover: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #06b6d4;
        }

        /* Dark Mode Colors */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-hover: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* ÌïÑÏöîÌïú ÏöîÏÜåÎßå transition Ï†ÅÏö© */
        body,
        #sidebar,
        #main-content,
        .card,
        button,
        input,
        .filter-btn,
        .view-tab,
        .kpi-card,
        label {
            transition: background-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease;
        }

        /* Forms - Ï≤¥ÌÅ¨Î∞ïÏä§ Ïä§ÌÉÄÏùº */
        .form-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.1rem;
            height: 1.1rem;
            border: 2px solid #94a3b8;
            border-radius: 4px;
            background-color: #f1f5f9;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            flex-shrink: 0;
        }
        
        [data-theme="dark"] .form-checkbox {
            background-color: #0f172a;
            border: 2px solid #60a5fa;
        }
        
        .form-checkbox:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }
        
        .form-checkbox:checked {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-color: var(--accent-primary);
        }
        
        .form-checkbox:checked::after {
            content: '‚úî';
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
        }
        
        .form-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            scrollbar-width: thin;
        }

        /* Badge System Styles */
        .badge-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .employee-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s ease;
            cursor: help;
            position: relative;
        }
        
        .employee-badge:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .employee-badge.legendary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            color: white;
            animation: shimmer 2s infinite;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }
        
        .employee-badge.gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
        }
        
        .employee-badge.silver {
            background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%);
            color: #1f2937;
        }
        
        .employee-badge.bronze {
            background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            color: white;
        }
        
        .employee-badge.normal {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
        }
        
        .employee-badge.warning {
            background: linear-gradient(135deg, #fca5a5 0%, #ef4444 100%);
            color: white;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .badge-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            margin-bottom: 5px;
            z-index: 1000;
        }
        
        .employee-badge:hover .badge-tooltip {
            opacity: 1;
        }
        
        .badge-icon {
            font-size: 14px;
            line-height: 1;
        }

        
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 5px; border: 2px solid var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; background-color: var(--bg-primary); }
        
        #sidebar {
            width: 300px;
            transition: margin-left var(--transition-speed) ease-in-out, transform var(--transition-speed) ease-in-out;
            position: fixed; top: 0; left: 0; height: 100%; z-index: 40;
            transform: translateX(-100%);
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }
        #sidebar.open { transform: translateX(0); }
        #main-content { transition: margin-left var(--transition-speed) ease-in-out; width: 100%; background-color: var(--bg-primary); }

        @media (min-width: 1024px) {
            #sidebar { position: static; transform: translateX(0); }
            #main-content { flex: 1; min-width: 0; }
            .app-container.sidebar-collapsed #sidebar { margin-left: -300px; }
            #sidebar-toggle-desktop { display: block; }
            #sidebar-toggle-mobile { display: none; }
        }
        @media (max-width: 1023px) {
            #sidebar-toggle-desktop { display: none; }
            #sidebar-toggle-mobile { display: block; }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: relative; width: 60px; height: 30px;
            background: var(--bg-tertiary); border-radius: 30px;
            cursor: pointer; display: flex; align-items: center; padding: 3px;
            border: 2px solid var(--border-color);
        }
        .theme-toggle-slider {
            width: 22px; height: 22px;
            background: var(--accent-primary); border-radius: 50%;
            transition: transform var(--transition-speed) ease;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-md);
        }
        [data-theme="dark"] .theme-toggle-slider { transform: translateX(30px); }

        /* Status & Loader */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 8px currentColor; }
        .status-connected { background-color: var(--success); animation: pulse-success 2s infinite; }
        .status-disconnected { background-color: var(--error); }
        .status-loading { background-color: var(--warning); animation: pulse-warning 1.5s infinite; }
        @keyframes pulse-success { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes pulse-warning { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Buttons & Filters */
        .filter-btn { background-color: var(--bg-tertiary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.2s ease; }
        .filter-btn:hover { background-color: var(--bg-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .filter-btn.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .filter-group-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; }

        button { background-color: var(--bg-tertiary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 8px; padding: 8px 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        button:hover { background-color: var(--bg-hover); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        button:active { transform: translateY(0); }
        .bg-blue-600 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important; color: white !important; border-color: #3b82f6 !important; }
        .bg-blue-600:hover { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important; }

        /* Cards & Views */
        .card { background-color: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); transition: all 0.3s ease; }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .view-tab { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 2px solid var(--border-color); transition: all 0.2s ease; font-weight: 600; }
        .view-tab:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .view-tab.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        /* Title & Ticker */
        /* üéØ Enhanced Ticker Design */
        #ticker-container { 
            overflow: hidden; 
            position: relative; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px; 
            border: 2px solid transparent;
            background-clip: padding-box;
            padding: 12px 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        [data-theme="light"] #ticker-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        #ticker-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #3b82f6);
            border-radius: 12px;
            z-index: -1;
            animation: border-flow 3s linear infinite;
            background-size: 200% 100%;
        }
        
        @keyframes border-flow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        #ticker-text-wrapper {
            display: flex;
            align-items: center;
            gap: 24px;
            overflow: hidden;
        }
        
        #ticker-text { 
            display: flex;
            align-items: center;
            gap: 24px;
            animation: ticker-scroll 60s linear infinite;
            font-weight: 700;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .ticker-section {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .ticker-section.top {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .ticker-section.low {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* PICK/PACK Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .ticker-section.pick {
            border-left: 3px solid #60a5fa;
        }
        
        .ticker-section.pack {
            border-left: 3px solid #fbbf24;
        }
        
        .ticker-section.pick .ticker-label::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #60a5fa;
            border-radius: 50%;
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(96, 165, 250, 0.6);
        }
        
        .ticker-section.pack .ticker-label::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #fbbf24;
            border-radius: 50%;
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.6);
        }
        
        [data-theme="light"] .ticker-section.top {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
        }
        
        [data-theme="light"] .ticker-section.low {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
        }
        
        .ticker-label {
            font-weight: 800;
            font-size: 13px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .ticker-section.top .ticker-label {
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ticker-section.low .ticker-label {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        [data-theme="light"] .ticker-item {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .ticker-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .ticker-name {
            font-weight: 600;
            color: #e2e8f0;
        }
        
        [data-theme="light"] .ticker-name {
            color: #1e293b;
        }
        
        .ticker-htp {
            font-weight: 700;
            font-size: 14px;
        }
        
        .ticker-section.top .ticker-htp {
            color: #10b981;
        }
        
        .ticker-section.low .ticker-htp {
            color: #ef4444;
        }
        
        .ticker-rank {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 700;
        }
        
        .ticker-rank.rank-1 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #78350f;
            box-shadow: 0 0 12px rgba(251, 191, 36, 0.6);
        }
        
        .ticker-rank.rank-2 {
            background: linear-gradient(135deg, #e5e7eb, #9ca3af);
            color: #1f2937;
        }
        
        .ticker-rank.rank-3 {
            background: linear-gradient(135deg, #fb923c, #f97316);
            color: white;
        }
        
        @keyframes ticker-scroll { 
            0% { transform: translateX(100%); } 
            100% { transform: translateX(-100%); } 
        }
        
        #ticker-text:hover {
            animation-play-state: paused;
        }

        /* Table */
        .table-container { flex-grow: 1; overflow: auto; -webkit-overflow-scrolling: touch; background-color: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); }
        #data-table { background-color: var(--bg-secondary); }
        #data-table thead { background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-hover) 100%); backdrop-filter: blur(10px); }
        #data-table th { color: var(--text-primary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid var(--border-color); white-space: nowrap; padding: 16px; }
        #data-table td { border-right: 1px solid var(--border-color); white-space: nowrap; padding: 12px 16px; color: var(--text-secondary); }
        #data-table th:last-child, #data-table td:last-child { border-right: none; }
        #data-table tbody tr { background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
        #data-table tbody tr:hover { background-color: var(--bg-hover); box-shadow: var(--shadow-sm); }
        .sortable { cursor: pointer; position: relative; user-select: none; }
        .sort-indicator { display: inline-block; width: 1em; height: 1em; margin-left: 4px; vertical-align: middle; opacity: 0.4; transition: opacity 0.2s, color 0.2s; }
        .sortable:hover .sort-indicator { opacity: 0.8; }
        .sort-indicator.asc, .sort-indicator.desc { opacity: 1; color: var(--accent-primary); font-weight: bold; }
        .hidden-col { display: none; }
		
		/* üÜï Enhanced Hidden Employee Styles */
        #data-table tbody tr.hidden-employee { 
            opacity: 0.2; 
            background: repeating-linear-gradient(
                45deg,
                var(--bg-secondary),
                var(--bg-secondary) 10px,
                var(--bg-tertiary) 10px,
                var(--bg-tertiary) 20px
            );
            filter: grayscale(0.8);
        }
        #data-table tbody tr.hidden-employee:hover {
            opacity: 0.4;
        }

        /* Forms */
        input[type="text"], input[type="number"], input[type="date"] { background-color: var(--bg-tertiary); border: 2px solid var(--border-color); color: var(--text-primary); transition: all 0.2s ease; }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); background-color: var(--bg-secondary); }
        input[type="text"]::placeholder { color: var(--text-tertiary); }

        /* Dashboard */
        .kpi-card { background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border-left: 4px solid var(--accent-primary); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .kpi-card h4 { color: var(--text-tertiary); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-card p { color: var(--text-primary); font-size: 2rem; font-weight: 800; margin-top: 0.5rem; }

        /* Modals */
        #chart-modal-backdrop, #history-modal-backdrop, #employee-detail-modal-backdrop, #ranking-modal-backdrop { background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); }
        #chart-modal-content, #history-modal-content, #employee-detail-modal-content, #ranking-modal-content { max-height: 85vh; background-color: var(--bg-secondary); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); overflow-y: auto; }
        #sidebar-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
		
		/* Text Colors */
        .text-gray-200, .text-white { color: var(--text-primary) !important; }
        .text-gray-300 { color: var(--text-secondary) !important; }
        .text-gray-400, .text-gray-500 { color: var(--text-tertiary) !important; }
        .text-blue-400 { color: #60a5fa !important; }
        .text-yellow-400 { color: #fbbf24 !important; }
        .text-red-400 { color: #f87171 !important; }
        .text-green-400 { color: #4ade80 !important; }
        .text-purple-400 { color: #c084fc !important; }
        .text-yellow-300 { color: #fcd34d !important; }
        .text-yellow-600 { color: #ca8a04 !important; }
        .text-emerald-400 { color: #34d399 !important; }
        .text-emerald-600 { color: #059669 !important; }
        .text-gray-700 { color: #374151 !important; }
        .text-lime-400 { color: #a3e635 !important; }
        
        [data-theme="light"] .text-lime-400 {
            color: #16a34a !important;
            font-weight: 600;
        }
        
        [data-theme="light"] .text-yellow-300 {
            color: #d97706 !important;
        }
        
        [data-theme="light"] .text-yellow-600 {
            color: #ca8a04 !important;
        }
        
        [data-theme="light"] .text-emerald-400 {
            color: #10b981 !important;
        }
        
        [data-theme="light"] .text-emerald-600 {
            color: #059669 !important;
        }
        
        [data-theme="light"] .text-gray-700 {
            color: #374151 !important;
        }
        
        [data-theme="light"] .text-purple-400 {
            color: #9333ea !important;
        }

        /* Utility */
        .bg-gray-800, .bg-gray-700 { background-color: var(--bg-secondary) !important; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        .bg-gray-700 { background-color: var(--bg-tertiary) !important; }
        label { color: var(--text-secondary); transition: color 0.2s ease; }
        label:hover { color: var(--text-primary); }
        .rounded-lg { border-radius: 12px !important; }
        .rounded-md { border-radius: 8px !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { animation: fadeIn 0.3s ease-out; }

        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 8px;
            animation: badge-pulse 2s infinite;
        }
        .badge-gold { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #78350f; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .badge-silver { background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); color: #374151; }
        .badge-bronze { background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); color: #7c2d12; }
        .badge-streak { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .badge-record { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        @keyframes badge-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
		
		/* üÜï Warning/Danger Badge Styles */
        .badge-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: #78350f; 
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        .badge-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .badge-info { 
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); 
            color: white; 
        }
        
        /* üèÖ Enhanced Badge System Styles */
        .badge-legendary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            color: white;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
            animation: shimmer-badge 2s infinite;
            font-weight: 800;
            border: 2px solid #fbbf24;
        }
        
        .badge-gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            box-shadow: 0 0 12px rgba(251, 191, 36, 0.6);
            font-weight: 700;
        }
        
        .badge-silver {
            background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%);
            color: #1f2937;
            box-shadow: 0 0 8px rgba(156, 163, 175, 0.4);
            font-weight: 700;
        }
        
        .badge-bronze {
            background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            color: white;
            box-shadow: 0 0 8px rgba(251, 146, 60, 0.5);
            font-weight: 700;
        }
        
        .badge-normal {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
            font-weight: 600;
        }
        
        .badge-warning {
            background: linear-gradient(135deg, #fca5a5 0%, #ef4444 100%);
            color: white;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
            font-weight: 700;
        }
        
        @keyframes shimmer-badge {
            0%, 100% { 
                opacity: 1; 
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
            }
            50% { 
                opacity: 0.9; 
                box-shadow: 0 0 30px rgba(251, 191, 36, 1);
            }
        }
		
		/* üÜï Row Action Menu (Hover) */
        .row-action-menu {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.2s ease;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 6px 10px;
            box-shadow: var(--shadow-lg);
            z-index: 10;
            border: 2px solid var(--border-color);
        }
        tr:hover .row-action-menu {
            opacity: 1;
        }
        .action-menu-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 12px;
            font-size: 1.3rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-menu-btn:hover {
            color: var(--text-primary);
            transform: scale(1.2);
        }

        /* History View Styles */
        .period-selector { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .period-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.875rem; cursor: pointer; }
        .period-btn.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; }
        
        .history-chart-container { background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); margin-bottom: 20px; }
        
        .date-range-picker { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
        .date-range-picker input { padding: 8px 12px; border-radius: 8px; font-size: 0.875rem; }

        /* üÜï Calendar View Styles */
        .calendar-container { background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; background-color: var(--bg-tertiary); border: 2px solid var(--border-color); cursor: pointer; }
        .calendar-nav-btn:hover { background-color: var(--bg-hover); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day-header { text-align: center; font-weight: 700; color: var(--text-secondary); padding: 12px; font-size: 0.875rem; }
        .calendar-day {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 80px;
            position: relative;
        }
        .calendar-day:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .calendar-day.inactive { opacity: 0.3; cursor: default; }
        .calendar-day.inactive:hover { transform: none; box-shadow: none; }
        .calendar-day.today { border-color: var(--accent-primary); border-width: 3px; }
        .calendar-day-number { font-weight: 700; font-size: 1rem; color: var(--text-primary); }
        .calendar-day-htp { font-size: 0.75rem; font-weight: 600; margin-top: 4px; }
        .calendar-day.excellent { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%); }
        .calendar-day.good { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.2) 100%); }
        .calendar-day.average { background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(217, 119, 6, 0.2) 100%); }
        .calendar-day.poor { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%); }
        .calendar-day.no-data { background-color: var(--bg-tertiary); }
        .calendar-legend { display: flex; gap: 16px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .calendar-legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; }
        .calendar-legend-color { width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--border-color); }

        /* üÜï Ranking/Leaderboard Styles */
        .ranking-card { background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); margin-bottom: 16px; }
        .ranking-podium { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; align-items: end; }
        .podium-item { text-align: center; padding: 20px; border-radius: 12px; transition: all 0.3s ease; cursor: pointer; }
        .podium-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .podium-first { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); order: 2; padding-top: 40px; }
        .podium-second { background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); order: 1; }
        .podium-third { background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); order: 3; }
        .podium-rank { font-size: 3rem; margin-bottom: 8px; }
        .podium-name { font-weight: 700; font-size: 1.1rem; color: var(--text-primary); margin-bottom: 4px; }
        .podium-score { font-weight: 600; font-size: 1.5rem; color: var(--text-primary); }
        .ranking-list { display: flex; flex-direction: column; gap: 8px; }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background-color: var(--bg-tertiary); border-radius: 8px; border: 2px solid var(--border-color); transition: all 0.2s ease; cursor: pointer; }
        .ranking-item:hover { background-color: var(--bg-hover); transform: translateX(4px); }
        .ranking-item.highlight-user { border-color: var(--accent-primary); background-color: rgba(59, 130, 246, 0.1); }
        .ranking-position { font-weight: 700; font-size: 1.2rem; color: var(--text-secondary); min-width: 40px; }
        .ranking-employee { font-weight: 600; flex-grow: 1; color: var(--text-primary); }
        .ranking-htp { font-weight: 700; font-size: 1.1rem; color: var(--success); }
        .ranking-change { font-size: 0.875rem; font-weight: 600; margin-left: 8px; }
        .ranking-change.up { color: var(--success); }
        .ranking-change.down { color: var(--error); }
        .ranking-change.same { color: var(--text-tertiary); }
        .ranking-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .ranking-tab { flex: 1; padding: 12px; border-radius: 8px; font-weight: 600; text-align: center; cursor: pointer; background-color: var(--bg-tertiary); border: 2px solid var(--border-color); transition: all 0.2s ease; }
        .ranking-tab:hover { background-color: var(--bg-hover); }
        .ranking-tab.active { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border-color: var(--accent-primary); }

        /* üÜï Employee Detail Modal Styles */
        .employee-detail-header { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0; margin: -24px -24px 24px -24px; }
        .employee-detail-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .employee-stat-card { background-color: var(--bg-tertiary); padding: 16px; border-radius: 8px; border: 1px solid var(--border-color); }
        .employee-stat-label { font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; font-weight: 600; }
        .employee-stat-value { font-size: 1.8rem; font-weight: 800; color: var(--text-primary); margin-top: 4px; }
        .employee-chart-container { background-color: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 16px; }
        .trend-indicator { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; }
        .trend-indicator.positive { background-color: rgba(16, 185, 129, 0.2); color: var(--success); }
        .trend-indicator.negative { background-color: rgba(239, 68, 68, 0.2); color: var(--error); }
        .trend-indicator.neutral { background-color: var(--bg-tertiary); color: var(--text-tertiary); }

        /* üÜï Hidden Employee Styles */
        .hidden-employee-indicator { 
            position: absolute; 
            right: 8px; 
            top: 50%; 
            transform: translateY(-50%);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.3) 100%);
            color: var(--error);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            border: 1px solid rgba(239, 68, 68, 0.5);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
            animation: pulse-hidden 2s infinite;
        }
        
        @keyframes pulse-hidden {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .hide-employee-btn {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .hide-employee-btn:hover {
            background-color: var(--error);
            color: white;
        }
        .show-employee-btn {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .show-employee-btn:hover {
            background-color: var(--success);
            color: white;
        }
        .hidden-employees-panel {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-top: 12px;
        }
        .hidden-employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 8px;
        }
		
		/* üÜï Enhanced Header Styles */
        .header-gradient {
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.2) 0%, 
				rgba(139, 92, 246, 0.2) 50%, 
				rgba(236, 72, 153, 0.2) 100%
            );
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899) 1;
            position: relative;
            overflow: hidden;
        }
        
        .header-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent
            );
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .header-toggle-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }
        
        .header-toggle-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: rotate(90deg);
            color: white;
        }
        
        .logo-icon {
            font-size: 3rem;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .header-title {
            font-size: 1.75rem;
            font-weight: 900;
            letter-spacing: -0.5px;
            line-height: 1.2;
            margin: 0;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 5s ease infinite;
            background-size: 200% 200%;
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 12px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 4px 16px rgba(16, 185, 129, 0.6); }
        }
        
        .header-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .status-pulse {
            color: #10b981;
            animation: pulse-dot 1.5s ease-in-out infinite;
            font-size: 1.2rem;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .status-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-tertiary);
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }
        
        .status-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 700;
        }
		
		/* üÜï Employee Analysis Card Styles */
        .employee-analysis-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .employee-analysis-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        .employee-name-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .employee-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        .employee-stat-item {
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
        }
        .employee-stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }
        .employee-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .best-performance-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        .best-performance-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .best-performance-detail {
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.6;
        }
        .performance-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .performance-badge.pick {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        .performance-badge.pack {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        /* üÜï Loading Progress Bar */
        #loading-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            z-index: 9999;
            display: none;
        }
        #loading-progress-bar.active {
            display: block;
        }
        #loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            width: 0%;
            transition: width 0.3s ease;
        }
        #loading-status-text {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            padding: 8px 20px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            display: none;
        }
        #loading-status-text.active {
            display: block;
        }

        /* üé® ÎùºÏù¥Ìä∏ Î™®Îìú ÏÇ¨Ïù¥ÎìúÎ∞î Ïä§ÌÉÄÏùº */
        [data-theme="light"] #sidebar {
            background: linear-gradient(to bottom, #f0f9ff, #e0f2fe) !important;
            border-right: 2px solid #3b82f6 !important;
        }

        [data-theme="light"] #sidebar h2 {
            background: linear-gradient(to right, #2563eb, #7c3aed) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            color: transparent !important;
        }

        /* Ïà®Í∏¥ ÏûëÏóÖÏûê - ÎùºÏù¥Ìä∏ Î™®Îìú */
        [data-theme="light"] #sidebar > div:nth-child(2) {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb) !important;
            border: 1px solid #d1d5db !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(2) h3 {
            color: #1f2937 !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(2) button {
            background: linear-gradient(to right, #6b7280, #4b5563) !important;
        }

        [data-theme="light"] #hidden-count-badge {
            background: linear-gradient(to right, #ef4444, #ec4899) !important;
        }

        /* ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌïÑÌÑ∞ - ÎùºÏù¥Ìä∏ Î™®Îìú (ÌååÎûë) */
        [data-theme="light"] #sidebar > div:nth-child(3) {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;
            border: 1px solid #60a5fa !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(3) h3 {
            color: #1e3a8a !important;
        }

        [data-theme="light"] #select-day-shift {
            background: linear-gradient(to right, #fbbf24, #f59e0b) !important;
        }

        [data-theme="light"] #select-swing-shift {
            background: linear-gradient(to right, #8b5cf6, #7c3aed) !important;
        }

        [data-theme="light"] #all-hours-checkbox {
            background-color: rgba(59, 130, 246, 0.1) !important;
        }

        [data-theme="light"] .hour-filter-btn {
            background-color: #e5e7eb !important;
            border-color: #9ca3af !important;
            color: #4b5563 !important;
        }

        [data-theme="light"] .hour-filter-btn.bg-blue-500 {
            background-color: #3b82f6 !important;
            border-color: #2563eb !important;
            color: white !important;
        }

        /* Ï∏µÎ≥Ñ ÌïÑÌÑ∞ - ÎùºÏù¥Ìä∏ Î™®Îìú (Ï¥àÎ°ù) */
        [data-theme="light"] #sidebar > div:nth-child(4) {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0) !important;
            border: 1px solid #34d399 !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(4) h3 {
            color: #065f46 !important;
        }

        /* Ìå© Ï¢ÖÎ•ò ÌïÑÌÑ∞ - ÎùºÏù¥Ìä∏ Î™®Îìú (Ï£ºÌô©) */
        [data-theme="light"] #sidebar > div:nth-child(5) {
            background: linear-gradient(135deg, #fed7aa, #fdba74) !important;
            border: 1px solid #fb923c !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(5) h3 {
            color: #7c2d12 !important;
        }

        /* Target HTP - ÎùºÏù¥Ìä∏ Î™®Îìú (Î≥¥Îùº) */
        [data-theme="light"] #sidebar > div:nth-child(6) {
            background: linear-gradient(135deg, #e9d5ff, #d8b4fe) !important;
            border: 1px solid #a855f7 !important;
        }

        [data-theme="light"] #sidebar > div:nth-child(6) h3 {
            color: #581c87 !important;
        }

        /* Ï≤¥ÌÅ¨Î∞ïÏä§ ÎùºÎ≤® - ÎùºÏù¥Ìä∏ Î™®Îìú */
        [data-theme="light"] #sidebar label {
            background-color: rgba(255, 255, 255, 0.6) !important;
        }

        [data-theme="light"] #sidebar label:hover {
            background-color: rgba(255, 255, 255, 0.9) !important;
        }

        [data-theme="light"] #sidebar label span {
            color: #1f2937 !important;
        }

        /* Î≤ÑÌäº - ÎùºÏù¥Ìä∏ Î™®Îìú */
        [data-theme="light"] #select-all-hours,
        [data-theme="light"] #select-all-floors,
        [data-theme="light"] #select-all-packtypes {
            background: linear-gradient(to right, #10b981, #059669) !important;
        }

        [data-theme="light"] #deselect-all-hours,
        [data-theme="light"] #deselect-all-floors,
        [data-theme="light"] #deselect-all-packtypes {
            background: linear-gradient(to right, #ef4444, #dc2626) !important;
        }

        /* Ï≤¥ÌÅ¨Î∞ïÏä§ - ÎùºÏù¥Ìä∏ Î™®Îìú */
        [data-theme="light"] .form-checkbox {
            border-color: #9ca3af !important;
            background-color: white !important;
        }

        [data-theme="light"] .form-checkbox:checked {
            background-color: #3b82f6 !important;
            border-color: #2563eb !important;
        }

        /* üéØ Î±ÉÏßÄ Ìà¥ÌåÅ Ïä§ÌÉÄÏùº */
        .cursor-help {
            cursor: help;
        }

        /* Ìà¥ÌåÅÏù¥ Ïûò Î≥¥Ïù¥ÎèÑÎ°ù Ï∂îÍ∞Ä Ïä§ÌÉÄÏùº */
        [title] {
            position: relative;
        }
		
		/* üÜï History Top Performers Enhanced Styles */
        .top-performer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }

        .top-performer-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .top-performer-item:hover::before {
            left: 100%;
        }

        .top-performer-item:hover {
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        /* ü•á 1ÏúÑ Ïä§ÌÉÄÏùº */
        .top-performer-item.rank-1 {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border-color: #fbbf24;
            animation: pulse-gold 2s infinite;
        }

        .top-performer-item.rank-1 .performer-name {
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .top-performer-item.rank-1 .performer-htp {
            color: #fbbf24;
            font-weight: 800;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
            animation: glow-gold 1.5s infinite alternate;
        }

        .top-performer-item.rank-1 .medal-icon {
            font-size: 2rem;
            animation: rotate-medal 3s infinite;
        }

        @keyframes pulse-gold {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
            }
            50% { 
                box-shadow: 0 0 40px rgba(251, 191, 36, 0.8);
            }
        }

        @keyframes glow-gold {
            from { text-shadow: 0 0 10px rgba(251, 191, 36, 0.6); }
            to { text-shadow: 0 0 20px rgba(251, 191, 36, 1); }
        }

        @keyframes rotate-medal {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-15deg) scale(1.1); }
            75% { transform: rotate(15deg) scale(1.1); }
        }

        /* ü•à 2ÏúÑ Ïä§ÌÉÄÏùº */
        .top-performer-item.rank-2 {
            background: linear-gradient(135deg, rgba(229, 231, 235, 0.2) 0%, rgba(156, 163, 175, 0.2) 100%);
            border-color: #9ca3af;
            animation: pulse-silver 2s infinite;
        }

        .top-performer-item.rank-2 .performer-name {
            background: linear-gradient(135deg, #f3f4f6, #9ca3af, #6b7280);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .top-performer-item.rank-2 .performer-htp {
            color: #d1d5db;
            font-weight: 700;
            animation: glow-silver 1.5s infinite alternate;
        }

        .top-performer-item.rank-2 .medal-icon {
            font-size: 1.8rem;
            animation: bounce-medal 2s infinite;
        }

        @keyframes pulse-silver {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(156, 163, 175, 0.3);
            }
            50% { 
                box-shadow: 0 0 30px rgba(156, 163, 175, 0.6);
            }
        }

        @keyframes glow-silver {
            from { text-shadow: 0 0 8px rgba(209, 213, 219, 0.5); }
            to { text-shadow: 0 0 16px rgba(209, 213, 219, 0.9); }
        }

        @keyframes bounce-medal {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* ü•â 3ÏúÑ Ïä§ÌÉÄÏùº */
        .top-performer-item.rank-3 {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.2) 0%, rgba(249, 115, 22, 0.2) 100%);
            border-color: #fb923c;
            animation: pulse-bronze 2s infinite;
        }

        .top-performer-item.rank-3 .performer-name {
            background: linear-gradient(135deg, #fb923c, #f97316, #ea580c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .top-performer-item.rank-3 .performer-htp {
            color: #fb923c;
            font-weight: 700;
            animation: glow-bronze 1.5s infinite alternate;
        }

        .top-performer-item.rank-3 .medal-icon {
            font-size: 1.6rem;
            animation: swing-medal 2s infinite;
        }

        @keyframes pulse-bronze {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(251, 146, 60, 0.3);
            }
            50% { 
                box-shadow: 0 0 30px rgba(251, 146, 60, 0.6);
            }
        }

        @keyframes glow-bronze {
            from { text-shadow: 0 0 8px rgba(251, 146, 60, 0.5); }
            to { text-shadow: 0 0 16px rgba(251, 146, 60, 0.9); }
        }

        @keyframes swing-medal {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        /* 4-10ÏúÑ Ïä§ÌÉÄÏùº */
        .top-performer-item.rank-other {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-color: var(--border-color);
        }

        .top-performer-item.rank-other:hover {
            border-color: var(--accent-primary);
        }

        .top-performer-item.rank-other .performer-name {
            color: var(--text-primary);
            font-weight: 600;
        }

        .top-performer-item.rank-other .performer-htp {
            color: var(--success);
            font-weight: 600;
        }

        .top-performer-item.rank-other .rank-number {
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* Í≥µÌÜµ ÏöîÏÜå */
        .performer-name {
            font-size: 1rem;
            flex-grow: 1;
            margin-left: 12px;
        }

        .performer-htp {
            font-size: 1.1rem;
            min-width: 80px;
            text-align: right;
        }

        .medal-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
        }

        .rank-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            font-size: 1.1rem;
        }

        /* ÎùºÏù¥Ìä∏ Î™®Îìú Ï°∞Ï†ï */
        [data-theme="light"] .top-performer-item.rank-1 .performer-name {
            background: linear-gradient(135deg, #d97706, #b45309, #92400e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        [data-theme="light"] .top-performer-item.rank-2 .performer-name {
            background: linear-gradient(135deg, #4b5563, #374151, #1f2937);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        [data-theme="light"] .top-performer-item.rank-3 .performer-name {
            background: linear-gradient(135deg, #c2410c, #9a3412, #7c2d12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">

<!-- üÜï Loading Progress Bar -->
<div id="loading-progress-bar">
    <div id="loading-progress-fill"></div>
</div>
<div id="loading-status-text"></div>

<div id="app-container" class="app-container">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-gradient-to-b from-gray-800 to-gray-900 p-4 flex-shrink-0 flex flex-col space-y-4 overflow-y-auto border-r-2 border-purple-500">
        <div class="flex items-center justify-between pb-3 border-b-2 border-purple-500">
            <h2 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">‚öôÔ∏è ÌïÑÌÑ∞ Î∞è ÏÑ§Ï†ï</h2>
            <!-- Theme Toggle -->
            <div class="theme-toggle" id="theme-toggle">
                <div class="theme-toggle-slider">
                    <span id="theme-icon">üåô</span>
                </div>
            </div>
        </div>
        
        <!-- üÜï Hidden Employees Management -->
        <div class="bg-gradient-to-br from-gray-700 to-gray-800 p-4 rounded-xl shadow-lg border border-gray-600">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-white flex items-center gap-2">
                    <span class="text-2xl">üëª</span>
                    <span>Ïà®Í∏¥ ÏûëÏóÖÏûê</span>
                </h3>
                <span id="hidden-count-badge" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">0</span>
            </div>
            <button id="manage-hidden-btn" class="w-full py-2.5 px-4 text-sm font-bold rounded-lg bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-500 hover:to-gray-600 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                Í¥ÄÎ¶¨ÌïòÍ∏∞
            </button>
            <div id="hidden-employees-list" class="hidden-employees-panel hidden mt-3">
                <p class="text-sm text-gray-400 mb-2">Ïà®Í∏¥ ÏûëÏóÖÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
            </div>
        </div>

        <!-- Time Filters -->
        <div class="bg-gradient-to-br from-blue-900 to-purple-900 p-4 rounded-xl shadow-lg border border-blue-500">
            <h3 class="font-bold mb-3 text-white flex items-center gap-2">
                <span class="text-2xl">‚è∞</span>
                <span>ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌïÑÌÑ∞</span>
            </h3>
            
            <!-- DAY/SWING Îπ†Î•∏ ÏÑ†ÌÉù -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button id="select-day-shift" class="shift-quick-btn group relative overflow-hidden py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-white shadow-lg transform hover:scale-105">
                    <div class="relative z-10">
                        <div class="text-xl mb-1">‚òÄÔ∏è</div>
                        <div class="font-extrabold">DAY</div>
                        <div class="text-xs opacity-90">09-18Ïãú</div>
                    </div>
                    <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition-opacity"></div>
                </button>
                <button id="select-swing-shift" class="shift-quick-btn group relative overflow-hidden py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white shadow-lg transform hover:scale-105">
                    <div class="relative z-10">
                        <div class="text-xl mb-1">üåô</div>
                        <div class="font-extrabold">SWING</div>
                        <div class="text-xs opacity-90">19-08Ïãú</div>
                    </div>
                    <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition-opacity"></div>
                </button>
            </div>
            
            <div class="space-y-2">
                <label class="flex items-center gap-3 text-sm cursor-pointer bg-gray-800 bg-opacity-50 px-3 py-2 rounded-lg hover:bg-opacity-70 transition-all">
                    <input type="checkbox" id="all-hours-checkbox" class="form-checkbox w-5 h-5 rounded border-2 border-purple-400 text-purple-500 focus:ring-2 focus:ring-purple-400" checked>
                    <span class="font-bold text-white">Ï†ÑÏ≤¥ ÏãúÍ∞Ñ</span>
                </label>
                <div id="hour-filters" class="grid grid-cols-4 gap-1.5 pt-2"></div>
                <div class="flex gap-2 pt-3 border-t border-blue-400">
                    <button id="select-all-hours" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                        ‚úì Î™®Îëê
                    </button>
                    <button id="deselect-all-hours" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                        ‚úó Ìï¥Ï†ú
                    </button>
                </div>
            </div>
        </div>

        <!-- Floor Filters -->
        <div class="bg-gradient-to-br from-green-900 to-teal-900 p-4 rounded-xl shadow-lg border border-green-500">
            <h3 class="font-bold mb-3 text-white flex items-center gap-2">
                <span class="text-2xl">üì∂</span>
                <span>Ï∏µÎ≥Ñ ÌïÑÌÑ∞ (ÏßëÌíà)</span>
            </h3>
            <div id="floor-filters" class="space-y-1"></div>
            <div class="flex gap-2 pt-3 mt-2 border-t border-green-400">
                <button id="select-all-floors" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                    ‚úì Î™®Îëê
                </button>
                <button id="deselect-all-floors" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                    ‚úó Ìï¥Ï†ú
                </button>
            </div>
        </div>

        <!-- Pack Type Filters -->
        <div class="bg-gradient-to-br from-orange-900 to-red-900 p-4 rounded-xl shadow-lg border border-orange-500">
            <h3 class="font-bold mb-3 text-white flex items-center gap-2">
                <span class="text-2xl">üì¶</span>
                <span>Ìå© Ï¢ÖÎ•ò ÌïÑÌÑ∞ (Ìè¨Ïû•)</span>
            </h3>
            <div id="pack-type-filters" class="space-y-1"></div>
             <div class="flex gap-2 pt-3 mt-2 border-t border-orange-400">
                <button id="select-all-packtypes" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                    ‚úì Î™®Îëê
                </button>
                <button id="deselect-all-packtypes" class="flex-1 py-2 px-3 text-xs font-bold rounded-lg bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white shadow-md transition-all duration-200 transform hover:scale-105">
                    ‚úó Ìï¥Ï†ú
                </button>
            </div>
        </div>
        
        <!-- Target HTP Settings -->
        <div class="bg-gradient-to-br from-purple-900 to-pink-900 p-4 rounded-xl shadow-lg border border-purple-500">
            <h3 class="font-bold mb-3 text-white flex items-center gap-2">
                <span class="text-2xl">üéØ</span>
                <span>Target HTP ÏÑ§Ï†ï</span>
            </h3>
            <div id="target-htp-settings" class="space-y-1 text-sm"></div>
        </div>
    </aside>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>
	
	<!-- Main Content -->
    <main id="main-content" class="flex-1 flex flex-col">
        <div class="header-gradient shadow-lg p-6 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle-desktop" class="header-toggle-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <button id="sidebar-toggle-mobile" class="header-toggle-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="header-content">
                        <div class="flex items-center gap-3">
                            <div class="logo-icon">üöÄ</div>
                            <div>
                                <h1 class="header-title">
                                    <span class="gradient-text">GWJ2 CFC OB PICK & PACK</span>
                                    <span class="version-badge">v3.1</span>
                                </h1>
                                <p class="header-subtitle">
                                    <span class="status-pulse">‚óè</span>
                                    Ìïú Î™ÖÏù¥ ÏóëÏÖÄÏùÑ Ïò¨Î¶¨Î©¥ Î™®ÎëêÏóêÍ≤å Ïã§ÏãúÍ∞ÑÏúºÎ°ú Î∞òÏòÅÎê©ÎãàÎã§
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="status-indicator" class="status-card">
                    <div class="status-dot status-disconnected"></div>
                    <div>
                        <div class="status-label">Ïó∞Í≤∞ ÏÉÅÌÉú</div>
                        <div class="status-value">ÌôïÏù∏ Ï§ë...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 space-y-4 flex flex-col flex-shrink-0">
            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-800 p-3 rounded-lg flex items-center space-x-2">
                    <button id="filter-all" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md active">Ï†ÑÏ≤¥</button>
                    <button id="filter-pick" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md">üü¶ PICK</button>
                    <button id="filter-pack" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md">üü® PACK</button>
                </div>
                <div class="bg-gray-800 p-3 rounded-lg flex items-center">
                    <input type="text" id="search-input" placeholder="üîç Ïù¥Î¶Ñ(Ïø†ÏΩîÎìú) Í≤ÄÏÉâ..." class="w-full rounded-md py-2 px-3 text-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="bg-gray-800 p-3 rounded-lg flex items-center space-x-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="low-htp-toggle" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                        <span class="ml-3 text-sm font-medium">üö® Ï†ÄÏ°∞ÏûêÎßå Î≥¥Í∏∞</span>
                    </label>
                    <button id="capture-btn" class="py-2 px-3 text-sm font-semibold rounded-md">üì∑</button>
                    <button id="export-btn" class="py-2 px-3 text-sm font-semibold rounded-md">üìä</button>
                </div>
            </div>
            
            <!-- Ticker -->
            <div id="ticker-container">
                <div id="ticker-text-wrapper">
                    <div id="ticker-text">
                        <span class="ticker-loading" style="color: var(--text-secondary); font-size: 14px;">
                            üìä ÏóëÏÖÄ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÎ©¥ PICK/PACK TOP3/LOW3Í∞Ä ÌëúÏãúÎê©ÎãàÎã§
                        </span>
                    </div>
                </div>
            </div>

            <!-- Stats & Upload -->
            <div class="bg-gray-800 p-3 rounded-lg flex flex-col md:flex-row justify-between items-center text-sm">
                 <div id="stats-display" class="text-gray-300 mb-2 md:mb-0 text-center md:text-left">
                    ÌëúÏãú Í∑∏Î£π: <span class="font-bold text-white">-</span> | 
                    ÏûëÏóÖÏûê Ïàò: <span class="font-bold text-white">-</span> | 
                    Ï¥ù ÏûëÏóÖÎüâ: <span class="font-bold text-white">-</span> | 
                    ÌèâÍ∑† HTP: <span class="font-bold text-white">-</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p>ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: <span id="last-updated" class="font-semibold text-gray-200">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</span></p>
                        <p>ÏóÖÎ°úÎçî: <span id="last-uploader" class="font-semibold text-gray-200">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</span></p>
                    </div>
                    <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls">
                    <label for="file-upload" class="cursor-pointer py-2 px-4 rounded-lg border-0 text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700">ÏóëÏÖÄ ÏóÖÎ°úÎìú</label>
                </div>
            </div>
        </div>

        <!-- View Switcher (5Í∞ú Î©îÎâ¥) -->
        <div class="px-4 pt-2">
            <div class="bg-gray-800 p-1 rounded-lg flex space-x-1 overflow-x-auto">
                <button id="table-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md active whitespace-nowrap">üìã Îç∞Ïù¥ÌÑ∞</button>
                <button id="dashboard-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">üìä ÎåÄÏãúÎ≥¥Îìú</button>
                <button id="history-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">üìà ÌûàÏä§ÌÜ†Î¶¨</button>
                <button id="calendar-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">üìÖ Ï∫òÎ¶∞Îçî</button>
                <button id="ranking-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md whitespace-nowrap">üèÜ Îû≠ÌÇπ</button>
            </div>
        </div>
		
		<!-- Table View -->
        <div id="table-view" class="flex flex-col flex-grow min-h-0">
            <div id="loader-container" class="flex-1 flex justify-center items-center hidden"><div class="loader"></div></div>
            <div class="table-container px-4 pb-4">
                <table id="data-table" class="min-w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="processType">ÏßëÌíà/Ìè¨Ïû•<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="employee">Ïù¥Î¶Ñ(Ïø†ÏΩîÎìú)<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="unitQty">ÏûëÏóÖÎüâ<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="location">Î°úÏºÄÏù¥ÏÖò Î∞è ÏûëÏóÖÎåÄ<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="processPathName">PP<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="packType">Ìå© Ï¢ÖÎ•ò<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="mh">M/H<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="htp">HTP<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 text-center">Î≥¥Í∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-gray-800">
                        <tr id="placeholder-row"><td colspan="9" class="text-center py-10 text-gray-500">ÏóëÏÖÄ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏó¨ Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">Ï¥ù ÏûëÏóÖÏûê Ïàò</h4>
                    <p id="kpi-total-workers" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">Ï¥ù ÏûëÏóÖÎüâ (Unit)</h4>
                    <p id="kpi-total-qty" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">Ï†ÑÏ≤¥ ÌèâÍ∑† HTP</h4>
                    <p id="kpi-avg-htp" class="text-3xl font-bold text-white">0.0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow border-l-red-500">
                    <h4 class="text-gray-400 text-sm font-medium">Ï†ÄÏ°∞Ïûê Ïàò</h4>
                    <p id="kpi-low-performers" class="text-3xl font-bold text-red-400">0</p>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                <div class="bg-gray-800 p-4 rounded-lg xl:col-span-1">
                    <h3 class="text-lg font-semibold mb-2 text-white">ÌîÑÎ°úÏÑ∏Ïä§Î≥Ñ ÎπÑÍµê</h3>
                    <div class="relative h-64 md:h-80"><canvas id="process-comparison-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg xl:col-span-2">
                    <h3 class="text-lg font-semibold mb-2 text-white">ÏãúÍ∞ÑÎåÄÎ≥Ñ HTP Ìä∏Î†åÎìú</h3>
                    <div class="relative h-64 md:h-80"><canvas id="hourly-htp-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-white">Ï∏µÎ≥Ñ ÌèâÍ∑† HTP (ÏßëÌíà)</h3>
                    <div class="relative h-96"><canvas id="floor-htp-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-white">Ìå© Ï¢ÖÎ•òÎ≥Ñ ÏûëÏóÖÎüâ (Ìè¨Ïû•)</h3>
                    <div class="relative h-96"><canvas id="pack-type-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg lg:col-span-2 xl:col-span-1">
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 h-full">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-white">üèÜ Top 5 PICK</h3>
                            <ul id="top-pick-performers-list" class="space-y-2 text-sm"></ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-white">üèÜ Top 5 PACK</h3>
                            <ul id="top-pack-performers-list" class="space-y-2 text-sm"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History View -->
        <div id="history-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <!-- Period Selector -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-white">üìÖ Í∏∞Í∞Ñ ÏÑ†ÌÉù</h3>
                <div class="period-selector">
                    <button id="period-week" class="period-btn filter-btn active">ÏµúÍ∑º 7Ïùº</button>
                    <button id="period-month" class="period-btn filter-btn">ÏµúÍ∑º 30Ïùº</button>
                    <button id="period-all" class="period-btn filter-btn">Ï†ÑÏ≤¥ Í∏∞Í∞Ñ</button>
                    <button id="period-custom" class="period-btn filter-btn">ÏÇ¨Ïö©Ïûê ÏßÄÏ†ï</button>
                </div>
                <div id="custom-date-range" class="date-range-picker hidden mt-3">
                    <input type="date" id="start-date" class="rounded-md py-2 px-3">
                    <span class="text-gray-400">~</span>
                    <input type="date" id="end-date" class="rounded-md py-2 px-3">
                    <button id="apply-custom-range" class="py-2 px-4 bg-blue-600 text-white rounded-md">Ï†ÅÏö©</button>
                </div>
            </div>

            <!-- History KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">Ï¥ù ÏûëÏóÖ ÏùºÏàò</h4>
                    <p id="history-kpi-days" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ÎàÑÏ†Å ÏûëÏóÖÎüâ</h4>
                    <p id="history-kpi-total-qty" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ÌèâÍ∑† HTP</h4>
                    <p id="history-kpi-avg-htp" class="text-3xl font-bold text-white">0.0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow border-l-purple-500">
                    <h4 class="text-gray-400 text-sm font-medium">ÏµúÍ≥† HTP</h4>
                    <p id="history-kpi-max-htp" class="text-3xl font-bold text-purple-400">0.0</p>
                </div>
            </div>

            <!-- üÜï Employee Search & Analysis Section -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">üë§ ÏÇ¨ÏõêÎ≥Ñ ÏÉÅÏÑ∏ Î∂ÑÏÑù</h3>
                    <div class="flex items-center gap-2">
                        <input 
                            type="text" 
                            id="history-employee-search" 
                            placeholder="üîç Ïù¥Î¶Ñ ÎòêÎäî Ïø†ÏΩîÎìú Í≤ÄÏÉâ..." 
                            class="py-2 px-4 rounded-md text-sm w-80"
                            style="background: var(--bg-tertiary); border: 2px solid var(--border-color); color: var(--text-primary);"
                        >
                        <button id="history-show-all-btn" class="py-2 px-4 bg-blue-600 text-white rounded-md text-sm font-semibold hover:bg-blue-700">
                            Ï†ÑÏ≤¥ Î≥¥Í∏∞
                        </button>
                    </div>
                </div>

                <!-- Employee Analysis Results -->
                <div id="history-employee-results" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center py-10 text-gray-400">
                        ÏÇ¨ÏõêÏùÑ Í≤ÄÏÉâÌïòÍ±∞ÎÇò "Ï†ÑÏ≤¥ Î≥¥Í∏∞"Î•º ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî
                    </div>
                </div>

                <!-- Pagination for All Employees -->
                <div id="history-pagination" class="hidden mt-4 flex justify-center items-center gap-2">
                    <button id="history-prev-page" class="py-2 px-4 bg-gray-700 text-white rounded-md hover:bg-gray-600 disabled:opacity-50">
                        ‚óÄ Ïù¥Ï†Ñ
                    </button>
                    <span id="history-page-info" class="text-gray-300 mx-4">1 / 1</span>
                    <button id="history-next-page" class="py-2 px-4 bg-gray-700 text-white rounded-md hover:bg-gray-600 disabled:opacity-50">
                        Îã§Ïùå ‚ñ∂
                    </button>
                </div>
            </div>

            <!-- Top Performers History -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-white">üèÜ Í∏∞Í∞ÑÎ≥Ñ Top 10 ÏûëÏóÖÏûê</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-md font-semibold mb-2 text-blue-400">PICK (ÏßëÌíà)</h4>
                        <div id="history-top-pick-list" class="space-y-2"></div>
                    </div>
                    <div>
                        <h4 class="text-md font-semibold mb-2 text-yellow-400">PACK (Ìè¨Ïû•)</h4>
                        <div id="history-top-pack-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- Export History Button -->
            <div class="flex justify-end gap-3">
                <button id="export-history-excel" class="py-3 px-6 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">
                    üìä ÌûàÏä§ÌÜ†Î¶¨ ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
                </button>
                <button id="export-history-pdf" class="py-3 px-6 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">
                    üìÑ PDF Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
                </button>
            </div>
        </div>
		
		<!-- üÜï Calendar View -->
        <div id="calendar-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="calendar-prev-month" class="calendar-nav-btn">‚óÄ Ïù¥Ï†Ñ</button>
                    <h2 id="calendar-month-title" class="text-2xl font-bold text-white">2025ÎÖÑ 1Ïõî</h2>
                    <button id="calendar-next-month" class="calendar-nav-btn">Îã§Ïùå ‚ñ∂</button>
                </div>
                
                <div class="calendar-grid" id="calendar-grid">
                    <!-- ÏöîÏùº Ìó§Îçî -->
                    <div class="calendar-day-header">Ïùº</div>
                    <div class="calendar-day-header">Ïõî</div>
                    <div class="calendar-day-header">Ìôî</div>
                    <div class="calendar-day-header">Ïàò</div>
                    <div class="calendar-day-header">Î™©</div>
                    <div class="calendar-day-header">Í∏à</div>
                    <div class="calendar-day-header">ÌÜ†</div>
                    <!-- ÎÇ†ÏßúÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                </div>

                <div class="calendar-legend">
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color excellent"></div>
                        <span>Ïö∞Ïàò (Î™©Ìëú 120% Ïù¥ÏÉÅ)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color good"></div>
                        <span>ÏñëÌò∏ (Î™©Ìëú 100-120%)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color average"></div>
                        <span>Î≥¥ÌÜµ (Î™©Ìëú 80-100%)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color poor"></div>
                        <span>Ï†ÄÏ°∞ (Î™©Ìëú 80% ÎØ∏Îßå)</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color no-data"></div>
                        <span>Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</span>
                    </div>
                </div>
            </div>
        </div>
		
		<!-- üÜï Ranking View -->
        <div id="ranking-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <!-- Ranking Period Selector -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="ranking-tabs">
                    <button id="ranking-daily" class="ranking-tab active">üìÖ ÏùºÍ∞Ñ</button>
                    <button id="ranking-weekly" class="ranking-tab">üìä Ï£ºÍ∞Ñ</button>
                    <button id="ranking-monthly" class="ranking-tab">üìà ÏõîÍ∞Ñ</button>
                    <button id="ranking-all-time" class="ranking-tab">üèÜ Ï†ÑÏ≤¥</button>
                </div>
            </div>

            <!-- Process Type Selector for Ranking -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="ranking-tabs">
                    <button id="ranking-pick-type" class="ranking-tab active">üü¶ PICK Îû≠ÌÇπ</button>
                    <button id="ranking-pack-type" class="ranking-tab">üü® PACK Îû≠ÌÇπ</button>
                </div>
            </div>

            <!-- Top 3 Podium -->
            <div class="ranking-card">
                <h3 class="text-2xl font-bold text-white mb-4 text-center">üèÜ TOP 3</h3>
                <div class="ranking-podium" id="ranking-podium">
                    <!-- Podium items will be dynamically added -->
                    <div class="podium-item podium-second">
                        <div class="podium-rank">ü•à</div>
                        <div class="podium-name" id="podium-2-name">-</div>
                        <div class="podium-score" id="podium-2-score">0</div>
                    </div>
                    <div class="podium-item podium-first">
                        <div class="podium-rank">ü•á</div>
                        <div class="podium-name" id="podium-1-name">-</div>
                        <div class="podium-score" id="podium-1-score">0</div>
                    </div>
                    <div class="podium-item podium-third">
                        <div class="podium-rank">ü•â</div>
                        <div class="podium-name" id="podium-3-name">-</div>
                        <div class="podium-score" id="podium-3-score">0</div>
                    </div>
                </div>
            </div>

            <!-- Full Ranking List -->
            <div class="ranking-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">üìã Ï†ÑÏ≤¥ ÏàúÏúÑ</h3>
                    <div class="text-sm text-gray-400">
                        <span>Ï¥ù <span id="ranking-total-count" class="font-bold text-white">0</span>Î™Ö</span>
                    </div>
                </div>
                <div class="ranking-list" id="ranking-list">
                    <!-- Ranking items will be dynamically added -->
                    <div class="text-center py-10 text-gray-500">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                </div>
            </div>

            <!-- Ranking Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ÌèâÍ∑† HTP</h4>
                    <p id="ranking-avg-htp" class="text-3xl font-bold text-white">0.0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow border-l-green-500">
                    <h4 class="text-gray-400 text-sm font-medium">ÏµúÍ≥† HTP</h4>
                    <p id="ranking-max-htp" class="text-3xl font-bold text-green-400">0.0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow border-l-yellow-500">
                    <h4 class="text-gray-400 text-sm font-medium">Ï§ëÍ∞ÑÍ∞í HTP</h4>
                    <p id="ranking-median-htp" class="text-3xl font-bold text-yellow-400">0.0</p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Chart Modal (Individual Trend) -->
<div id="chart-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="chart-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl p-6 relative flex flex-col overflow-y-auto">
        <h3 id="chart-modal-title" class="text-xl font-bold text-white mb-4">Í∞úÏù∏ HTP Ï∂îÏù¥</h3>
        <div class="flex-grow min-h-0"><canvas id="individual-htp-chart"></canvas></div>
        <button id="chart-modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
</div>

<!-- üÜï Employee Detail Modal (Í∞úÏù∏Î≥Ñ ÌûàÏä§ÌÜ†Î¶¨ ÏÉÅÏÑ∏ Î∂ÑÏÑù) -->
<div id="employee-detail-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="employee-detail-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl p-6 relative">
        <!-- Header -->
        <div class="employee-detail-header">
            <div class="flex justify-between items-start">
                <div>
                    <h2 id="employee-detail-name" class="text-3xl font-bold mb-2">ÏûëÏóÖÏûê Ïù¥Î¶Ñ</h2>
                    <p id="employee-detail-subtitle" class="text-lg opacity-90">PICK (ÏßëÌíà)</p>
                </div>
                <button id="employee-detail-close" class="text-white hover:text-gray-300">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="employee-detail-stats">
            <div class="employee-stat-card">
                <div class="employee-stat-label">Ï¥ù Í∑ºÎ¨¥ÏùºÏàò</div>
                <div class="employee-stat-value" id="employee-detail-total-days">0</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">ÌèâÍ∑† HTP</div>
                <div class="employee-stat-value" id="employee-detail-avg-htp">0.0</div>
                <div id="employee-detail-avg-trend" class="trend-indicator positive mt-2">
                    <span>‚Üë</span>
                    <span>+0%</span>
                </div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">ÏµúÍ≥† HTP</div>
                <div class="employee-stat-value text-green-400" id="employee-detail-max-htp">0.0</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">Ï¥ù ÏûëÏóÖÎüâ</div>
                <div class="employee-stat-value" id="employee-detail-total-qty">0</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">Î™©Ìëú Îã¨ÏÑ±Î•†</div>
                <div class="employee-stat-value" id="employee-detail-target-rate">0%</div>
            </div>
            <div class="employee-stat-card">
                <div class="employee-stat-label">ÌòÑÏû¨ ÏàúÏúÑ</div>
                <div class="employee-stat-value" id="employee-detail-rank">-</div>
            </div>
        </div>

        <!-- Î±ÉÏßÄ ÏÑπÏÖò -->
        <div class="bg-gray-700 p-4 rounded-lg mb-4">
            <h4 class="text-lg font-semibold mb-3 text-white">üèÖ ÌöçÎìù Î±ÉÏßÄ</h4>
            <div id="employee-detail-badges" class="flex flex-wrap gap-2">
                <span class="text-gray-400">ÌöçÎìùÌïú Î±ÉÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§</span>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="employee-chart-container">
                <h4 class="text-lg font-semibold mb-3 text-white">üìà ÏùºÎ≥Ñ HTP Ï∂îÏù¥</h4>
                <div class="relative h-64"><canvas id="employee-detail-daily-chart"></canvas></div>
            </div>
            <div class="employee-chart-container">
                <h4 class="text-lg font-semibold mb-3 text-white">üìä ÏùºÎ≥Ñ ÏûëÏóÖÎüâ</h4>
                <div class="relative h-64"><canvas id="employee-detail-qty-chart"></canvas></div>
            </div>
        </div>

        <!-- Ï£ºÍ∞Ñ/ÏõîÍ∞Ñ ÎπÑÍµê -->
        <div class="employee-chart-container mb-4">
            <h4 class="text-lg font-semibold mb-3 text-white">üìÖ Ï£ºÍ∞Ñ ÌèâÍ∑† ÎπÑÍµê</h4>
            <div class="relative h-64"><canvas id="employee-detail-weekly-chart"></canvas></div>
        </div>

        <!-- ÏµúÍ∑º Í∏∞Î°ù ÌÖåÏù¥Î∏î -->
        <div class="bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold mb-3 text-white">üìã ÏµúÍ∑º 10Ïùº Í∏∞Î°ù</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-600">
                        <tr>
                            <th class="px-4 py-2 text-left text-white">ÎÇ†Ïßú</th>
                            <th class="px-4 py-2 text-left text-white">ÏûëÏóÖÎüâ</th>
                            <th class="px-4 py-2 text-left text-white">M/H</th>
                            <th class="px-4 py-2 text-left text-white">HTP</th>
                            <th class="px-4 py-2 text-left text-white">ÏàúÏúÑ</th>
                        </tr>
                    </thead>
                    <tbody id="employee-detail-recent-table" class="bg-gray-800">
                        <!-- Data will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- üÜï Calendar Day Detail Modal -->
<div id="calendar-detail-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="calendar-detail-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl p-6 relative max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="calendar-detail-title" class="text-2xl font-bold text-white">2025-01-17 ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h3>
            <button id="calendar-detail-close" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Day Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">ÌèâÍ∑† HTP</div>
                <div id="calendar-detail-avg-htp" class="text-2xl font-bold text-white">0.0</div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">Ï¥ù ÏûëÏóÖÎüâ</div>
                <div id="calendar-detail-total-qty" class="text-2xl font-bold text-white">0</div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">ÏûëÏóÖÏûê Ïàò</div>
                <div id="calendar-detail-worker-count" class="text-2xl font-bold text-white">0</div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="text-xs text-gray-400 mb-1">Î™©Ìëú Îã¨ÏÑ±Î•†</div>
                <div id="calendar-detail-target-rate" class="text-2xl font-bold text-white">0%</div>
            </div>
        </div>

        <!-- Top Performers of the Day -->
        <div class="bg-gray-700 p-4 rounded-lg mb-4">
            <h4 class="text-lg font-semibold mb-3 text-white">üèÜ ÎãπÏùº Top 5</h4>
            <div id="calendar-detail-top-list" class="space-y-2">
                <!-- List will be populated dynamically -->
            </div>
        </div>

        <!-- Process Distribution Chart -->
        <div class="bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold mb-3 text-white">üìä ÌîÑÎ°úÏÑ∏Ïä§Î≥Ñ Î∂ÑÌè¨</h4>
            <div class="relative h-64"><canvas id="calendar-detail-chart"></canvas></div>
        </div>
    </div>
</div>

<!-- üÜï Hidden Employees Management Modal -->
<div id="hidden-employees-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 relative">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-white">üëª Ïà®Í∏¥ ÏûëÏóÖÏûê Í¥ÄÎ¶¨</h3>
            <button id="hidden-employees-modal-close" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="mb-4">
            <p class="text-gray-400 text-sm">Ïà®Í∏¥ ÏûëÏóÖÏûêÎäî Îç∞Ïù¥ÌÑ∞ Î≥¥Í∏∞ ÌÉ≠ÏóêÏÑú Î∞òÌà¨Î™ÖÌïòÍ≤å ÌëúÏãúÎêòÎ©∞, ÌÜµÍ≥ÑÏóêÏÑú Ï†úÏô∏ÎêòÏßÄ ÏïäÏäµÎãàÎã§.</p>
        </div>

        <div id="hidden-employees-modal-list" class="space-y-2 max-h-96 overflow-y-auto">
            <!-- Hidden employees list will be populated -->
            <div class="text-center py-10 text-gray-500">Ïà®Í∏¥ ÏûëÏóÖÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>
        </div>
    </div>
</div>

</body>
</html>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, Bytes, collection, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- üÜï Loading Progress Functions ---
    function showLoadingProgress(text = 'Î°úÎî© Ï§ë...') {
        const progressBar = document.getElementById('loading-progress-bar');
        const statusText = document.getElementById('loading-status-text');
        progressBar.classList.add('active');
        statusText.classList.add('active');
        statusText.textContent = text;
    }

    function updateLoadingProgress(percent, text) {
        const progressFill = document.getElementById('loading-progress-fill');
        const statusText = document.getElementById('loading-status-text');
        progressFill.style.width = `${percent}%`;
        if (text) statusText.textContent = text;
    }

    function hideLoadingProgress() {
        const progressBar = document.getElementById('loading-progress-bar');
        const statusText = document.getElementById('loading-status-text');
        setTimeout(() => {
            progressBar.classList.remove('active');
            statusText.classList.remove('active');
        }, 300);
    }

    // --- Theme Management ---
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
        const themeIcon = document.getElementById('theme-icon');
        if (themeIcon) {
            themeIcon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
    }

    // Initialize theme immediately
    initTheme();

    // --- UI Elements ---
    const ui = {
        appContainer: document.getElementById('app-container'),
        fileUpload: document.getElementById('file-upload'),
        tableBody: document.getElementById('data-table-body'),
        tableHeader: document.querySelector('#data-table thead'),
        placeholderRow: document.getElementById('placeholder-row'),
        loaderContainer: document.getElementById('loader-container'),
        statusIndicator: document.getElementById('status-indicator'),
        lastUpdatedEl: document.getElementById('last-updated'),
        lastUploaderEl: document.getElementById('last-uploader'),
        sidebar: document.getElementById('sidebar'),
        sidebarToggleDesktop: document.getElementById('sidebar-toggle-desktop'),
        sidebarToggleMobile: document.getElementById('sidebar-toggle-mobile'),
        sidebarOverlay: document.getElementById('sidebar-overlay'),
        floorFilters: document.getElementById('floor-filters'),
        packTypeFilters: document.getElementById('pack-type-filters'),
        hourFilters: document.getElementById('hour-filters'),
        searchInput: document.getElementById('search-input'),
        lowHtpToggle: document.getElementById('low-htp-toggle'),
        statsDisplay: document.getElementById('stats-display'),
        captureBtn: document.getElementById('capture-btn'),
        exportBtn: document.getElementById('export-btn'),
        targetHtpSettings: document.getElementById('target-htp-settings'),
        tickerText: document.getElementById('ticker-text'),
        tableViewBtn: document.getElementById('table-view-btn'),
        dashboardViewBtn: document.getElementById('dashboard-view-btn'),
        historyViewBtn: document.getElementById('history-view-btn'),
        calendarViewBtn: document.getElementById('calendar-view-btn'),
        rankingViewBtn: document.getElementById('ranking-view-btn'),
        tableView: document.getElementById('table-view'),
        dashboardView: document.getElementById('dashboard-view'),
        historyView: document.getElementById('history-view'),
        calendarView: document.getElementById('calendar-view'),
        rankingView: document.getElementById('ranking-view'),
        chartModalBackdrop: document.getElementById('chart-modal-backdrop'),
        chartModalTitle: document.getElementById('chart-modal-title'),
        chartModalClose: document.getElementById('chart-modal-close'),
        kpi: {
            totalWorkers: document.getElementById('kpi-total-workers'),
            totalQty: document.getElementById('kpi-total-qty'),
            avgHtp: document.getElementById('kpi-avg-htp'),
            lowPerformers: document.getElementById('kpi-low-performers'),
        },
        topPickPerformersList: document.getElementById('top-pick-performers-list'),
        topPackPerformersList: document.getElementById('top-pack-performers-list'),
        periodWeekBtn: document.getElementById('period-week'),
        periodMonthBtn: document.getElementById('period-month'),
        periodAllBtn: document.getElementById('period-all'),
        periodCustomBtn: document.getElementById('period-custom'),
        customDateRange: document.getElementById('custom-date-range'),
        startDate: document.getElementById('start-date'),
        endDate: document.getElementById('end-date'),
        applyCustomRange: document.getElementById('apply-custom-range'),
        historyKpi: {
            days: document.getElementById('history-kpi-days'),
            totalQty: document.getElementById('history-kpi-total-qty'),
            avgHtp: document.getElementById('history-kpi-avg-htp'),
            maxHtp: document.getElementById('history-kpi-max-htp'),
        },
        historyTopPickList: document.getElementById('history-top-pick-list'),
        historyTopPackList: document.getElementById('history-top-pack-list'),
        exportHistoryExcel: document.getElementById('export-history-excel'),
        exportHistoryPdf: document.getElementById('export-history-pdf'),
        calendarPrevMonth: document.getElementById('calendar-prev-month'),
        calendarNextMonth: document.getElementById('calendar-next-month'),
        calendarMonthTitle: document.getElementById('calendar-month-title'),
        calendarGrid: document.getElementById('calendar-grid'),
        calendarDetailModalBackdrop: document.getElementById('calendar-detail-modal-backdrop'),
        calendarDetailClose: document.getElementById('calendar-detail-close'),
        rankingDaily: document.getElementById('ranking-daily'),
        rankingWeekly: document.getElementById('ranking-weekly'),
        rankingMonthly: document.getElementById('ranking-monthly'),
        rankingAllTime: document.getElementById('ranking-all-time'),
        rankingPickType: document.getElementById('ranking-pick-type'),
        rankingPackType: document.getElementById('ranking-pack-type'),
        rankingPodium: document.getElementById('ranking-podium'),
        rankingList: document.getElementById('ranking-list'),
        rankingTotalCount: document.getElementById('ranking-total-count'),
        rankingAvgHtp: document.getElementById('ranking-avg-htp'),
        rankingMaxHtp: document.getElementById('ranking-max-htp'),
        rankingMedianHtp: document.getElementById('ranking-median-htp'),
        employeeDetailModalBackdrop: document.getElementById('employee-detail-modal-backdrop'),
        employeeDetailClose: document.getElementById('employee-detail-close'),
        manageHiddenBtn: document.getElementById('manage-hidden-btn'),
        hiddenCountBadge: document.getElementById('hidden-count-badge'),
        hiddenEmployeesList: document.getElementById('hidden-employees-list'),
        hiddenEmployeesModalBackdrop: document.getElementById('hidden-employees-modal-backdrop'),
        hiddenEmployeesModalClose: document.getElementById('hidden-employees-modal-close'),
    };

    // --- Global State ---
    let globalRawData = []; 
    let historyData = {}; // { 'YYYY-MM-DD': rawDataArray }
    let hiddenEmployees = new Set();
    let state = {
        filters: {
            process: 'all', search: '', lowHtp: false,
            hours: new Set(), floors: new Set(), packTypes: new Set()
        },
        sort: { key: 'htp', direction: 'asc' },
        charts: { 
            floorHtp: null, packType: null, individualHtp: null, 
            processComparison: null, hourlyHtp: null,
            historyDailyTrend: null, historyDailyQty: null,
            employeeDailyChart: null, employeeQtyChart: null, employeeWeeklyChart: null,
            calendarDetailChart: null
        },
        historyPeriod: 'week',
        historyDateRange: { start: null, end: null },
        calendarCurrentMonth: new Date(),
        rankingPeriod: 'daily',
        rankingProcessType: 'pick',
    };
    let targetHtpValues = {};
    let employeeBadges = {};
    let previousRankings = {};

    // --- Constants ---
    const PACK_TYPE_MAP = {
		"Î©îÎâ¥ÏñºÌå©": "179_1.3F_MA_S_OG_", "Î©îÎâ¥ÏñºÌå© Î©ÄÌã∞": "179_1.3F_MA_M_OG_", "ACE LINE": "179-1.2F-MA-ACE-OG-",
            "Ïò§ÌÜ†Î∞± 1.2": "179_1.3F_AB_R1.2_OG_", "Ïò§ÌÜ†Î∞± 2.5": "179_1.3F_AB_R2.5_OG_", "Ïò§ÌÜ†Î∞± 4.0": "179_1.3F_AB_R4.0_OG_",
            "Ïò§ÌÜ†Î∞± RTPB": "179_1.3F_AB_T1_OG_", "Ïò§ÌÜ†Î∞± Î©ÄÌã∞": "179_1.3F_AB_M_OG_", "CFC Î©îÎâ¥ÏñºÌå©": "190_6.2F_MA_S_OG_",
            "CFC Î©îÎâ¥ÏñºÌå© Î©ÄÌã∞": "190_6.2F_MA_M_OG_", "CFC Ïò§ÌÜ†Î∞± 1.2": "190_6.2F_AB_R1.2_OG_", "CFC Ïò§ÌÜ†Î∞± 2.5": "190_6.2F_AB_R2.5_OG_", "CFC Ïò§ÌÜ†Î∞± 4.0": "190_6.2F_AB_R4.0_OG_",
            "CFC Ïò§ÌÜ†Î∞± RTPB": "190_6.2G_AB_T1_OG_"
	};
    const DEFAULT_PACK_TYPE = "Í∏∞ÌÉÄ";
    const MANAGERS_LIST = ['R5370913', 'E4992491', 'Z7386388', 'Z5406388', 'B3706369', 'S4461023', 'V6568216', 'X4033164', 'X7694762', 'A1943868', 'D5012685', 'N2086791', 'W9345496', 'T5941917', 'K9270657', 'P1637348', 'H6239751', 'X9075186', 'H4633331', 'G4094768', 'R9635160', 'R2637601', 'T9383022', 'V4296863', 'G9236102', 'U7306474', 'P9738071', 'L5291847', 'D9063832', 'R8788212', 'S1827358', 'M9279634', 'H3088014', 'V8173681', 'J7268590', 'G2791563', 'N2607464', 'Y5651563', 'H3614867', 'Q2813675', 'U2554263', 'T9060243', 'G2345755', 'A3511520', 'T3138750'];
    
    const TARGET_HTP_DEFAULTS = {
            "CFC Î©îÎâ¥ÏñºÌå©": { value: 100, keywords: ['CFC_ManualPack', '179_1.3F_MA_S_OG_'] },
            "CFC Î©îÎâ¥ÏñºÌå© Î©ÄÌã∞": { value: 120, keywords: ['CFC_Manual_Multi', '179_1.3F_MA_M_OG_'] },
            "CFC ÏóêÏù¥Ïä§ (Ï§ÄÎπÑÏ§ë)": { value: 150, keywords: ['CFC_ACE', '179-1.2F-MA-ACE-OG-'] },
            "CFC Ïò§ÌÜ†Î∞± 1.2": { value: 380, keywords: ['CFC_Autobag1.2', '179_1.3F_AB_R1.2_OG_', 'AGV_Autobag1.2DW'] },
            "CFC Ïò§ÌÜ†Î∞± 2.5": { value: 350, keywords: ['CFC_Autobag2.5', '179_1.3F_AB_R2.5_OG_'] },
            "CFC Ïò§ÌÜ†Î∞± 4.0": { value: 280, keywords: ['CFC_Autobag4.0', '179_1.3F_AB_R4.0_OG_'] },
            "CFC Ïò§ÌÜ†Î∞± RTPB": { value: 150, keywords: ['CFC_Autobag_RTPB', '179_1.3F_AB_T1_OG_'] },
            "CFC Ïò§ÌÜ†Î∞± Î©ÄÌã∞": { value: 250, keywords: ['CFC_Autobag_Multi', '179_1.3F_AB_M_OG_'] },
            "PICK": { value: 90, keywords: [] }
        };
    for(const key in TARGET_HTP_DEFAULTS) {
        targetHtpValues[key] = TARGET_HTP_DEFAULTS[key].value;
    }

    // --- LocalStorage Management for Hidden Employees ---
    function loadHiddenEmployees() {
        const saved = localStorage.getItem('hiddenEmployees');
        if (saved) {
            hiddenEmployees = new Set(JSON.parse(saved));
        }
        updateHiddenCountBadge();
    }

    function saveHiddenEmployees() {
        localStorage.setItem('hiddenEmployees', JSON.stringify([...hiddenEmployees]));
        updateHiddenCountBadge();
    }

    function updateHiddenCountBadge() {
        ui.hiddenCountBadge.textContent = hiddenEmployees.size;
        if (hiddenEmployees.size > 0) {
            ui.hiddenCountBadge.classList.remove('bg-gray-500');
            ui.hiddenCountBadge.classList.add('bg-red-500');
        } else {
            ui.hiddenCountBadge.classList.remove('bg-red-500');
            ui.hiddenCountBadge.classList.add('bg-gray-500');
        }
    }

    function toggleHiddenEmployee(employeeName) {
        if (hiddenEmployees.has(employeeName)) {
            hiddenEmployees.delete(employeeName);
        } else {
            hiddenEmployees.add(employeeName);
        }
        saveHiddenEmployees();
        applyFiltersAndRender();
    }

    function showHiddenEmployeesModal() {
        const modalList = document.getElementById('hidden-employees-modal-list');
        modalList.innerHTML = '';

        if (hiddenEmployees.size === 0) {
            modalList.innerHTML = '<div class="text-center py-10 text-gray-500">Ïà®Í∏¥ ÏûëÏóÖÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
        } else {
            hiddenEmployees.forEach(employeeName => {
                const item = document.createElement('div');
                item.className = 'hidden-employee-item';
                item.innerHTML = `
                    <span class="font-semibold text-white">${employeeName}</span>
                    <button class="show-employee-btn" data-employee="${employeeName}">Î≥µÍµ¨</button>
                `;
                modalList.appendChild(item);
            });

            modalList.querySelectorAll('.show-employee-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const employeeName = e.target.dataset.employee;
                    toggleHiddenEmployee(employeeName);
                    showHiddenEmployeesModal();
                });
            });
        }

        ui.hiddenEmployeesModalBackdrop.classList.remove('hidden');
        ui.hiddenEmployeesModalBackdrop.classList.add('flex');
    }

    // --- Firebase Setup ---
    const firebaseConfig = {
    apiKey: "AIzaSyAKxH0QXnVTQMpfWJYdMUhHoMIwF89bgjU",
    authDomain: "gwj2-cfchtp-tool.firebaseapp.com",
    projectId: "gwj2-cfchtp-tool",
    storageBucket: "gwj2-cfchtp-tool.firebasestorage.app",
    messagingSenderId: "870169870004",
    appId: "1:870169870004:web:aaf9034bb1dd5eb07621e1",
    measurementId: "G-0E55KNF6GB"
};
    let db, auth, userId, dataDocRef, historyCollectionRef;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        dataDocRef = doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'htpData', 'latestCompressed');
        historyCollectionRef = collection(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'htpHistory');
    } catch(e) {
        console.error("Firebase Ï¥àÍ∏∞Ìôî Ïò§Î•ò:", e);
        updateStatus('disconnected', 'Firebase Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
    
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            updateStatus('connected', 'Ïã§ÏãúÍ∞Ñ ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.');
            ui.fileUpload.disabled = false;
            setupRealtimeListener();
            // ‚ö° LAZY LOAD: ÌûàÏä§ÌÜ†Î¶¨Îäî ÌûàÏä§ÌÜ†Î¶¨ ÌÉ≠ ÌÅ¥Î¶≠ ÏãúÏóêÎßå Î°úÎìú
            // loadHistoryData(); // Ï†úÍ±∞
            loadHiddenEmployees();
        } else {
            try { await signInAnonymously(auth); } catch (error) {
                console.error("ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ Ïò§Î•ò:", error);
                updateStatus('disconnected', 'ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }
    });

    function setupRealtimeListener() {
        onSnapshot(dataDocRef, (docSnap) => {
            showLoader();
            if (docSnap.exists()) {
                const dataPayload = docSnap.data();
                try {
                    const compressedBytes = dataPayload.compressedData;
                    if (!compressedBytes) throw new Error("ÏïïÏ∂ïÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
                    
                    // ‚ö° OPTIMIZED: requestIdleCallbackÏúºÎ°ú ÎπÑÎèôÍ∏∞ Ï≤òÎ¶¨
                    requestIdleCallback(() => {
                        try {
                            const compressedUint8Array = compressedBytes.toUint8Array();
                            const decompressedString = pako.ungzip(compressedUint8Array, { to: 'string' });
                            const parsedData = JSON.parse(decompressedString);
                            globalRawData = parsedData.map(item => ({
                                ...item,
                                htpStart: new Date(item.htpStart),
                                htpEnd: new Date(item.htpEnd),
                            }));
                            ui.lastUploaderEl.textContent = dataPayload.uploaderId.substring(0, 8) + '...';
                            ui.lastUpdatedEl.textContent = new Date(dataPayload.timestamp).toLocaleString('ko-KR');
                            
                            // üÜï ÌïÑÌÑ∞ Ï¥àÍ∏∞ÌôîÎ•º ÎπÑÎèôÍ∏∞Î°ú
                            requestAnimationFrame(() => {
                                initializeFiltersFromData(globalRawData);
                                requestAnimationFrame(() => {
                                    applyFiltersAndRender();
                                    hideLoader();
                                });
                            });
                        } catch (error) {
                            console.error("Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ïò§Î•ò:", error);
                            showModal("Îç∞Ïù¥ÌÑ∞Î•º Ï≤òÎ¶¨ÌïòÎäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                            globalRawData = [];
                            applyFiltersAndRender();
                            hideLoader();
                        }
                    });
                } catch (error) {
                    console.error("Îç∞Ïù¥ÌÑ∞ ÏïïÏ∂ï Ìï¥Ï†ú ÎòêÎäî ÌååÏã± Ïò§Î•ò:", error);
                    showModal("ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞ Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞Î•º Ï≤òÎ¶¨ÌïòÎäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                    globalRawData = [];
                    applyFiltersAndRender();
                    hideLoader();
                }
            } else {
                globalRawData = [];
                initializeFiltersFromData([]);
                applyFiltersAndRender();
                hideLoader();
            }
        }, (error) => {
            console.error("Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏã† Ïò§Î•ò:", error);
            updateStatus('disconnected', 'Îç∞Ïù¥ÌÑ∞ ÏàòÏã† Ï§ë Ïò§Î•ò Î∞úÏÉù');
            hideLoader();
        });
    }

    // ‚ö° OPTIMIZED: History Data Management
    let isLoadingHistory = false;
    let isHistoryLoaded = false; // ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú ÏôÑÎ£å ÌîåÎûòÍ∑∏
    let badgesCalculated = false;

    async function loadHistoryData(days = 90) {
        if (isLoadingHistory) return;
        isLoadingHistory = true;
        
        showLoadingProgress('ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...');
        updateLoadingProgress(10, 'ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë...');
        
        try {
            const daysAgo = new Date();
            daysAgo.setDate(daysAgo.getDate() - days);
            
            const q = query(
                historyCollectionRef,
                where('date', '>=', daysAgo.toISOString().split('T')[0]),
                orderBy('date', 'desc')
            );
            
            updateLoadingProgress(20, 'FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Îäî Ï§ë...');
            const querySnapshot = await getDocs(q);
            const allDocs = [];
            querySnapshot.forEach((doc) => {
                allDocs.push(doc.data());
            });
            
            console.log(`üì¶ Ï¥ù ${allDocs.length}ÏùºÏùò Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï©ÎãàÎã§...`);
            updateLoadingProgress(40, `${allDocs.length}Ïùº Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ï§ë...`);
            
            // üÜï Ï≤≠ÌÅ¨ Îã®ÏúÑÎ°ú Ï≤òÎ¶¨ (10ÏùºÏî©)
            historyData = {};
            const CHUNK_SIZE = 10;
            
            for (let i = 0; i < allDocs.length; i += CHUNK_SIZE) {
                const chunk = allDocs.slice(i, i + CHUNK_SIZE);
                const progress = 40 + ((i / allDocs.length) * 50);
                updateLoadingProgress(progress, `${i + chunk.length}/${allDocs.length} Ïùº Ï≤òÎ¶¨ Ï§ë...`);
                
                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        chunk.forEach(data => {
                            try {
                                const compressedBytes = data.compressedData;
                                if (!compressedBytes) return;
                                const compressedUint8Array = compressedBytes.toUint8Array();
                                const decompressedString = pako.ungzip(compressedUint8Array, { to: 'string' });
                                const parsedData = JSON.parse(decompressedString);
                                historyData[data.date] = parsedData.map(item => ({
                                    ...item,
                                    htpStart: new Date(item.htpStart),
                                    htpEnd: new Date(item.htpEnd),
                                }));
                            } catch (error) {
                                console.error(`ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò (${data.date}):`, error);
                            }
                        });
                        resolve();
                    });
                });
            }
            
            updateLoadingProgress(95, 'ÌûàÏä§ÌÜ†Î¶¨ Î°úÎî© ÏôÑÎ£å!');
            console.log(`‚ú® ${Object.keys(historyData).length}ÏùºÏùò ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å`);
            
            // üÜï Î±ÉÏßÄ ÏûêÎèô Í≥ÑÏÇ∞
            badgesCalculated = false;
            console.log('üèÖ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú ÏôÑÎ£å - Î±ÉÏßÄ ÏûêÎèô Í≥ÑÏÇ∞ ÏãúÏûë');
            ensureBadgesCalculated();
            
        } catch (error) {
            console.error("ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:", error);
            showModal('ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        } finally {
            isLoadingHistory = false;
            updateLoadingProgress(100, 'ÏôÑÎ£å!');
            isHistoryLoaded = true; // ‚ö° Î°úÎìú ÏôÑÎ£å ÌîåÎûòÍ∑∏
            setTimeout(() => hideLoadingProgress(), 500);
        }
    }

    // üÜï Î±ÉÏßÄ Í≥ÑÏÇ∞ (ÏßÄÏó∞ Ïã§Ìñâ)
    function ensureBadgesCalculated() {
        // ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ ÎòêÎäî ÏùºÎ∞ò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Î±ÉÏßÄ Í≥ÑÏÇ∞
        const hasData = Object.keys(historyData).length > 0 || globalRawData.length > 0;
        
        if (!badgesCalculated && hasData) {
            console.log('üèÖ Î±ÉÏßÄ Í≥ÑÏÇ∞ ÏãúÏûë...');
            calculateEmployeeBadges();
            badgesCalculated = true;
            console.log('‚úÖ Î±ÉÏßÄ Í≥ÑÏÇ∞ ÏôÑÎ£å (ÏÇ¨Ïõê Î∂ÑÏÑù Î™®Îã¨ÏóêÏÑú ÌëúÏãú)');
        }
    }
	
	// --- üèÖ Í∞ïÌôîÎêú Î±ÉÏßÄ ÏãúÏä§ÌÖú (20+ Ï¢ÖÎ•ò) ---
function calculateEmployeeBadges() {
    console.log('üèÖ Î±ÉÏßÄ Í≥ÑÏÇ∞ ÏãúÏûë...');
    
    employeeBadges = {};
    
    // üÜï ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞: historyData[date] = [items]
    let dataSource = 'none';
    let allEmployees = new Set();
    let employeeDataMap = {}; // ÏÇ¨ÏõêÎ≥Ñ Îç∞Ïù¥ÌÑ∞: {employee: [{date, htp, qty, processType}]}
    
    if (Object.keys(historyData).length > 0) {
        // ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© (ÎÇ†ÏßúÎ≥Ñ ‚Üí ÏÇ¨ÏõêÎ≥ÑÎ°ú Ïû¨Íµ¨ÏÑ±)
        dataSource = 'history';
        const sortedDates = Object.keys(historyData).sort();
        const recentDates = sortedDates.slice(-30);
        
        recentDates.forEach(date => {
            const dayData = historyData[date]; // Ìï¥Îãπ ÎÇ†ÏßúÏùò Î™®Îì† Îç∞Ïù¥ÌÑ∞
            if (!Array.isArray(dayData)) return;
            
            // ÎÇ†ÏßúÎ≥Ñ ÏÇ¨ÏõêÎ≥Ñ ÏßëÍ≥Ñ (Í∞ôÏùÄ ÎÇ†ÏßúÏùò Ïó¨Îü¨ ÏûëÏóÖÏùÑ Ìï©Ïπ®)
            const dailyEmployeeStats = {};
            
            dayData.forEach(item => {
                if (!item || !item.employee) return;
                
                const empName = item.employee;
                allEmployees.add(empName);
                
                if (!dailyEmployeeStats[empName]) {
                    dailyEmployeeStats[empName] = {
                        totalQty: 0,
                        totalSeconds: 0,
                        processTypes: new Set()
                    };
                }
                
                const durationSeconds = (item.htpEnd - item.htpStart) / 1000;
                if (durationSeconds > 0) {
                    dailyEmployeeStats[empName].totalQty += item.unitQty || 0;
                    dailyEmployeeStats[empName].totalSeconds += durationSeconds;
                    dailyEmployeeStats[empName].processTypes.add(item.processTask || item.processType || '');
                }
            });
            
            // Í∞Å ÏÇ¨ÏõêÏùò ÏùºÏùº ÏßëÍ≥ÑÎ•º employeeDataMapÏóê Ï†ÄÏû•
            Object.keys(dailyEmployeeStats).forEach(empName => {
                if (!employeeDataMap[empName]) {
                    employeeDataMap[empName] = [];
                }
                
                const stats = dailyEmployeeStats[empName];
                const dailyHtp = stats.totalSeconds > 0 
                    ? (stats.totalQty / (stats.totalSeconds / 3600)) 
                    : 0;
                
                // Ï£ºÏöî ÌîÑÎ°úÏÑ∏Ïä§ ÌÉÄÏûÖ Í≤∞Ï†ï
                const processType = Array.from(stats.processTypes).join(',');
                
                employeeDataMap[empName].push({
                    date: date,
                    htp: parseFloat(dailyHtp.toFixed(1)),
                    qty: stats.totalQty,
                    processType: processType
                });
            });
        });
    } else if (globalRawData && globalRawData.length > 0) {
        // ÏùºÎ∞ò Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© (Ïò§Îäò) - aggregateData ÏÇ¨Ïö©
        dataSource = 'today';
        const today = new Date().toISOString().split('T')[0];
        
        // globalRawDataÎäî Ïù¥ÎØ∏ ÏßëÍ≥ÑÎêú Îç∞Ïù¥ÌÑ∞ (aggregateData Í≤∞Í≥º)
        globalRawData.forEach(item => {
            if (item.employee) {
                allEmployees.add(item.employee);
                if (!employeeDataMap[item.employee]) {
                    employeeDataMap[item.employee] = [];
                }
                
                // item.htpÎäî Ïù¥ÎØ∏ Í≥ÑÏÇ∞Îêú ÌèâÍ∑† HTP
                employeeDataMap[item.employee].push({
                    date: today,
                    htp: parseFloat(item.htp) || 0,
                    qty: parseInt(item.unitQty) || 0,
                    processType: item.processType || ''
                });
            }
        });
    }
    
    console.log(`üìä Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§: ${dataSource}, ${allEmployees.size}Î™ÖÏùò ÏÇ¨Ïõê Î±ÉÏßÄ Í≥ÑÏÇ∞ Ï§ë...`);
    
    if (allEmployees.size === 0) {
        console.log('‚ö†Ô∏è Î±ÉÏßÄ Í≥ÑÏÇ∞ ÎåÄÏÉÅ ÏóÜÏùå');
        return;
    }
    
    allEmployees.forEach(employeeName => {
        const badges = [];
        const records = {
            maxHtp: 0,
            maxHtpDate: null,
            totalDays: 0,
            totalQty: 0,
            avgHtp: 0,
            pickDays: 0,
            packDays: 0,
            consecutiveDays: 0,
            maxConsecutiveDays: 0,
            topRankCount: 0,
            lowHtpCount: 0,
            perfectDays: 0, // HTP >= Î™©Ìëú Îã¨ÏÑ± ÏùºÏàò
            specialtyProcess: null, // PICK ÎòêÎäî PACK Ï†ÑÎ¨∏Í∞Ä
        };
        
        const htpHistory = [];
        let currentStreak = 0;
        let lastDate = null;
        
        // ÏÇ¨ÏõêÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        const employeeRecords = employeeDataMap[employeeName] || [];
        
        // ÎÇ†ÏßúÎ≥ÑÎ°ú Í∑∏Î£πÌôî
        const dateGroups = {};
        employeeRecords.forEach(record => {
            if (!dateGroups[record.date]) {
                dateGroups[record.date] = [];
            }
            dateGroups[record.date].push(record);
        });
        
        // ÎÇ†Ïßú Ï†ïÎ†¨
        const employeeDates = Object.keys(dateGroups).sort();
        
        // ÎÇ†ÏßúÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
        employeeDates.forEach(date => {
            const dayRecords = dateGroups[date];
            
            // Í∑ºÎ¨¥ÏùºÏàò Ï¶ùÍ∞Ä
            records.totalDays++;
            
            // Ïó∞ÏÜç Í∑ºÎ¨¥Ïùº Í≥ÑÏÇ∞
            if (lastDate) {
                const lastDateObj = new Date(lastDate);
                const currentDateObj = new Date(date);
                const dayDiff = Math.floor((currentDateObj - lastDateObj) / (1000 * 60 * 60 * 24));
                if (dayDiff === 1) {
                    currentStreak++;
                } else {
                    currentStreak = 1;
                }
            } else {
                currentStreak = 1;
            }
            
            if (currentStreak > records.maxConsecutiveDays) {
                records.maxConsecutiveDays = currentStreak;
            }
            lastDate = date;
            
            // ÌïòÎ£® ÏßëÍ≥Ñ Î≥ÄÏàò
            let dayMaxHtp = 0;
            let dayTotalQty = 0;
            let dayPerfect = true;
            let dayHasWork = dayRecords.length > 0;
            
            dayRecords.forEach(record => {
                const htp = parseFloat(record.htp) || 0;
                const qty = parseInt(record.qty) || 0;
                const processType = record.processType || '';
                const targetHtp = processType.includes('PICK') ? 90 : 180;
                
                htpHistory.push(htp);
                dayTotalQty += qty;
                
                if (htp > dayMaxHtp) dayMaxHtp = htp;
                if (htp > records.maxHtp) {
                    records.maxHtp = htp;
                    records.maxHtpDate = date;
                }
                
                if (htp < targetHtp) {
                    dayPerfect = false;
                    records.lowHtpCount++;
                }
                
                // Í≥µÏ†ïÎ≥Ñ ÏßëÍ≥Ñ
                if (processType.includes('PICK')) records.pickDays++;
                if (processType.includes('PACK')) records.packDays++;
            });
            
            // ÌïòÎ£® ÏßëÍ≥Ñ ÏôÑÎ£å
            if (dayHasWork) {
                records.totalQty += dayTotalQty;
                if (dayPerfect && dayMaxHtp > 0) {
                    records.perfectDays++;
                }
            }
        });
        
        // ÌèâÍ∑† HTP Í≥ÑÏÇ∞
        if (htpHistory.length > 0) {
            records.avgHtp = htpHistory.reduce((a, b) => a + b, 0) / htpHistory.length;
        }
        
        // ÎîîÎ≤ÑÍπÖ: ÏÇ¨ÏõêÎ≥Ñ records Ï∂úÎ†• (Ï≤òÏùå 3Î™ÖÎßå)
        if (Object.keys(employeeBadges).length < 3) {
            console.log(`  ${employeeName}:`, {
                maxHtp: records.maxHtp,
                totalDays: records.totalDays,
                avgHtp: records.avgHtp.toFixed(1),
                perfectDays: records.perfectDays,
                maxStreak: records.maxConsecutiveDays
            });
        }
        
        // Ï†ÑÎ¨∏ Í≥µÏ†ï ÌåêÎã®
        if (records.pickDays > records.packDays * 2) records.specialtyProcess = 'PICK';
        else if (records.packDays > records.pickDays * 2) records.specialtyProcess = 'PACK';
        
        // ========================================
        // üèÜ Î±ÉÏßÄ Î∂ÄÏó¨ ÏãúÏä§ÌÖú (Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ)
        // ========================================
        
        // === 1. HTP Í∏∞Î°ù Î±ÉÏßÄ (Performance Badges) ===
        if (records.maxHtp >= 600) {
            badges.push({ type: 'record', name: 'üíé Ï†ÑÏÑ§', desc: 'HTP 600+', level: 'legendary', icon: 'üíé' });
        } else if (records.maxHtp >= 500) {
            badges.push({ type: 'record', name: 'üèÜ ÎßàÏä§ÌÑ∞', desc: 'HTP 500+', level: 'gold', icon: 'üèÜ' });
        } else if (records.maxHtp >= 400) {
            badges.push({ type: 'record', name: '‚≠ê ÏóòÎ¶¨Ìä∏', desc: 'HTP 400+', level: 'silver', icon: '‚≠ê' });
        } else if (records.maxHtp >= 300) {
            badges.push({ type: 'record', name: 'üåü Í≥†Ïàò', desc: 'HTP 300+', level: 'bronze', icon: 'üåü' });
        } else if (records.maxHtp >= 200) {
            badges.push({ type: 'record', name: '‚ú® ÏàôÎ†®Ïûê', desc: 'HTP 200+', level: 'normal', icon: '‚ú®' });
        }
        
        // === 2. ÌèâÍ∑† HTP Î±ÉÏßÄ (Consistency Badges) ===
        if (records.avgHtp >= 400) {
            badges.push({ type: 'consistency', name: 'üéØ ÏôÑÎ≤ΩÏ£ºÏùòÏûê', desc: 'ÌèâÍ∑† HTP 400+', level: 'gold', icon: 'üéØ' });
        } else if (records.avgHtp >= 300) {
            badges.push({ type: 'consistency', name: 'üìä ÏïàÏ†ïÏ†Å', desc: 'ÌèâÍ∑† HTP 300+', level: 'silver', icon: 'üìä' });
        } else if (records.avgHtp >= 200) {
            badges.push({ type: 'consistency', name: 'üìà Íæ∏Ï§ÄÌï®', desc: 'ÌèâÍ∑† HTP 200+', level: 'bronze', icon: 'üìà' });
        }
        
        // === 3. Í∑ºÌÉú Î±ÉÏßÄ (Attendance Badges) ===
        if (records.totalDays >= 30) {
            badges.push({ type: 'attendance', name: 'üìÖ Í∞úÍ∑ºÏôï', desc: '30Ïùº Í∑ºÎ¨¥', level: 'gold', icon: 'üìÖ' });
        } else if (records.totalDays >= 20) {
            badges.push({ type: 'attendance', name: 'üìÜ ÏÑ±Ïã§Ìï®', desc: '20Ïùº Í∑ºÎ¨¥', level: 'silver', icon: 'üìÜ' });
        } else if (records.totalDays >= 10) {
            badges.push({ type: 'attendance', name: 'üóìÔ∏è Íæ∏Ï§ÄÌï®', desc: '10Ïùº Í∑ºÎ¨¥', level: 'bronze', icon: 'üóìÔ∏è' });
        }
        
        // === 4. Ïó∞ÏÜç Í∑ºÎ¨¥ Î±ÉÏßÄ (Streak Badges) ===
        if (records.maxConsecutiveDays >= 15) {
            badges.push({ type: 'streak', name: 'üî• Î∂àÌÉÄÎäî Ïó¥Ï†ï', desc: '15Ïùº Ïó∞ÏÜç', level: 'gold', icon: 'üî•' });
        } else if (records.maxConsecutiveDays >= 10) {
            badges.push({ type: 'streak', name: '‚ö° ÎÅàÍ∏∞Ïôï', desc: '10Ïùº Ïó∞ÏÜç', level: 'silver', icon: '‚ö°' });
        } else if (records.maxConsecutiveDays >= 5) {
            badges.push({ type: 'streak', name: 'üí™ ÏßëÏ§ëÎ†•', desc: '5Ïùº Ïó∞ÏÜç', level: 'bronze', icon: 'üí™' });
        }
        
        // === 5. ÏûëÏóÖÎüâ Î±ÉÏßÄ (Volume Badges) ===
        if (records.totalQty >= 50000) {
            badges.push({ type: 'volume', name: 'üéÅ Î¨ºÎüâÏôï', desc: 'Ï¥ù 50,000+', level: 'gold', icon: 'üéÅ' });
        } else if (records.totalQty >= 30000) {
            badges.push({ type: 'volume', name: 'üì¶ Îã§ÏûëÎü¨', desc: 'Ï¥ù 30,000+', level: 'silver', icon: 'üì¶' });
        } else if (records.totalQty >= 10000) {
            badges.push({ type: 'volume', name: 'üì¶ Ïó¥Ïã¨Ìûà', desc: 'Ï¥ù 10,000+', level: 'bronze', icon: 'üì¶' });
        }
        
        // === 6. ÏôÑÎ≤ΩÌïú ÎÇ† Î±ÉÏßÄ (Perfect Day Badges) ===
        const perfectRatio = records.totalDays > 0 ? (records.perfectDays / records.totalDays) : 0;
        if (perfectRatio >= 0.9 && records.totalDays >= 10) {
            badges.push({ type: 'perfect', name: 'üíØ ÌçºÌéôÌä∏', desc: 'Î™©Ìëú Îã¨ÏÑ± 90%+', level: 'gold', icon: 'üíØ' });
        } else if (perfectRatio >= 0.7 && records.totalDays >= 10) {
            badges.push({ type: 'perfect', name: '‚úÖ Ïö∞ÏàòÌï®', desc: 'Î™©Ìëú Îã¨ÏÑ± 70%+', level: 'silver', icon: '‚úÖ' });
        } else if (perfectRatio >= 0.5 && records.totalDays >= 10) {
            badges.push({ type: 'perfect', name: 'üëç ÏñëÌò∏Ìï®', desc: 'Î™©Ìëú Îã¨ÏÑ± 50%+', level: 'bronze', icon: 'üëç' });
        }
        
        // === 7. Ï†ÑÎ¨∏Í∞Ä Î±ÉÏßÄ (Specialist Badges) ===
        if (records.specialtyProcess === 'PICK' && records.pickDays >= 15) {
            badges.push({ type: 'specialist', name: 'üéØ PICK Ï†ÑÎ¨∏Í∞Ä', desc: 'PICK ÏßëÏ§ë', level: 'gold', icon: 'üéØ' });
        } else if (records.specialtyProcess === 'PACK' && records.packDays >= 15) {
            badges.push({ type: 'specialist', name: 'üì¶ PACK Ï†ÑÎ¨∏Í∞Ä', desc: 'PACK ÏßëÏ§ë', level: 'gold', icon: 'üì¶' });
        }
        
        // === 8. ÌäπÎ≥Ñ Î±ÉÏßÄ (Special Badges) ===
        // Ï¥àÎ≥¥Ïûê Î±ÉÏßÄ
        if (records.totalDays <= 3) {
            badges.push({ type: 'special', name: 'üå± Ïã†ÏûÖ', desc: 'Ï≤´ 3Ïùº', level: 'normal', icon: 'üå±' });
        }
        
        // Ïò¨ÎùºÏö¥Îçî Î±ÉÏßÄ (PICK & PACK Í∑†Ìòï)
        if (records.pickDays >= 10 && records.packDays >= 10) {
            const ratio = Math.min(records.pickDays, records.packDays) / Math.max(records.pickDays, records.packDays);
            if (ratio >= 0.7) {
                badges.push({ type: 'special', name: 'üé≠ Ïò¨ÎùºÏö¥Îçî', desc: 'PICK & PACK Í∑†Ìòï', level: 'gold', icon: 'üé≠' });
            }
        }
        
        // ÏÑ±Ïû• Î±ÉÏßÄ (ÏµúÍ∑º ÏÑ±Ï†Å Ìñ•ÏÉÅ)
        if (htpHistory.length >= 10) {
            const firstHalf = htpHistory.slice(0, htpHistory.length / 2);
            const secondHalf = htpHistory.slice(htpHistory.length / 2);
            const avgFirst = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
            const avgSecond = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
            const improvement = ((avgSecond - avgFirst) / avgFirst) * 100;
            
            if (improvement >= 30) {
                badges.push({ type: 'special', name: 'üöÄ Í∏âÏÑ±Ïû•', desc: 'ÏÑ±Ï†Å 30%+ Ìñ•ÏÉÅ', level: 'gold', icon: 'üöÄ' });
            } else if (improvement >= 15) {
                badges.push({ type: 'special', name: 'üìà ÏÑ±Ïû•ÏÑ∏', desc: 'ÏÑ±Ï†Å 15%+ Ìñ•ÏÉÅ', level: 'silver', icon: 'üìà' });
            }
        }
        
        // ÏµúÍ≥† Í∏∞Î°ù Î≥¥Ïú†Ïûê (Ï†ÑÏ≤¥ 1Îì± HTP)
        // Ïù¥Í±¥ ÎÇòÏ§ëÏóê Ï†ÑÏ≤¥ ÎπÑÍµêÌï¥ÏÑú Î∂ÄÏó¨
        
        // === 9. Ïû¨ÎØ∏ Î±ÉÏßÄ (Fun Badges) ===
        // ÏïÑÏπ®Ìòï Ïù∏Í∞Ñ / Ïò¨ÎπºÎØ∏ (ÏãúÍ∞ÑÎåÄ Î∂ÑÏÑùÏùÄ Î≥µÏû°ÌïòÎØÄÎ°ú ÏÉùÎûµ)
        
        // ÌñâÏö¥Ïùò Ïà´Ïûê (HTPÏóê 7Ïù¥ Îì§Ïñ¥Í∞ÄÎäî Í≤ΩÏö∞)
        if (records.maxHtp.toString().includes('7')) {
            badges.push({ type: 'fun', name: 'üçÄ ÌñâÏö¥Ïùò 7', desc: 'HTPÏóê 7 Ìè¨Ìï®', level: 'normal', icon: 'üçÄ' });
        }
        
        // === 10. Î∂ÄÏ†ïÏ†Å Î±ÉÏßÄ (Improvement Needed) ===
        // ÎÑàÎ¨¥ Î∂ÄÏ†ïÏ†ÅÏù¥ÎØÄÎ°ú Ï£ºÏÑù Ï≤òÎ¶¨
        /*
        if (records.lowHtpCount > records.totalDays * 0.5) {
            badges.push({ type: 'warning', name: '‚ö†Ô∏è Í∞úÏÑ† ÌïÑÏöî', desc: 'Ï†ÄÌö®Ïú® ÎßéÏùå', level: 'warning', icon: '‚ö†Ô∏è' });
        }
        */
        
        employeeBadges[employeeName] = { badges, records };
    });
    
    // === Ï†ÑÏ≤¥ ÏàúÏúÑ Í∏∞Î∞ò Î±ÉÏßÄ Î∂ÄÏó¨ ===
    // ÏµúÍ≥† HTP Î≥¥Ïú†Ïûê Ï∞æÍ∏∞
    let maxHtpOverall = 0;
    let maxHtpEmployee = null;
    Object.keys(employeeBadges).forEach(emp => {
        const empBadges = employeeBadges[emp];
        if (empBadges.records.maxHtp > maxHtpOverall) {
            maxHtpOverall = empBadges.records.maxHtp;
            maxHtpEmployee = emp;
        }
    });
    
    if (maxHtpEmployee && employeeBadges[maxHtpEmployee]) {
        employeeBadges[maxHtpEmployee].badges.unshift({ 
            type: 'champion', 
            name: 'üëë Ï±îÌîºÏñ∏', 
            desc: `ÏµúÍ≥† HTP ${maxHtpOverall.toFixed(0)}`, 
            level: 'legendary', 
            icon: 'üëë' 
        });
    }
    
    console.log(`‚úÖ Î±ÉÏßÄ Í≥ÑÏÇ∞ ÏôÑÎ£å! (Ï¥ù ${Object.keys(employeeBadges).length}Î™Ö)`);
}

    // --- Event Listeners ---
    function toggleMobileSidebar() {
        const isOpen = ui.sidebar.classList.toggle('open');
        ui.sidebarOverlay.classList.toggle('hidden', !isOpen);
    }
    function toggleDesktopSidebar() {
        ui.appContainer.classList.toggle('sidebar-collapsed');
    }

    ui.sidebarToggleMobile.addEventListener('click', toggleMobileSidebar);
    ui.sidebarToggleDesktop.addEventListener('click', toggleDesktopSidebar);
    ui.sidebarOverlay.addEventListener('click', toggleMobileSidebar);

    const themeToggleBtn = document.getElementById('theme-toggle');
    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', toggleTheme);
    }

    ui.fileUpload.addEventListener('change', handleFileUpload);
    // ‚ö° DEBOUNCED: Í≤ÄÏÉâ ÏûÖÎ†•
    let searchDebounceTimer;
    ui.searchInput.addEventListener('input', (e) => {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            state.filters.search = e.target.value.toLowerCase();
            applyFiltersAndRender();
        }, 300); // 300ms ÎîîÎ∞îÏö¥Ïä§
    });
    // ‚ö° DEBOUNCED: ÌïÑÌÑ∞ ÌÜ†Í∏Ä
    let filterDebounceTimer;
    ui.lowHtpToggle.addEventListener('change', (e) => {
        clearTimeout(filterDebounceTimer);
        filterDebounceTimer = setTimeout(() => {
            state.filters.lowHtp = e.target.checked;
            applyFiltersAndRender();
        }, 100); // 100ms ÎîîÎ∞îÏö¥Ïä§
    });
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            state.filters.process = e.currentTarget.id.replace('filter-', '');
            applyFiltersAndRender();
        });
    });
    ui.captureBtn.addEventListener('click', captureTable);
    ui.exportBtn.addEventListener('click', exportToExcel);
    ui.tableHeader.addEventListener('click', (e) => {
        const headerCell = e.target.closest('.sortable');
        if (!headerCell) return;
        const sortKey = headerCell.dataset.sortKey;
        if (state.sort.key === sortKey) {
            if (state.sort.direction === 'asc') state.sort.direction = 'desc';
            else if (state.sort.direction === 'desc') { state.sort.key = 'htp'; state.sort.direction = 'asc'; }
        } else {
            state.sort.key = sortKey;
            state.sort.direction = 'asc';
        }
        applyFiltersAndRender();
    });

    // View Switcher
    ui.tableViewBtn.addEventListener('click', () => switchView('table'));
    ui.dashboardViewBtn.addEventListener('click', () => switchView('dashboard'));
    ui.historyViewBtn.addEventListener('click', () => switchView('history'));
    ui.calendarViewBtn.addEventListener('click', () => switchView('calendar'));
    ui.rankingViewBtn.addEventListener('click', () => switchView('ranking'));

    function switchView(viewName) {
        ui.tableView.classList.add('hidden');
        ui.dashboardView.classList.add('hidden');
        ui.historyView.classList.add('hidden');
        ui.calendarView.classList.add('hidden');
        ui.rankingView.classList.add('hidden');
        
        ui.tableViewBtn.classList.remove('active');
        ui.dashboardViewBtn.classList.remove('active');
        ui.historyViewBtn.classList.remove('active');
        ui.calendarViewBtn.classList.remove('active');
        ui.rankingViewBtn.classList.remove('active');
        
        switch(viewName) {
            case 'table':
                ui.tableView.classList.remove('hidden');
                ui.tableViewBtn.classList.add('active');
                break;
            case 'dashboard':
                ui.dashboardView.classList.remove('hidden');
                ui.dashboardView.classList.add('flex');
                ui.dashboardViewBtn.classList.add('active');
                break;
            case 'history':
                ui.historyView.classList.remove('hidden');
                ui.historyView.classList.add('flex');
                ui.historyViewBtn.classList.add('active');
                // ‚ö° LAZY LOAD: ÌûàÏä§ÌÜ†Î¶¨ ÌÉ≠ ÌÅ¥Î¶≠ ÏãúÏóêÎßå Î°úÎìú
                if (!isHistoryLoaded && !isLoadingHistory) {
                    loadHistoryData().then(() => {
                        ensureBadgesCalculated();
                        renderHistoryView();
                    });
                } else {
                    ensureBadgesCalculated();
                    renderHistoryView();
                }
                break;
            case 'calendar':
                ui.calendarView.classList.remove('hidden');
                ui.calendarView.classList.add('flex');
                ui.calendarViewBtn.classList.add('active');
                renderCalendarView();
                break;
            case 'ranking':
                ui.rankingView.classList.remove('hidden');
                ui.rankingView.classList.add('flex');
                ui.rankingViewBtn.classList.add('active');
                ensureBadgesCalculated(); // üÜï Î±ÉÏßÄ ÌïÑÏöî Ïãú Í≥ÑÏÇ∞
                renderRankingView();
                break;
        }
    }

    // History Period Selectors
    ui.periodWeekBtn.addEventListener('click', () => {
        setHistoryPeriod('week');
        ui.customDateRange.classList.add('hidden');
    });
    ui.periodMonthBtn.addEventListener('click', () => {
        setHistoryPeriod('month');
        ui.customDateRange.classList.add('hidden');
    });
    ui.periodAllBtn.addEventListener('click', () => {
        setHistoryPeriod('all');
        ui.customDateRange.classList.add('hidden');
    });
    ui.periodCustomBtn.addEventListener('click', () => {
        ui.customDateRange.classList.remove('hidden');
        document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
        ui.periodCustomBtn.classList.add('active');
    });
    ui.applyCustomRange.addEventListener('click', () => {
        const start = ui.startDate.value;
        const end = ui.endDate.value;
        if (start && end) {
            state.historyPeriod = 'custom';
            state.historyDateRange = { start, end };
            renderHistoryView();
        } else {
            showModal('ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùºÏùÑ Î™®Îëê ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        }
    });

    function setHistoryPeriod(period) {
        state.historyPeriod = period;
        document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
        if (period === 'week') ui.periodWeekBtn.classList.add('active');
        else if (period === 'month') ui.periodMonthBtn.classList.add('active');
        else if (period === 'all') ui.periodAllBtn.classList.add('active');
        renderHistoryView();
    }

    ui.exportHistoryExcel.addEventListener('click', exportHistoryToExcel);
    ui.exportHistoryPdf.addEventListener('click', exportHistoryToPDF);

    ui.calendarPrevMonth.addEventListener('click', () => {
        state.calendarCurrentMonth.setMonth(state.calendarCurrentMonth.getMonth() - 1);
        renderCalendarView();
    });
    ui.calendarNextMonth.addEventListener('click', () => {
        state.calendarCurrentMonth.setMonth(state.calendarCurrentMonth.getMonth() + 1);
        renderCalendarView();
    });

    ui.rankingDaily.addEventListener('click', () => setRankingPeriod('daily'));
    ui.rankingWeekly.addEventListener('click', () => setRankingPeriod('weekly'));
    ui.rankingMonthly.addEventListener('click', () => setRankingPeriod('monthly'));
    ui.rankingAllTime.addEventListener('click', () => setRankingPeriod('all-time'));

    function setRankingPeriod(period) {
        state.rankingPeriod = period;
        document.querySelectorAll('#ranking-daily, #ranking-weekly, #ranking-monthly, #ranking-all-time').forEach(btn => btn.classList.remove('active'));
        if (period === 'daily') ui.rankingDaily.classList.add('active');
        else if (period === 'weekly') ui.rankingWeekly.classList.add('active');
        else if (period === 'monthly') ui.rankingMonthly.classList.add('active');
        else if (period === 'all-time') ui.rankingAllTime.classList.add('active');
        renderRankingView();
    }

    ui.rankingPickType.addEventListener('click', () => setRankingProcessType('pick'));
    ui.rankingPackType.addEventListener('click', () => setRankingProcessType('pack'));

    function setRankingProcessType(type) {
        state.rankingProcessType = type;
        document.querySelectorAll('#ranking-pick-type, #ranking-pack-type').forEach(btn => btn.classList.remove('active'));
        if (type === 'pick') ui.rankingPickType.classList.add('active');
        else ui.rankingPackType.classList.add('active');
        renderRankingView();
    }

    ui.manageHiddenBtn.addEventListener('click', () => {
        if (ui.hiddenEmployeesList.classList.contains('hidden')) {
            ui.hiddenEmployeesList.classList.remove('hidden');
            renderHiddenEmployeesList();
        } else {
            ui.hiddenEmployeesList.classList.add('hidden');
        }
    });

    function renderHiddenEmployeesList() {
        ui.hiddenEmployeesList.innerHTML = '';
        
        if (hiddenEmployees.size === 0) {
            ui.hiddenEmployeesList.innerHTML = '<p class="text-sm text-gray-400 mb-2">Ïà®Í∏¥ ÏûëÏóÖÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            return;
        }

        hiddenEmployees.forEach(employeeName => {
            const item = document.createElement('div');
            item.className = 'hidden-employee-item';
            item.innerHTML = `
                <span class="font-semibold text-white text-sm">${employeeName.split('(')[0].trim()}</span>
                <button class="show-employee-btn-small" data-employee="${employeeName}">Î≥µÍµ¨</button>
            `;
            ui.hiddenEmployeesList.appendChild(item);
        });

        ui.hiddenEmployeesList.querySelectorAll('.show-employee-btn-small').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const employeeName = e.target.dataset.employee;
                toggleHiddenEmployee(employeeName);
                renderHiddenEmployeesList();
            });
        });
    }

    ui.hiddenEmployeesModalClose.addEventListener('click', () => {
        ui.hiddenEmployeesModalBackdrop.classList.add('hidden');
        ui.hiddenEmployeesModalBackdrop.classList.remove('flex');
    });

    ui.employeeDetailClose.addEventListener('click', () => {
        ui.employeeDetailModalBackdrop.classList.add('hidden');
        ui.employeeDetailModalBackdrop.classList.remove('flex');
    });

    ui.calendarDetailClose.addEventListener('click', () => {
        ui.calendarDetailModalBackdrop.classList.add('hidden');
        ui.calendarDetailModalBackdrop.classList.remove('flex');
    });

    ui.tableBody.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row || row.id === 'placeholder-row') return;
        
        if (e.target.closest('.hide-employee-btn') || e.target.closest('.show-employee-btn')) {
            const btn = e.target.closest('.hide-employee-btn') || e.target.closest('.show-employee-btn');
            const employeeName = btn.dataset.employee;
            toggleHiddenEmployee(employeeName);
            return;
        }

        const employeeCell = row.querySelector('td:nth-child(2)');
        const processCell = row.querySelector('td:nth-child(1)');
        if(employeeCell && processCell) {
            const employeeName = employeeCell.textContent.replace(/[üëëüî•üê¢ü•áü•àü•â]\s*/g, '').trim();
            const processType = processCell.textContent;
            showIndividualTrend(employeeName, processType);
        }
    });
    
    ui.chartModalClose.addEventListener('click', () => {
        ui.chartModalBackdrop.classList.add('hidden');
        ui.chartModalBackdrop.classList.remove('flex');
    });
    ui.chartModalBackdrop.addEventListener('click', (e) => {
        if (e.target === ui.chartModalBackdrop) {
            ui.chartModalBackdrop.classList.add('hidden');
            ui.chartModalBackdrop.classList.remove('flex');
        }
    });

    // --- Helper Functions ---
    function getPackType(location, processTask, processPathName) {
        if (processTask === 'PACK(PACKING)' && processPathName.includes('AGV_Multi_Autobag4.0') && location.startsWith('Pack at Rebin (Test')) return "Ïò§ÌÜ†Î∞± Î©ÄÌã∞";
        if (typeof location !== 'string') return DEFAULT_PACK_TYPE;
        for (const [name, prefix] of Object.entries(PACK_TYPE_MAP)) {
            if (location.startsWith(prefix)) return name;
        }
        return DEFAULT_PACK_TYPE;
    }

    function getTargetHtp(item) {
    if (item.processType.includes('PICK')) return targetHtpValues['PICK'] || 0;
    if (item.processType.includes('PACK')) {
        const processPathName = item.processPathName || "";
        
        // üÜï ÌÇ§ÏõåÎìú Í∏∏Ïù¥ Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨ (Í∏¥ Í≤É = Íµ¨Ï≤¥Ï†ÅÏù∏ Í≤É Ïö∞ÏÑ†)
        const sortedConfigs = Object.entries(TARGET_HTP_DEFAULTS)
            .filter(([name]) => name !== "PICK")
            .sort(([, a], [, b]) => {
                const maxLenA = Math.max(...a.keywords.map(k => k.length), 0);
                const maxLenB = Math.max(...b.keywords.map(k => k.length), 0);
                return maxLenB - maxLenA; // ÎÇ¥Î¶ºÏ∞®Ïàú (Í∏¥ Í≤É Ïö∞ÏÑ†)
            });
        
        // Í∞ÄÏû• Íµ¨Ï≤¥Ï†ÅÏù∏(Í∏¥) ÌÇ§ÏõåÎìúÎ∂ÄÌÑ∞ Îß§Ïπ≠ ÏãúÎèÑ
        for (const [name, config] of sortedConfigs) {
            if (config.keywords.some(keyword => processPathName.includes(keyword))) {
                return targetHtpValues[name] || 0;
            }
        }
        
        return targetHtpValues["Manual SINGULATION"] || 0;
    }
    return 0;
}

    function parseExcelData(data) {
        if (data.length < 2) return [];
        const headers = data[0].map(h => h ? h.toString().toLowerCase().trim() : '');
        const COLS_TO_LOAD = {
            workDate: 'work date', employee: 'employee', unitQty: 'unit qty', location: 'location', floor: 'floor',
            processPathName: 'process path name', htpStart: 'htp start', htpEnd: 'htp end', processTask: 'process(task)',
            contractType: 'contract type'
        };
        const colIndices = {};
        const missingCols = [];
        for (const key in COLS_TO_LOAD) {
            const index = headers.indexOf(COLS_TO_LOAD[key]);
            if (index === -1 && key !== 'contractType') missingCols.push(COLS_TO_LOAD[key]);
            colIndices[key] = index;
        }
        if (missingCols.length > 0) throw new Error(`ÏóëÏÖÄ ÌååÏùºÏóê Îã§Ïùå ÌïÑÏàò Ïª¨ÎüºÏù¥ ÏóÜÏäµÎãàÎã§:\n[${missingCols.join(', ')}]`);

        const rawData = data.slice(1).map(row => {
            const combineDateTime = (dateValue, timeValue) => {
                if (!dateValue || !timeValue) return null;
                let datePart = (typeof dateValue === 'number') ? new Date(Date.UTC(1899, 11, 30) + dateValue * 24 * 60 * 60 * 1000) : new Date(dateValue);
                if (isNaN(datePart.getTime())) return null;
                let timePart;
                if (typeof timeValue === 'number') timePart = new Date(Date.UTC(1899, 11, 30) + timeValue * 24 * 60 * 60 * 1000);
                else if (typeof timeValue === 'string') {
                    const parts = timeValue.split(':');
                    timePart = new Date(0);
                    timePart.setUTCHours(parts[0] || 0, parts[1] || 0, parts[2] || 0, 0);
                } else timePart = timeValue;
                if (isNaN(timePart.getTime())) return null;
                return new Date(Date.UTC(datePart.getUTCFullYear(), datePart.getUTCMonth(), datePart.getUTCDate(), timePart.getUTCHours(), timePart.getUTCMinutes(), timePart.getUTCSeconds()));
            };
            const htpStart = combineDateTime(row[colIndices.workDate], row[colIndices.htpStart]);
            const htpEnd = combineDateTime(row[colIndices.workDate], row[colIndices.htpEnd]);
            if (!htpStart || !htpEnd) return null;
            const durationSeconds = (htpEnd - htpStart) / 1000;
            if (durationSeconds <= 0) return null;
            let processTask = row[colIndices.processTask] || '';
            const location = row[colIndices.location] || '';
            const processPathName = row[colIndices.processPathName] || '';
            if (processTask === 'REBIN(REBIN)' && location.startsWith('Pack at Rebin (Test') && processPathName === '0. AGV_Multi_Autobag4.0 + ÏùºÎ∞òÏ°¥ ÌÜµÌï©') processTask = 'PACK(PACKING)';
            return {
                employee: row[colIndices.employee] || '', unitQty: parseInt(row[colIndices.unitQty] || 0),
                location: location, floor: row[colIndices.floor] || '',
                processPathName: processPathName, processTask: processTask,
                contractType: colIndices.contractType !== -1 ? (row[colIndices.contractType] || '').toUpperCase() : '',
                htpStart: htpStart, htpEnd: htpEnd
            };
        }).filter(item => {
            if (!item || !item.employee || item.unitQty <= 0) return false;
            if (item.employee === 'AGV_Agent') return false;
            return item.processTask === 'PICK(PICKING)' || item.processTask === 'PACK(PACKING)';
        });
        return rawData;
    }

    function aggregateData(rawData) {
        const aggregatedMap = new Map();
        rawData.forEach(item => {
            let key, packType = null;
            if (item.processTask === 'PICK(PICKING)') {
                key = `${item.employee}|${item.processPathName}|${item.floor}|PICK`;
                packType = 'ÏßëÌíà';
            } else {
                packType = getPackType(item.location, item.processTask, item.processPathName);
                key = `${item.employee}|${packType}|PACK`;
            }
            const durationSeconds = (item.htpEnd - item.htpStart) / 1000;
            if (durationSeconds <= 0) return;
            if (!aggregatedMap.has(key)) {
                const empIdMatch = item.employee.match(/\((.*?)\)/);
                const empId = empIdMatch ? empIdMatch[1] : '';
                aggregatedMap.set(key, {
                    processType: item.processTask.includes('PICK') ? 'PICK(ÏßëÌíà)' : 'PACK(Ìè¨Ïû•)',
                    employee: item.employee, floor: item.floor, unitQty: 0, totalSeconds: 0,
                    location: item.location, processPathName: item.processPathName, packType: packType,
                    isManager: MANAGERS_LIST.includes(empId), isPerm: item.contractType === 'PERM'
                });
            }
            const group = aggregatedMap.get(key);
            group.unitQty += item.unitQty;
            group.totalSeconds += durationSeconds;
            group.location = item.location;
            group.processPathName = item.processPathName;
            group.floor = item.floor;
        });
        const finalData = [];
        for (const group of aggregatedMap.values()) {
            const mh = group.totalSeconds > 0 ? group.totalSeconds / 3600 : 0;
            if (mh >= 0.25 && group.unitQty >= 30) {
                finalData.push({ ...group, mh: mh.toFixed(4), htp: (mh > 0 ? group.unitQty / mh : 0).toFixed(1) });
            }
        }
        
        // üîç ÎîîÎ≤ÑÍπÖ: isPerm Î∞è isManager ÌôïÏù∏
        console.log('üìä Contract Type ÎîîÎ≤ÑÍπÖ:');
        const sample = finalData.slice(0, 5);
        sample.forEach(item => {
            console.log(`  ${item.employee}: isPerm=${item.isPerm}, isManager=${item.isManager}`);
        });
        
        const permCount = finalData.filter(d => d.isPerm).length;
        const managerCount = finalData.filter(d => d.isManager).length;
        console.log(`‚úÖ PERM: ${permCount}/${finalData.length}, Í¥ÄÎ¶¨Ïûê: ${managerCount}/${finalData.length}`);
        
        return finalData;
    }

    function initializeFiltersFromData(rawData) {
        const allPackTypes = new Set();
        const floors = new Set();
        rawData.forEach(item => {
            if(item.processTask.includes('PICK')) {
                if(item.floor) floors.add(item.floor);
            } else if (item.processTask.includes('PACK')) {
                allPackTypes.add(getPackType(item.location, item.processTask, item.processPathName));
            }
        });
        createFilterCheckboxes(ui.packTypeFilters, Array.from(allPackTypes).sort(), 'packTypes', 'packtypes');
        createFilterCheckboxes(ui.floorFilters, Array.from(floors).sort(), 'floors', 'floors');
        createTimeFilters();
        createTargetHtpSettings();
    }

    function createTimeFilters() {
        const allHoursCheckbox = document.getElementById('all-hours-checkbox');
        ui.hourFilters.innerHTML = '';
        for (let i = 0; i < 24; i++) {
            const hour = i.toString().padStart(2, '0');
            
            // Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï≤¥ÌÅ¨Î∞ïÏä§Î°ú Î≥ÄÍ≤Ω
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'hour-filter-btn text-xs font-bold py-2 px-1 rounded-lg transition-all duration-200 bg-gray-700 hover:bg-gray-600 text-gray-300 border-2 border-gray-600';
            button.dataset.hour = i;
            button.textContent = hour;
            
            button.addEventListener('click', (e) => {
                const hourVal = parseInt(e.currentTarget.dataset.hour);
                const isActive = state.filters.hours.has(hourVal);
                
                if (isActive) {
                    state.filters.hours.delete(hourVal);
                    e.currentTarget.classList.remove('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    e.currentTarget.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300');
                } else {
                    state.filters.hours.add(hourVal);
                    e.currentTarget.classList.remove('bg-gray-700', 'border-gray-600', 'text-gray-300');
                    e.currentTarget.classList.add('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    allHoursCheckbox.checked = false;
                }
                
                if (state.filters.hours.size === 0) allHoursCheckbox.checked = true;
                applyFiltersAndRender();
            });
            
            ui.hourFilters.appendChild(button);
        }
        
        allHoursCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                document.querySelectorAll('.hour-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    btn.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300');
                });
                state.filters.hours.clear();
                applyFiltersAndRender();
            }
        });
        
        // DAY Ï°∞ ÏÑ†ÌÉù Î≤ÑÌäº (09Ïãú-18Ïãú)
        document.getElementById('select-day-shift').addEventListener('click', () => {
            allHoursCheckbox.checked = false;
            state.filters.hours.clear();
            document.querySelectorAll('.hour-filter-btn').forEach(btn => {
                const hour = parseInt(btn.dataset.hour);
                if (hour >= 9 && hour <= 18) {
                    btn.classList.remove('bg-gray-700', 'border-gray-600', 'text-gray-300');
                    btn.classList.add('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    state.filters.hours.add(hour);
                } else {
                    btn.classList.remove('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    btn.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300');
                }
            });
            applyFiltersAndRender();
        });
        
        // SWING Ï°∞ ÏÑ†ÌÉù Î≤ÑÌäº (19Ïãú-08Ïãú)
        document.getElementById('select-swing-shift').addEventListener('click', () => {
            allHoursCheckbox.checked = false;
            state.filters.hours.clear();
            document.querySelectorAll('.hour-filter-btn').forEach(btn => {
                const hour = parseInt(btn.dataset.hour);
                if (hour >= 19 || hour <= 8) {
                    btn.classList.remove('bg-gray-700', 'border-gray-600', 'text-gray-300');
                    btn.classList.add('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    state.filters.hours.add(hour);
                } else {
                    btn.classList.remove('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                    btn.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300');
                }
            });
            applyFiltersAndRender();
        });
        
        document.getElementById('select-all-hours').addEventListener('click', () => {
            allHoursCheckbox.checked = false;
            document.querySelectorAll('.hour-filter-btn').forEach(btn => {
                const hour = parseInt(btn.dataset.hour);
                btn.classList.remove('bg-gray-700', 'border-gray-600', 'text-gray-300');
                btn.classList.add('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                state.filters.hours.add(hour);
            });
            applyFiltersAndRender();
        });
        
        document.getElementById('deselect-all-hours').addEventListener('click', () => {
            allHoursCheckbox.checked = true;
            document.querySelectorAll('.hour-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'border-blue-400', 'text-white', 'shadow-lg', 'scale-110');
                btn.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300');
            });
            state.filters.hours.clear();
            applyFiltersAndRender();
        });
    }

    function createFilterCheckboxes(container, items, filterType, type) {
        // ‚ö° OPTIMIZED: DocumentFragmentÎ°ú Î¶¨ÌîåÎ°úÏö∞ ÏµúÏÜåÌôî
        container.innerHTML = '';
        const fragment = document.createDocumentFragment();
        
        items.forEach(item => {
            const label = document.createElement('label');
            label.className = 'flex items-center gap-3 text-sm cursor-pointer bg-gray-800 bg-opacity-40 px-3 py-2.5 rounded-lg hover:bg-opacity-60 transition-all border border-transparent hover:border-gray-500';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox'; checkbox.value = item;
            checkbox.className = `form-checkbox ${type}-checkbox w-5 h-5 rounded border-2 border-gray-500 text-blue-500 focus:ring-2 focus:ring-blue-400`;
            checkbox.addEventListener('change', (e) => {
                if (e.target.checked) state.filters[filterType].add(item);
                else state.filters[filterType].delete(item);
                applyFiltersAndRender();
            });
            label.appendChild(checkbox);
            const text = document.createElement('span');
            text.textContent = item;
            text.className = 'font-bold text-white';
            label.appendChild(text);
            fragment.appendChild(label); // ‚ö° fragmentÏóê Ï∂îÍ∞Ä
        });
        
        // ‚ö° Ìïú Î≤àÏóê DOMÏóê Ï∂îÍ∞Ä (Î¶¨ÌîåÎ°úÏö∞ 1ÌöåÎßå)
        container.appendChild(fragment);
        
        const selectAllBtn = document.getElementById(`select-all-${type}`);
        const deselectAllBtn = document.getElementById(`deselect-all-${type}`);
        if (selectAllBtn && deselectAllBtn) {
            selectAllBtn.onclick = () => {
                container.querySelectorAll('input').forEach(cb => { cb.checked = true; state.filters[filterType].add(cb.value); });
                applyFiltersAndRender();
            };
            deselectAllBtn.onclick = () => {
                container.querySelectorAll('input').forEach(cb => { cb.checked = false; state.filters[filterType].delete(cb.value); });
                applyFiltersAndRender();
            };
        }
    }

    function createTargetHtpSettings() {
        ui.targetHtpSettings.innerHTML = '';
        for (const key in TARGET_HTP_DEFAULTS) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between';
            const label = document.createElement('label');
            label.textContent = key + ':';
            const input = document.createElement('input');
            input.type = 'number';
            input.value = targetHtpValues[key];
            input.className = 'w-20 rounded-md py-1 px-2 text-sm text-right';
            input.addEventListener('change', (e) => {
                targetHtpValues[key] = parseFloat(e.target.value) || 0;
                applyFiltersAndRender();
            });
            div.appendChild(label);
            div.appendChild(input);
            ui.targetHtpSettings.appendChild(div);
        }
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showLoader();
        showLoadingProgress('ÌååÏùº ÏóÖÎ°úÎìú Ï§ë...');
        updateLoadingProgress(10, 'ÌååÏùº ÏùΩÎäî Ï§ë...');
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                updateLoadingProgress(30, 'ÏóëÏÖÄ ÌååÏã± Ï§ë...');
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                updateLoadingProgress(50, 'Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ï§ë...');
                const parsedData = parseExcelData(jsonData);
                
                updateLoadingProgress(70, 'Firebase ÏóÖÎ°úÎìú Ï§ë...');
                await saveDataToFirestore(parsedData);
                
            } catch (error) {
                console.error("ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò:", error);
                showModal(error.message || "ÌååÏùºÏùÑ Ï≤òÎ¶¨ÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                hideLoader();
                hideLoadingProgress();
            }
        };
        reader.onerror = (error) => { 
            console.error("ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò:", error); 
            showModal("ÌååÏùºÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."); 
            hideLoader(); 
            hideLoadingProgress();
        };
        reader.readAsArrayBuffer(file);
    }

    async function saveDataToFirestore(data) {
        try {
            updateLoadingProgress(80, 'Îç∞Ïù¥ÌÑ∞ ÏïïÏ∂ï Ï§ë...');
            const serializableData = data.map(item => ({ ...item, htpStart: item.htpStart.toISOString(), htpEnd: item.htpEnd.toISOString() }));
            const jsonString = JSON.stringify(serializableData);
            const compressedData = pako.gzip(jsonString);
            const compressedBytes = Bytes.fromUint8Array(compressedData);
            const payload = { compressedData: compressedBytes, uploaderId: userId, timestamp: new Date().toISOString() };
            
            updateLoadingProgress(90, 'FirebaseÏóê Ï†ÄÏû• Ï§ë...');
            await setDoc(dataDocRef, payload);
            
            const today = new Date().toISOString().split('T')[0];
            const historyDocRef = doc(historyCollectionRef, today);
            const historyPayload = { 
                compressedData: compressedBytes, 
                uploaderId: userId, 
                timestamp: new Date().toISOString(),
                date: today
            };
            await setDoc(historyDocRef, historyPayload);
            
            updateLoadingProgress(100, 'ÏóÖÎ°úÎìú ÏôÑÎ£å!');
            showModal('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§!');
            
            await loadHistoryData();
            
            // Î±ÉÏßÄ Í≥ÑÏÇ∞ (ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏóàÏúºÎØÄÎ°ú)
            console.log('üèÖ ÏóëÏÖÄ ÏóÖÎ°úÎìú ÏôÑÎ£å - Î±ÉÏßÄ Í≥ÑÏÇ∞ ÌôïÏù∏');
            ensureBadgesCalculated();
            
        } catch (error) {
            console.error("Firestore Ï†ÄÏû• Ïò§Î•ò:", error);
            showModal("Îç∞Ïù¥ÌÑ∞Î•º ÏÑúÎ≤ÑÏóê Ï†ÄÏû•ÌïòÎäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            hideLoader();
            hideLoadingProgress();
        } finally {
            setTimeout(() => hideLoadingProgress(), 1000);
        }
    }

    function applyFiltersAndRender() {
        if (globalRawData.length === 0) {
            renderTable([]);
            updateDashboard([], []);
            return;
        }
        
        // ‚ö° OPTIMIZED: ÎπÑÎèôÍ∏∞ Î†åÎçîÎßÅ
        requestIdleCallback(() => {
            let timeFilteredRawData = [...globalRawData];
            if (state.filters.hours.size > 0) {
                timeFilteredRawData = timeFilteredRawData.filter(item => state.filters.hours.has(item.htpStart.getUTCHours()));
            }
            let aggregatedData = aggregateData(timeFilteredRawData);
            let displayFilteredData = aggregatedData;
            if (state.filters.process === 'pick') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PICK(ÏßëÌíà)');
            else if (state.filters.process === 'pack') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PACK(Ìè¨Ïû•)');
            if (state.filters.search) displayFilteredData = displayFilteredData.filter(item => item.employee.toLowerCase().includes(state.filters.search));
            if (state.filters.lowHtp) displayFilteredData = displayFilteredData.filter(item => parseFloat(item.htp) < getTargetHtp(item));
            let finalDisplayData = displayFilteredData;
            if (state.filters.floors.size > 0 && state.filters.packTypes.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => 
                    (item.processType.includes('PICK') && state.filters.floors.has(item.floor)) ||
                    (item.processType.includes('PACK') && state.filters.packTypes.has(item.packType))
                );
            } else if (state.filters.floors.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => item.processType.includes('PICK') && state.filters.floors.has(item.floor));
            } else if (state.filters.packTypes.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => item.processType.includes('PACK') && state.filters.packTypes.has(item.packType));
            }
            if (state.sort.key && state.sort.direction) {
                const numericKeys = ['unitQty', 'mh', 'htp'];
                finalDisplayData.sort((a, b) => {
                    const key = state.sort.key;
                    const valA = a[key], valB = b[key];
                    let compareResult;
                    if (numericKeys.includes(key)) compareResult = parseFloat(valA) - parseFloat(valB);
                    else compareResult = (valA || '').toString().localeCompare((valB || '').toString());
                    return state.sort.direction === 'asc' ? compareResult : -compareResult;
                });
            }
            renderTable(finalDisplayData);
            updateDashboard(finalDisplayData, timeFilteredRawData);
            updateColumnVisibility(finalDisplayData);
            updateStats(finalDisplayData);
            updateTicker(finalDisplayData);
            updateSortIndicators();
        });
    }
	
	function renderTable(data) {
        // ‚ö° OPTIMIZED: Ï≤≠ÌÅ¨ Î†åÎçîÎßÅ (100Í∞úÏî©)
        ui.tableBody.innerHTML = '';
        if (data.length === 0) {
            ui.tableBody.appendChild(ui.placeholderRow);
            ui.placeholderRow.classList.remove('hidden');
            updateStats([]);
            updateTicker([]);
            return;
        }
        ui.placeholderRow.classList.add('hidden');

        data.forEach(item => {
            const row = document.createElement('tr');
            const isHidden = hiddenEmployees.has(item.employee);
            row.className = isHidden ? 'cursor-pointer hover:bg-gray-700 hidden-employee' : 'cursor-pointer hover:bg-gray-700';
            
            let processTypeColor = item.processType.includes('PICK') ? 'text-blue-400' : 'text-yellow-400';
            const targetHtp = getTargetHtp(item);
            let htpColor = parseFloat(item.htp) < targetHtp ? 'text-red-400' : 'text-green-400';
            
            let empDisplay = item.employee;
            let empColor = 'text-gray-200';

            // ‚ö° Í≥ÑÏïΩÏßÅ/Ï†ïÍ∑úÏßÅ ÏÉâÏÉÅ Ï¶âÏãú Ï†ÅÏö©
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            if (item.isManager) {
                empDisplay = `üëë ${item.employee}`;
                empColor = isDark ? 'text-yellow-300 font-bold' : 'text-yellow-600 font-bold';
            } else if (item.isPerm) {
                // Ï†ïÍ∑úÏßÅ (PERM) - Ï¥àÎ°ùÏÉâ
                empColor = isDark ? 'text-emerald-400 font-bold' : 'text-emerald-600 font-bold';
            } else {
                // Îã®Í∏∞/Í≥ÑÏïΩÏßÅ (TEMP) - Í∏∞Î≥∏ ÏÉâÏÉÅ (Ìù∞ÏÉâ/Í≤ÄÏùÄÏÉâ)
                empColor = isDark ? 'text-gray-300' : 'text-gray-700';
            }

            // ‚ö° ÌÖåÏù¥Î∏îÏóêÎäî Î±ÉÏßÄ ÌëúÏãú Ïïà Ìï® (ÏÇ¨Ïõê Î∂ÑÏÑù Î™®Îã¨ÏóêÏÑúÎßå ÌëúÏãú)
            // empDisplayÏóê Î±ÉÏßÄ Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå

            const actionMenu = `
                <div class="row-action-menu">
                    ${isHidden 
                        ? `<button class="action-menu-btn show-employee-btn" data-employee="${item.employee}" title="Î≥µÍµ¨">üîì</button>`
                        : `<button class="action-menu-btn hide-employee-btn" data-employee="${item.employee}" title="Ïà®Í∏∞Í∏∞">üîí</button>`
                    }
                </div>
            `;

            row.innerHTML = `
                <td class="px-4 py-3 font-medium ${processTypeColor}">${item.processType}</td>
                <td class="px-4 py-3 ${empColor} relative">
                    ${empDisplay}${isHidden ? '<span class="hidden-employee-indicator">Ïà®ÍπÄ</span>' : ''}
                </td>
                <td class="px-4 py-3 text-gray-200">${item.unitQty}</td>
                <td class="px-4 py-3 text-gray-200">${item.location || '-'}</td>
                <td class="px-4 py-3 text-gray-200">${item.processPathName || '-'}</td>
                <td class="px-4 py-3 text-gray-200">${item.packType}</td>
                <td class="px-4 py-3 text-gray-200">${item.mh}</td>
                <td class="px-4 py-3 font-bold ${htpColor}">${parseFloat(item.htp) < targetHtp && targetHtp > 0 ? 'üö® ' : ''}${item.htp}</td>
                <td class="px-4 py-3 relative">${actionMenu}</td>
            `;
            ui.tableBody.appendChild(row);
        });
    }

    function updateColumnVisibility(data) {
        const locationColHeader = ui.tableHeader.querySelector('th[data-sort-key="location"]');
        if (!locationColHeader) return;
        const locationColIndex = Array.from(locationColHeader.parentNode.children).indexOf(locationColHeader);
        const isLocationEmpty = data.length > 0 && data.every(item => !item.location);
        document.querySelectorAll(`#data-table th:nth-child(${locationColIndex + 1}), #data-table td:nth-child(${locationColIndex + 1})`)
            .forEach(cell => cell.classList.toggle('hidden-col', isLocationEmpty));
    }

    function updateSortIndicators() {
        ui.tableHeader.querySelectorAll('.sortable').forEach(th => {
            const indicator = th.querySelector('.sort-indicator');
            const key = th.dataset.sortKey;
            indicator.classList.remove('asc', 'desc');
            indicator.textContent = '';
            if (key === state.sort.key && state.sort.direction) {
                indicator.classList.add(state.sort.direction);
                indicator.textContent = state.sort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
            }
        });
    }

    function updateStats(data) {
        const visibleRows = data.length;
        const visibleWorkers = new Set(data.map(d => d.employee)).size;
        const totalQty = data.reduce((sum, d) => sum + d.unitQty, 0);
        const totalMh = data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
        const avgHtp = totalMh > 0 ? (totalQty / totalMh).toFixed(2) : '0.00';
        ui.statsDisplay.innerHTML = `
            ÌëúÏãú Í∑∏Î£π: <span class="font-bold text-white">${visibleRows}</span> | 
            ÏûëÏóÖÏûê Ïàò: <span class="font-bold text-white">${visibleWorkers}</span> | 
            Ï¥ù ÏûëÏóÖÎüâ: <span class="font-bold text-white">${totalQty.toLocaleString()}</span> | 
            ÌèâÍ∑† HTP: <span class="font-bold text-white">${avgHtp}</span>`;
    }

    function updateTicker(data) {
        if (data.length === 0) {
            ui.tickerText.innerHTML = '<span class="ticker-loading">üéØ Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎ°úÎìúÌïòÎ©¥ PICK/PACK TOP3/LOW3Í∞Ä ÌëúÏãúÎê©ÎãàÎã§.</span>';
            return;
        }
        
        // PICKÍ≥º PACK Îç∞Ïù¥ÌÑ∞ Î∂ÑÎ¶¨
        const pickData = data.filter(d => d.processType.includes('PICK'));
        const packData = data.filter(d => d.processType.includes('PACK'));
        
        // ÏÑπÏÖò ÏÉùÏÑ± Ìï®Ïàò
        const createSection = (sectionData, type, isTop) => {
            if (sectionData.length === 0) return '';
            
            const sorted = [...sectionData].sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            const items = isTop 
                ? sorted.slice(0, 3) 
                : sorted.filter(d => d.htp > 0).slice(-3).reverse();
            
            if (items.length === 0) return '';
            
            const processIcon = type === 'PICK' ? 'üì¶' : 'üìÆ';
            const label = isTop ? `${processIcon} ${type} TOP 3` : `‚ö†Ô∏è ${type} LOW 3`;
            const sectionClass = isTop ? 'top' : 'low';
            const processClass = type.toLowerCase();
            
            return `
                <div class="ticker-section ${sectionClass} ${processClass}">
                    <span class="ticker-label">${label}</span>
                    ${items.map((item, idx) => {
                        const name = item.employee.split('(')[0].trim();
                        const htp = parseFloat(item.htp).toFixed(1);
                        return `
                            <div class="ticker-item">
                                <span class="ticker-rank rank-${idx + 1}">${idx + 1}</span>
                                <span class="ticker-name">${name}</span>
                                <span class="ticker-htp">${htp}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };
        
        // PICK TOP3, PICK LOW3, PACK TOP3, PACK LOW3 ÏÉùÏÑ±
        const pickTop = createSection(pickData, 'PICK', true);
        const pickLow = createSection(pickData, 'PICK', false);
        const packTop = createSection(packData, 'PACK', true);
        const packLow = createSection(packData, 'PACK', false);
        
        // Î™®Îì† ÏÑπÏÖò Í≤∞Ìï© (2Î≤à Î∞òÎ≥µÌï¥ÏÑú Î¨¥Ìïú Ïä§ÌÅ¨Î°§)
        const allSections = pickTop + pickLow + packTop + packLow;
        ui.tickerText.innerHTML = allSections + allSections;
    }

    function captureTable() {
        const tableEl = document.getElementById('data-table');
        showModal('Ï∫°Ï≤ò Ï§ë...', 1500);
        html2canvas(tableEl).then(canvas => {
            canvas.toBlob(blob => {
                try {
                    navigator.clipboard.write([new ClipboardItem({'image/png': blob})])
                        .then(() => showModal('ÌÖåÏù¥Î∏îÏù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.'))
                        .catch(err => {
                            console.error('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ïã§Ìå®:', err);
                            showModal('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                        });
                } catch (error) {
                     console.error('ÌÅ¥Î¶ΩÎ≥¥Îìú API Ïò§Î•ò:', error);
                     showModal('ÌÅ¥Î¶ΩÎ≥¥Îìú APIÎ•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÎäî ÌôòÍ≤ΩÏûÖÎãàÎã§.');
                }
            });
        });
    }

    function exportToExcel() {
        if (globalRawData.length === 0) {
            showModal('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
            return;
        }
        let timeFilteredRawData = [...globalRawData];
        if (state.filters.hours.size > 0) {
            timeFilteredRawData = timeFilteredRawData.filter(item => state.filters.hours.has(item.htpStart.getUTCHours()));
        }
        let aggregatedData = aggregateData(timeFilteredRawData);
        let displayFilteredData = aggregatedData;
        if (state.filters.process === 'pick') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PICK(ÏßëÌíà)');
        else if (state.filters.process === 'pack') displayFilteredData = displayFilteredData.filter(item => item.processType === 'PACK(Ìè¨Ïû•)');
        if (state.filters.search) displayFilteredData = displayFilteredData.filter(item => item.employee.toLowerCase().includes(state.filters.search));
        if (state.filters.lowHtp) displayFilteredData = displayFilteredData.filter(item => parseFloat(item.htp) < getTargetHtp(item));
        let dataToExport = displayFilteredData;
        if (state.filters.floors.size > 0 && state.filters.packTypes.size > 0) {
             dataToExport = displayFilteredData.filter(item => 
                (item.processType.includes('PICK') && state.filters.floors.has(item.floor)) ||
                (item.processType.includes('PACK') && state.filters.packTypes.has(item.packType))
            );
        } else if (state.filters.floors.size > 0) {
            dataToExport = displayFilteredData.filter(item => item.processType.includes('PICK') && state.filters.floors.has(item.floor));
        } else if (state.filters.packTypes.size > 0) {
            dataToExport = displayFilteredData.filter(item => item.processType.includes('PACK') && state.filters.packTypes.has(item.packType));
        }
        if (dataToExport.length === 0) {
            showModal('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
            return;
        }
        const pickData = [], packData = [];
        dataToExport.forEach(item => {
            const rowData = {
                'ÏßëÌíà/Ìè¨Ïû•': item.processType,
                'Ïù¥Î¶Ñ(Ïø†ÏΩîÎìú)': item.employee.replace(/[üëëüî•üê¢ü•áü•àü•â]\s*/g, ''),
                'Í≥ÑÏïΩÏßÅ Ïó¨Î∂Ä': item.isPerm ? 'PERM' : 'TEMP',
                'ÏûëÏóÖÎüâ': Number(item.unitQty),
                'Î°úÏºÄÏù¥ÏÖò Î∞è ÏûëÏóÖÎåÄ': item.location || '-',
                'PP': item.processPathName || '-',
                'Ìå© Ï¢ÖÎ•ò': item.packType,
                'M/H': parseFloat(item.mh),
                'HTP': parseFloat(item.htp.replace('üö® ', ''))
            };
            if (rowData['ÏßëÌíà/Ìè¨Ïû•'].includes('PICK')) pickData.push(rowData);
            else packData.push(rowData);
        });
        pickData.sort((a, b) => a.HTP - b.HTP);
        packData.sort((a, b) => a.HTP - b.HTP);
        const wb = XLSX.utils.book_new();
        const createStyledSheet = (data, sheetName) => {
            if (!data || data.length === 0) return;
            const headers = Object.keys(data[0]);
            const ws = XLSX.utils.json_to_sheet(data, { header: headers });
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4F81BD" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
            };
            const cellStyle = {
                alignment: { horizontal: "center", vertical: "center" },
                border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
            };
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const headerAddr = XLSX.utils.encode_cell({ c: C, r: 0 });
                if (ws[headerAddr]) ws[headerAddr].s = headerStyle;
                for (let R = 1; R <= range.e.r; ++R) {
                    const cellAddr = XLSX.utils.encode_cell({ c: C, r: R });
                    if (ws[cellAddr]) {
                        if (!ws[cellAddr].s) ws[cellAddr].s = {};
                        Object.assign(ws[cellAddr].s, cellStyle);
                        if (typeof ws[cellAddr].v === 'number') {
                            if (headers[C] === 'M/H') ws[cellAddr].z = '0.0000';
                            else if (headers[C] === 'HTP') ws[cellAddr].z = '0.0';
                            else if (headers[C] === 'ÏûëÏóÖÎüâ') ws[cellAddr].z = '0';
                        }
                    }
                }
            }
            const colWidths = headers.map((header, i) => {
                const maxLength = Math.max(header.length, ...data.map(row => (row[header] ? row[header].toString().length : 0)));
                return { wch: maxLength + 2 };
            });
            ws['!cols'] = colWidths;
            ws['!autofilter'] = { ref: ws['!ref'] };
            ws['!freeze'] = { ySplit: 1 };
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        };
        createStyledSheet(pickData, "PICK(ÏßëÌíà)");
        createStyledSheet(packData, "PACK(Ìè¨Ïû•)");
        if (wb.SheetNames.length > 0) XLSX.writeFile(wb, "HTP_Data_Export_Styled.xlsx");
        else showModal('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
    }
    
    function updateStatus(status, message) {
        const dot = ui.statusIndicator.querySelector('.status-dot');
        const statusValue = ui.statusIndicator.querySelector('.status-value');
        
        dot.className = 'status-dot';
        if (status === 'connected') dot.classList.add('status-connected');
        else if (status === 'disconnected') dot.classList.add('status-disconnected');
        else if (status === 'loading') dot.classList.add('status-loading');
        
        if (statusValue) {
            statusValue.textContent = message;
        }
    }

    function showLoader() { ui.loaderContainer.classList.remove('hidden'); ui.tableView.classList.add('hidden'); }
    function hideLoader() { ui.loaderContainer.classList.add('hidden'); ui.tableView.classList.remove('hidden'); }
    
    function showModal(message, duration = 3000) {
        const modal = document.createElement('div');
        modal.className = 'fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-fade-in-out';
        modal.textContent = message;
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fade-in-out {
                0% { opacity: 0; transform: translateY(-20px); }
                10% { opacity: 1; transform: translateY(0); }
                90% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(-20px); }
            }
            .animate-fade-in-out { animation: fade-in-out ${duration / 1000}s ease-in-out forwards; }
        `;
        document.head.appendChild(style);
        document.body.appendChild(modal);
        setTimeout(() => { modal.remove(); style.remove(); }, duration);
    }

    function showEmployeeModal(htmlContent) {
        // Í∏∞Ï°¥ Î™®Îã¨ Ï†úÍ±∞
        const existingModal = document.getElementById('employee-detail-modal');
        if (existingModal) existingModal.remove();
        
        // ÌòÑÏû¨ ÌÖåÎßà ÌôïÏù∏
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        
        // Î™®Îã¨ Î∞∞Í≤Ω
        const modalBg = document.createElement('div');
        modalBg.id = 'employee-detail-modal';
        modalBg.className = `fixed inset-0 ${isDark ? 'bg-black bg-opacity-75' : 'bg-gray-900 bg-opacity-60'} flex items-center justify-center z-50`;
        modalBg.style.backdropFilter = 'blur(4px)';
        
        // Î™®Îã¨ Ïª®ÌÖåÏù¥ÎÑà - ÌÖåÎßàÎ≥Ñ Î∞∞Í≤ΩÏÉâ
        const modalContainer = document.createElement('div');
        modalContainer.className = `${isDark ? 'bg-gray-900' : 'bg-white'} rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`;
        modalContainer.innerHTML = htmlContent;
        
        // Îã´Í∏∞ Î≤ÑÌäº Ï∂îÍ∞Ä - ÌÖåÎßàÎ≥Ñ ÏÉâÏÉÅ
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '‚úï';
        closeBtn.className = `absolute top-4 right-4 ${isDark ? 'text-white hover:text-red-400' : 'text-gray-700 hover:text-red-600'} text-2xl transition-colors font-bold`;
        closeBtn.onclick = () => modalBg.remove();
        modalContainer.style.position = 'relative';
        modalContainer.insertBefore(closeBtn, modalContainer.firstChild);
        
        modalBg.appendChild(modalContainer);
        
        // Î∞∞Í≤Ω ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        modalBg.onclick = (e) => {
            if (e.target === modalBg) modalBg.remove();
        };
        
        // ESC ÌÇ§Î°ú Îã´Í∏∞
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                modalBg.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
        
        document.body.appendChild(modalBg);
    }

    initializeFiltersFromData([]);

    Chart.register(ChartDataLabels);

    function updateDashboard(filteredAggregatedData, timeFilteredRawData) {
        updateKpiCards(filteredAggregatedData);
        updatePerformersLists(filteredAggregatedData);
        updateFloorHtpChart(filteredAggregatedData);
        updatePackTypeChart(filteredAggregatedData);
        updateProcessComparisonChart(filteredAggregatedData);
        updateHourlyTrendChart(timeFilteredRawData);
    }

    function generateColors(numColors) {
        const colors = ['rgba(59, 130, 246, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(99, 102, 241, 0.7)'];
        const result = [];
        for (let i = 0; i < numColors; i++) result.push(colors[i % colors.length]);
        return result;
    }

    function updateKpiCards(data) {
        const totalWorkers = new Set(data.map(d => d.employee)).size;
        const totalQty = data.reduce((sum, d) => sum + d.unitQty, 0);
        const totalMh = data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
        const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
        const lowPerformers = data.filter(d => parseFloat(d.htp) < getTargetHtp(d)).length;
        ui.kpi.totalWorkers.textContent = totalWorkers.toLocaleString();
        ui.kpi.totalQty.textContent = totalQty.toLocaleString();
        ui.kpi.avgHtp.textContent = avgHtp.toFixed(1);
        ui.kpi.lowPerformers.textContent = lowPerformers.toLocaleString();
    }

    function updatePerformersLists(data) {
        ui.topPickPerformersList.innerHTML = '';
        ui.topPackPerformersList.innerHTML = '';
        if (data.length === 0) {
            ui.topPickPerformersList.innerHTML = '<li class="text-gray-500">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>';
            ui.topPackPerformersList.innerHTML = '<li class="text-gray-500">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>';
            return;
        }
        const pickData = data.filter(d => d.processType.includes('PICK'));
        const packData = data.filter(d => d.processType.includes('PACK'));
        pickData.sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
        packData.sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
        const top5Pick = pickData.slice(0, 5);
        const top5Pack = packData.slice(0, 5);
        const createListItem = (item) => `<li class="flex justify-between items-center bg-gray-700 p-2 rounded-md"><span>${item.employee.split('(')[0].trim()}</span><span class="font-bold text-green-400">${item.htp}</span></li>`;
        if (top5Pick.length > 0) top5Pick.forEach(item => ui.topPickPerformersList.innerHTML += createListItem(item));
        else ui.topPickPerformersList.innerHTML = '<li class="text-gray-500">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>';
        if (top5Pack.length > 0) top5Pack.forEach(item => ui.topPackPerformersList.innerHTML += createListItem(item));
        else ui.topPackPerformersList.innerHTML = '<li class="text-gray-500">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>';
    }

    function updateFloorHtpChart(data) {
        const pickData = data.filter(d => d.processType.includes('PICK'));
        const floorData = new Map();
        pickData.forEach(item => {
            if (!floorData.has(item.floor)) floorData.set(item.floor, { totalQty: 0, totalMh: 0 });
            const floor = floorData.get(item.floor);
            floor.totalQty += item.unitQty;
            floor.totalMh += parseFloat(item.mh);
        });
        const sortedFloors = Array.from(floorData.keys()).sort();
        const labels = sortedFloors;
        const avgHtps = sortedFloors.map(floor => {
             const d = floorData.get(floor);
             const weightedAvgHtp = d.totalMh > 0 ? (d.totalQty / d.totalMh) : 0;
             return weightedAvgHtp.toFixed(1);
        });
        const ctx = document.getElementById('floor-htp-chart').getContext('2d');
        if (state.charts.floorHtp) state.charts.floorHtp.destroy();
        state.charts.floorHtp = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'ÌèâÍ∑† HTP', data: avgHtps, backgroundColor: generateColors(labels.length), borderColor: '#4b5563', borderWidth: 1 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } },
                plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', color: '#FFFFFF', font: { weight: 'bold' }, formatter: (value) => value > 0 ? value : '' } }
            }
        });
    }

    function updatePackTypeChart(data) {
        const packData = data.filter(d => d.processType.includes('PACK'));
        let packTypeData = new Map(), totalQuantity = 0;
        packData.forEach(item => {
            if (!packTypeData.has(item.packType)) packTypeData.set(item.packType, 0);
            const currentQty = packTypeData.get(item.packType);
            packTypeData.set(item.packType, currentQty + item.unitQty);
            totalQuantity += item.unitQty;
        });
        const otherThreshold = 0.02;
        let otherQuantity = 0;
        const finalPackData = new Map();
        packTypeData.forEach((qty, type) => {
            if (totalQuantity > 0 && (qty / totalQuantity) < otherThreshold) otherQuantity += qty;
            else finalPackData.set(type, qty);
        });
        if (otherQuantity > 0) finalPackData.set('Í∏∞ÌÉÄ', (finalPackData.get('Í∏∞ÌÉÄ') || 0) + otherQuantity);
        const labels = Array.from(finalPackData.keys());
        const quantities = Array.from(finalPackData.values());
        const ctx = document.getElementById('pack-type-chart').getContext('2d');
        if (state.charts.packType) state.charts.packType.destroy();
        state.charts.packType = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ label: 'ÏûëÏóÖÎüâ', data: quantities, backgroundColor: generateColors(labels.length), borderColor: '#374151', borderWidth: 2 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { color: '#d1d5db' } },
                    datalabels: { color: '#FFFFFF', textAlign: 'center', font: { weight: 'bold' }, formatter: (value, context) => {
                        const percentage = totalQuantity > 0 ? (value / totalQuantity * 100).toFixed(1) : 0;
                        const label = context.chart.data.labels[context.dataIndex];
                        if (parseFloat(percentage) < 5) return '';
                        return `${label}\n${percentage}%`;
                    }}
                }
            }
        });
    }

    function updateProcessComparisonChart(data) {
        const processStats = { PICK: { totalQty: 0, totalMh: 0 }, PACK: { totalQty: 0, totalMh: 0 } };
        data.forEach(item => {
            const type = item.processType.includes('PICK') ? 'PICK' : 'PACK';
            processStats[type].totalQty += item.unitQty;
            processStats[type].totalMh += parseFloat(item.mh);
        });
        const pickHtp = processStats.PICK.totalMh > 0 ? (processStats.PICK.totalQty / processStats.PICK.totalMh) : 0;
        const packHtp = processStats.PACK.totalMh > 0 ? (processStats.PACK.totalQty / processStats.PACK.totalMh) : 0;
        const ctx = document.getElementById('process-comparison-chart').getContext('2d');
        if (state.charts.processComparison) state.charts.processComparison.destroy();
        state.charts.processComparison = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: ['PICK(ÏßëÌíà)', 'PACK(Ìè¨Ïû•)'], datasets: [{ label: 'Ï¥ù ÏûëÏóÖÎüâ', data: [processStats.PICK.totalQty, processStats.PACK.totalQty], backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)'], borderColor: '#374151', borderWidth: 2 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#d1d5db' } },
                    datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (value, context) => {
                        const label = context.chart.data.labels[context.dataIndex];
                        const htp = label.includes('PICK') ? pickHtp : packHtp;
                        return `${value.toLocaleString()}\n(Avg ${htp.toFixed(0)} HTP)`;
                    }}
                }
            }
        });
    }
    
    function updateHourlyTrendChart(rawData) {
         const hourlyData = new Map();
         for(let i=0; i<24; i++) hourlyData.set(i, { unitQty: 0, totalSeconds: 0 });
         rawData.forEach(item => {
            const hour = item.htpStart.getUTCHours();
            const stats = hourlyData.get(hour);
            if(stats){
                stats.unitQty += item.unitQty;
                stats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
            }
         });
        const sortedHours = Array.from(hourlyData.keys()).sort((a, b) => a - b);
        const labels = sortedHours.map(hour => `${hour.toString().padStart(2, '0')}:00`);
        const htpValues = sortedHours.map(hour => {
            const stats = hourlyData.get(hour);
            if (!stats || stats.totalSeconds <= 0) return 0;
            const mh = stats.totalSeconds / 3600;
            return (stats.unitQty / mh).toFixed(1);
        });
        const ctx = document.getElementById('hourly-htp-chart').getContext('2d');
        if (state.charts.hourlyHtp) state.charts.hourlyHtp.destroy();
        state.charts.hourlyHtp = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'ÏãúÍ∞ÑÎ≥Ñ ÌèâÍ∑† HTP', data: htpValues, fill: true, backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)', tension: 0.3 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: false, ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db', maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } } },
                plugins: { legend: { display: false }, datalabels: { display: false } }
            }
        });
    }

    function showIndividualTrend(employeeName, processType) {
        employeeName = employeeName.replace(/[üëëüî•üê¢ü•áü•àü•â]\s*/g, '').trim();
        const targetProcessTask = processType.includes('PICK') ? 'PICK(PICKING)' : 'PACK(PACKING)';
        const employeeData = globalRawData.filter(d => d.employee === employeeName && d.processTask === targetProcessTask);
        
        if (employeeData.length === 0) {
            showModal(`${employeeName.split('(')[0]} ÎãòÏùò Ìï¥Îãπ Í≥µÏ†ï Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.`);
            return;
        }

        const hourlyData = new Map();
        employeeData.forEach(item => {
            const hour = item.htpStart.getUTCHours();
            if (!hourlyData.has(hour)) hourlyData.set(hour, { unitQty: 0, totalSeconds: 0 });
            const hourStats = hourlyData.get(hour);
            hourStats.unitQty += item.unitQty;
            hourStats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
        });

        const sortedHours = Array.from(hourlyData.keys()).sort((a, b) => a - b);
        const labels = sortedHours.map(hour => `${hour}Ïãú`);
        const htpValues = sortedHours.map(hour => {
            const stats = hourlyData.get(hour);
            const mh = stats.totalSeconds / 3600;
            return mh > 0 ? (stats.unitQty / mh).toFixed(1) : 0;
        });

        const totalQty = employeeData.reduce((sum, item) => sum + item.unitQty, 0);
        const totalSeconds = employeeData.reduce((sum, item) => sum + (item.htpEnd - item.htpStart) / 1000, 0);
        const totalMh = totalSeconds / 3600;
        const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
        const maxHtp = Math.max(...htpValues.map(v => parseFloat(v)));
        const minHtp = Math.min(...htpValues.filter(v => v > 0).map(v => parseFloat(v)));
        const maxHour = sortedHours[htpValues.indexOf(maxHtp.toString())];
        
        const hourlyRanks = sortedHours.map(hour => {
            const stats = hourlyData.get(hour);
            const mh = stats.totalSeconds / 3600;
            const employeeHtp = mh > 0 ? stats.unitQty / mh : 0;
            
            const sameHourData = globalRawData.filter(d => 
                d.processTask === targetProcessTask && 
                d.htpStart.getUTCHours() === hour
            );
            
            const employeeHtps = new Map();
            sameHourData.forEach(item => {
                if (!employeeHtps.has(item.employee)) {
                    employeeHtps.set(item.employee, { unitQty: 0, totalSeconds: 0 });
                }
                const empStats = employeeHtps.get(item.employee);
                empStats.unitQty += item.unitQty;
                empStats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
            });
            
            const htpList = Array.from(employeeHtps.values())
                .map(s => s.totalSeconds > 0 ? s.unitQty / (s.totalSeconds / 3600) : 0)
                .sort((a, b) => b - a);
            
            const rank = htpList.findIndex(h => h <= employeeHtp) + 1;
            const total = htpList.length;
            
            return { hour, rank, total };
        });

        const employeeBadge = employeeBadges[employeeName] || { badges: [], streaks: {}, records: {} };
        const badgesHtml = employeeBadge.badges.length > 0 
            ? employeeBadge.badges.map(b => `<span class="badge badge-${b.level} cursor-help" title="üìå ${b.desc || 'ÌäπÎ≥ÑÌïú Î±ÉÏßÄ'}" style="transition: transform 0.2s; cursor: help;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">${b.name}</span>`).join(' ')
            : '<span class="text-gray-500">ÌöçÎìùÌïú Î±ÉÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§</span>';

        ui.chartModalTitle.textContent = `${employeeName} ÎãòÏùò ÏÉÅÏÑ∏ Î∂ÑÏÑù (${processType.split('(')[0]})`;
        const modalContent = document.getElementById('chart-modal-content');
        modalContent.innerHTML = `
            <h3 class="text-xl font-bold mb-4" style="color: var(--text-primary);">${employeeName} ÎãòÏùò ÏÉÅÏÑ∏ Î∂ÑÏÑù (${processType.split('(')[0]})</h3>
            
            <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">üèÖ ÌöçÎìù Î±ÉÏßÄ</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${badgesHtml}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">
                    <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">üìä Ïò§ÎäòÏùò ÏÑ±Í≥º ÏöîÏïΩ</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div>
                            <div style="color: var(--text-tertiary); font-size: 11px;">ÌèâÍ∑† HTP</div>
                            <div style="color: var(--text-primary); font-size: 20px; font-weight: 700;">${avgHtp.toFixed(1)}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-tertiary); font-size: 11px;">ÏµúÍ≥† HTP</div>
                            <div style="color: #4ade80; font-size: 20px; font-weight: 700;">${maxHtp.toFixed(1)}</div>
                            <div style="color: var(--text-tertiary); font-size: 10px;">${maxHour}Ïãú</div>
                        </div>
                        <div>
                            <div style="color: var(--text-tertiary); font-size: 11px;">ÏµúÏ†Ä HTP</div>
                            <div style="color: #f87171; font-size: 20px; font-weight: 700;">${minHtp > 0 ? minHtp.toFixed(1) : '-'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-tertiary); font-size: 11px;">Ï¥ù ÏûëÏóÖÎüâ</div>
                            <div style="color: var(--text-primary); font-size: 18px; font-weight: 700;">${totalQty.toLocaleString()}</div>
                            <div style="color: var(--text-tertiary); font-size: 10px;">Unit</div>
                        </div>
                        <div>
                            <div style="color: var(--text-tertiary); font-size: 11px;">Ï¥ù ÏûëÏóÖÏãúÍ∞Ñ</div>
                            <div style="color: var(--text-primary); font-size: 18px; font-weight: 700;">${totalMh.toFixed(1)}</div>
                            <div style="color: var(--text-tertiary); font-size: 10px;">ÏãúÍ∞Ñ</div>
                        </div>
                        <div>
                            <div style="color: var(--text-tertiary); font-size: 11px;">Î™©Ìëú ÎåÄÎπÑ</div>
                            <div style="color: ${avgHtp >= getTargetHtp({processType: processType}) ? '#4ade80' : '#f87171'}; font-size: 18px; font-weight: 700;">
                                ${((avgHtp / getTargetHtp({processType: processType}) - 1) * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; max-height: 180px; overflow-y: auto;">
                    <h4 style="color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">üèÜ ÏãúÍ∞ÑÎåÄÎ≥Ñ ÏàúÏúÑ</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${hourlyRanks.map(r => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="color: var(--text-primary); font-weight: 600; font-size: 13px;">${r.hour}Ïãú</span>
                                <span style="color: ${r.rank <= 3 ? '#fbbf24' : r.rank <= r.total / 2 ? '#4ade80' : '#94a3b8'}; font-weight: 700; font-size: 13px;">
                                    ${r.rank}ÏúÑ / ${r.total}Î™Ö ${r.rank === 1 ? 'üëë' : r.rank <= 3 ? '‚≠ê' : ''}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <div class="flex-grow" style="min-height: 300px;">
                <canvas id="individual-htp-chart"></canvas>
            </div>
            <button id="chart-modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        `;

        const ctx = document.getElementById('individual-htp-chart').getContext('2d');
        if (state.charts.individualHtp) state.charts.individualHtp.destroy();
        state.charts.individualHtp = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'ÏãúÍ∞ÑÎ≥Ñ HTP', data: htpValues, fill: false, borderColor: 'rgb(75, 192, 192)', tension: 0.1 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } },
                plugins: { legend: { labels: { color: '#d1d5db' } }, datalabels: { align: 'top', color: '#FFFFFF' } }
            }
        });
        
        document.getElementById('chart-modal-close').addEventListener('click', () => {
            ui.chartModalBackdrop.classList.add('hidden');
            ui.chartModalBackdrop.classList.remove('flex');
        });

        ui.chartModalBackdrop.classList.remove('hidden');
        ui.chartModalBackdrop.classList.add('flex');
    }

    // --- üÜï Calendar View Functions ---
    function renderCalendarView() {
        const year = state.calendarCurrentMonth.getFullYear();
        const month = state.calendarCurrentMonth.getMonth();
        
        ui.calendarMonthTitle.textContent = `${year}ÎÖÑ ${month + 1}Ïõî`;
        
        const existingDays = ui.calendarGrid.querySelectorAll('.calendar-day');
        existingDays.forEach(day => day.remove());
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day inactive';
            ui.calendarGrid.appendChild(emptyDay);
        }
        
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayData = historyData[dateStr];
            
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayEl.classList.add('today');
            }
            
            if (dayData && dayData.length > 0) {
                const aggregated = aggregateData(dayData);
                const totalQty = aggregated.reduce((sum, d) => sum + d.unitQty, 0);
                const totalMh = aggregated.reduce((sum, d) => sum + parseFloat(d.mh), 0);
                const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
                
                const targetHtp = 90;
                const performanceRatio = avgHtp / targetHtp;
                
                if (performanceRatio >= 1.2) dayEl.classList.add('excellent');
                else if (performanceRatio >= 1.0) dayEl.classList.add('good');
                else if (performanceRatio >= 0.8) dayEl.classList.add('average');
                else dayEl.classList.add('poor');
                
                dayEl.innerHTML = `
                    <div class="calendar-day-number">${day}</div>
                    <div class="calendar-day-htp" style="color: var(--text-primary);">HTP ${avgHtp.toFixed(0)}</div>
                `;
                
                dayEl.addEventListener('click', () => showCalendarDayDetail(dateStr));
            } else {
                dayEl.classList.add('no-data');
                dayEl.innerHTML = `
                    <div class="calendar-day-number">${day}</div>
                    <div class="calendar-day-htp" style="color: var(--text-tertiary); font-size: 0.65rem;">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>
                `;
            }
            
            ui.calendarGrid.appendChild(dayEl);
        }
    }

    function showCalendarDayDetail(dateStr) {
        const dayData = historyData[dateStr];
        if (!dayData || dayData.length === 0) {
            showModal('Ìï¥Îãπ ÎÇ†ÏßúÏùò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
            return;
        }
        
        const aggregated = aggregateData(dayData);
        const totalQty = aggregated.reduce((sum, d) => sum + d.unitQty, 0);
        const totalMh = aggregated.reduce((sum, d) => sum + parseFloat(d.mh), 0);
        const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
        const workerCount = new Set(aggregated.map(d => d.employee)).size;
        const targetHtp = 90;
        const targetRate = ((avgHtp / targetHtp) * 100).toFixed(0);
        
        document.getElementById('calendar-detail-title').textContent = `${dateStr} ÏÉÅÏÑ∏ Ï†ïÎ≥¥`;
        document.getElementById('calendar-detail-avg-htp').textContent = avgHtp.toFixed(1);
        document.getElementById('calendar-detail-total-qty').textContent = totalQty.toLocaleString();
        document.getElementById('calendar-detail-worker-count').textContent = workerCount;
        document.getElementById('calendar-detail-target-rate').textContent = targetRate + '%';
        
        const sorted = [...aggregated].sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
        const top5 = sorted.slice(0, 5);
        const topListHtml = top5.map((item, index) => `
            <div class="flex justify-between items-center bg-gray-600 p-2 rounded-md">
                <span class="font-semibold">${index + 1}. ${item.employee.split('(')[0].trim()}</span>
                <span class="font-bold text-green-400">${item.htp} HTP</span>
            </div>
        `).join('');
        document.getElementById('calendar-detail-top-list').innerHTML = topListHtml;
        
        const pickData = aggregated.filter(d => d.processType.includes('PICK'));
        const packData = aggregated.filter(d => d.processType.includes('PACK'));
        const pickQty = pickData.reduce((sum, d) => sum + d.unitQty, 0);
        const packQty = packData.reduce((sum, d) => sum + d.unitQty, 0);
        
        const ctx = document.getElementById('calendar-detail-chart').getContext('2d');
        if (state.charts.calendarDetailChart) state.charts.calendarDetailChart.destroy();
        state.charts.calendarDetailChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['PICK', 'PACK'],
                datasets: [{
                    data: [pickQty, packQty],
                    backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)'],
                    borderColor: '#374151',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#d1d5db' } },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold' },
                        formatter: (value) => value.toLocaleString()
                    }
                }
            }
        });
        
        ui.calendarDetailModalBackdrop.classList.remove('hidden');
        ui.calendarDetailModalBackdrop.classList.add('flex');
    }

    // --- üÜï Ranking View Functions ---
    function renderRankingView() {
        ensureBadgesCalculated(); // Î±ÉÏßÄ Í≥ÑÏÇ∞
        
        const filteredDates = getRankingFilteredDates();
        if (filteredDates.length === 0) {
            ui.rankingList.innerHTML = '<div class="text-center py-10 text-gray-500">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            return;
        }
        
        // ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÏßÅÏ†ë Ï≤òÎ¶¨
        const processFilter = state.rankingProcessType === 'pick' ? 'PICK' : 'PACK';
        const employeeStats = new Map();
        
        filteredDates.forEach(date => {
            const dayData = historyData[date];
            if (!Array.isArray(dayData)) return;
            
            dayData.forEach(item => {
                if (!item || !item.employee) return;
                
                const processTask = item.processTask || item.processType || '';
                if (!processTask.includes(processFilter)) return;
                
                // HTP Í≥ÑÏÇ∞
                const durationSeconds = (item.htpEnd - item.htpStart) / 1000;
                if (durationSeconds <= 0) return;
                
                const htp = item.unitQty / (durationSeconds / 3600);
                const qty = item.unitQty || 0;
                const mh = durationSeconds / 3600;
                
                if (!employeeStats.has(item.employee)) {
                    employeeStats.set(item.employee, { totalQty: 0, totalMh: 0, htpList: [] });
                }
                const stats = employeeStats.get(item.employee);
                stats.totalQty += qty;
                stats.totalMh += mh;
                stats.htpList.push(htp);
            });
        });
        
        const rankings = [];
        employeeStats.forEach((stats, employee) => {
            const avgHtp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
            rankings.push({ 
                employee, 
                avgHtp: avgHtp.toFixed(1), 
                totalQty: stats.totalQty,
                workDays: stats.htpList.length 
            });
        });
        
        rankings.sort((a, b) => parseFloat(b.avgHtp) - parseFloat(a.avgHtp));
        
        ui.rankingTotalCount.textContent = rankings.length;
        const avgHtp = rankings.length > 0 ? (rankings.reduce((sum, r) => sum + parseFloat(r.avgHtp), 0) / rankings.length) : 0;
        const maxHtp = rankings.length > 0 ? Math.max(...rankings.map(r => parseFloat(r.avgHtp))) : 0;
        const medianHtp = rankings.length > 0 ? parseFloat(rankings[Math.floor(rankings.length / 2)].avgHtp) : 0;
        
        ui.rankingAvgHtp.textContent = avgHtp.toFixed(1);
        ui.rankingMaxHtp.textContent = maxHtp.toFixed(1);
        ui.rankingMedianHtp.textContent = medianHtp.toFixed(1);
        
        if (rankings.length >= 1) {
            document.getElementById('podium-1-name').textContent = rankings[0].employee.split('(')[0].trim();
            document.getElementById('podium-1-score').textContent = rankings[0].avgHtp;
        } else {
            document.getElementById('podium-1-name').textContent = '-';
            document.getElementById('podium-1-score').textContent = '0';
        }
        
        if (rankings.length >= 2) {
            document.getElementById('podium-2-name').textContent = rankings[1].employee.split('(')[0].trim();
            document.getElementById('podium-2-score').textContent = rankings[1].avgHtp;
        } else {
            document.getElementById('podium-2-name').textContent = '-';
            document.getElementById('podium-2-score').textContent = '0';
        }
        
        if (rankings.length >= 3) {
            document.getElementById('podium-3-name').textContent = rankings[2].employee.split('(')[0].trim();
            document.getElementById('podium-3-score').textContent = rankings[2].avgHtp;
        } else {
            document.getElementById('podium-3-name').textContent = '-';
            document.getElementById('podium-3-score').textContent = '0';
        }
        
        ui.rankingList.innerHTML = '';
        rankings.forEach((rank, index) => {
            const position = index + 1;
            const previousRank = previousRankings[rank.employee] || position;
            const change = previousRank - position;
            
            let changeHtml = '';
            if (change > 0) {
                changeHtml = `<span class="ranking-change up">‚ñ≤${change}</span>`;
            } else if (change < 0) {
                changeHtml = `<span class="ranking-change down">‚ñº${Math.abs(change)}</span>`;
            } else {
                changeHtml = `<span class="ranking-change same">-</span>`;
            }
            
            const item = document.createElement('div');
            item.className = 'ranking-item';
            item.innerHTML = `
                <div class="ranking-position">#${position}</div>
                <div class="ranking-employee">${rank.employee.split('(')[0].trim()}</div>
                <div class="ranking-htp">${rank.avgHtp}${changeHtml}</div>
            `;
            
            item.addEventListener('click', () => {
                const processType = state.rankingProcessType === 'pick' ? 'PICK(ÏßëÌíà)' : 'PACK(Ìè¨Ïû•)';
                showEmployeeDetailModal(rank.employee, processType);
            });
            
            ui.rankingList.appendChild(item);
        });
        
        previousRankings = {};
        rankings.forEach((rank, index) => {
            previousRankings[rank.employee] = index + 1;
        });
    }

    function getRankingFilteredDates() {
        const allDates = Object.keys(historyData).sort();
        if (allDates.length === 0) return [];
        
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        
        if (state.rankingPeriod === 'daily') {
            return allDates.filter(date => date === todayStr);
        } else if (state.rankingPeriod === 'weekly') {
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
            return allDates.filter(date => date >= sevenDaysAgoStr && date <= todayStr);
        } else if (state.rankingPeriod === 'monthly') {
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
            return allDates.filter(date => date >= thirtyDaysAgoStr && date <= todayStr);
        } else if (state.rankingPeriod === 'all-time') {
            return allDates;
        }
        return allDates;
    }

    // --- üÜï History View Functions ---
    let historyEmployeeData = [];
    let currentHistoryPage = 1;
    const EMPLOYEES_PER_PAGE = 20;

    function renderHistoryView() {
        ensureBadgesCalculated(); // Î±ÉÏßÄ Í≥ÑÏÇ∞
        
        if (Object.keys(historyData).length === 0) {
            showModal('ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
            return;
        }

        const filteredDates = getFilteredHistoryDates();
        if (filteredDates.length === 0) {
            ui.historyKpi.days.textContent = '0';
            ui.historyKpi.totalQty.textContent = '0';
            ui.historyKpi.avgHtp.textContent = '0.0';
            ui.historyKpi.maxHtp.textContent = '0.0';
            return;
        }

        let allAggregatedData = [];
        filteredDates.forEach(date => {
            const dayData = historyData[date];
            if (dayData) {
                const aggregated = aggregateData(dayData);
                allAggregatedData = allAggregatedData.concat(aggregated.map(item => ({ ...item, date })));
            }
        });

        const totalDays = filteredDates.length;
        const totalQty = allAggregatedData.reduce((sum, d) => sum + d.unitQty, 0);
        const totalMh = allAggregatedData.reduce((sum, d) => sum + parseFloat(d.mh), 0);
        const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
        const maxHtp = Math.max(...allAggregatedData.map(d => parseFloat(d.htp)), 0);

        ui.historyKpi.days.textContent = totalDays.toLocaleString();
        ui.historyKpi.totalQty.textContent = totalQty.toLocaleString();
        ui.historyKpi.avgHtp.textContent = avgHtp.toFixed(1);
        ui.historyKpi.maxHtp.textContent = maxHtp.toFixed(1);

        calculateEmployeeHistoryData(allAggregatedData);
        updateHistoryTopPerformers(allAggregatedData);
    }

    function getFilteredHistoryDates() {
        const allDates = Object.keys(historyData).sort();
        if (allDates.length === 0) return [];

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        if (state.historyPeriod === 'week') {
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
            return allDates.filter(date => date >= sevenDaysAgoStr && date <= todayStr);
        } else if (state.historyPeriod === 'month') {
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
            return allDates.filter(date => date >= thirtyDaysAgoStr && date <= todayStr);
        } else if (state.historyPeriod === 'all') {
            return allDates;
        } else if (state.historyPeriod === 'custom') {
            const { start, end } = state.historyDateRange;
            return allDates.filter(date => date >= start && date <= end);
        }
        return allDates;
    }

    function calculateEmployeeHistoryData(allData) {
        const employeeMap = new Map();

        allData.forEach(item => {
            if (!employeeMap.has(item.employee)) {
                employeeMap.set(item.employee, {
                    employee: item.employee,
                    totalDays: new Set(),
                    pickData: { totalQty: 0, totalMh: 0, ppPerformance: new Map() },
                    packData: { totalQty: 0, totalMh: 0, packTypePerformance: new Map() }
                });
            }

            const empData = employeeMap.get(item.employee);
            empData.totalDays.add(item.date);

            if (item.processType.includes('PICK')) {
                empData.pickData.totalQty += item.unitQty;
                empData.pickData.totalMh += parseFloat(item.mh);
                
                const pp = item.processPathName || 'Í∏∞ÌÉÄ';
                if (!empData.pickData.ppPerformance.has(pp)) {
                    empData.pickData.ppPerformance.set(pp, { totalQty: 0, totalMh: 0 });
                }
                const ppStats = empData.pickData.ppPerformance.get(pp);
                ppStats.totalQty += item.unitQty;
                ppStats.totalMh += parseFloat(item.mh);
            } else {
                empData.packData.totalQty += item.unitQty;
                empData.packData.totalMh += parseFloat(item.mh);
                
                const packType = item.packType || 'Í∏∞ÌÉÄ';
                if (!empData.packData.packTypePerformance.has(packType)) {
                    empData.packData.packTypePerformance.set(packType, { totalQty: 0, totalMh: 0 });
                }
                const packStats = empData.packData.packTypePerformance.get(packType);
                packStats.totalQty += item.unitQty;
                packStats.totalMh += parseFloat(item.mh);
            }
        });

        historyEmployeeData = Array.from(employeeMap.values()).map(emp => {
            const pickHtp = emp.pickData.totalMh > 0 ? (emp.pickData.totalQty / emp.pickData.totalMh) : 0;
            const packHtp = emp.packData.totalMh > 0 ? (emp.packData.totalQty / emp.packData.totalMh) : 0;
            const totalQty = emp.pickData.totalQty + emp.packData.totalQty;
            const totalMh = emp.pickData.totalMh + emp.packData.totalMh;
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;

            let bestPP = null, bestPPHtp = 0;
            emp.pickData.ppPerformance.forEach((stats, pp) => {
                const htp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
                if (htp > bestPPHtp) {
                    bestPPHtp = htp;
                    bestPP = pp;
                }
            });

            let bestPackType = null, bestPackTypeHtp = 0;
            emp.packData.packTypePerformance.forEach((stats, packType) => {
                const htp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
                if (htp > bestPackTypeHtp) {
                    bestPackTypeHtp = htp;
                    bestPackType = packType;
                }
            });

            return {
                employee: emp.employee,
                totalDays: emp.totalDays.size,
                totalQty: totalQty,
                avgHtp: avgHtp,
                pickHtp: pickHtp,
                packHtp: packHtp,
                bestProcess: pickHtp > packHtp ? 'PICK' : (packHtp > 0 ? 'PACK' : 'PICK'),
                bestProcessHtp: Math.max(pickHtp, packHtp),
                bestPP: bestPP,
                bestPPHtp: bestPPHtp,
                bestPackType: bestPackType,
                bestPackTypeHtp: bestPackTypeHtp
            };
        });

        historyEmployeeData.sort((a, b) => b.avgHtp - a.avgHtp);
    }

    function updateHistoryTopPerformers(allData) {
        const employeeStats = new Map();
        
        allData.forEach(item => {
            const key = `${item.employee}|${item.processType}`;
            if (!employeeStats.has(key)) {
                employeeStats.set(key, {
                    employee: item.employee,
                    processType: item.processType,
                    totalQty: 0,
                    totalMh: 0
                });
            }
            const stats = employeeStats.get(key);
            stats.totalQty += item.unitQty;
            stats.totalMh += parseFloat(item.mh);
        });

        const employeeList = [];
        employeeStats.forEach(stats => {
            const avgHtp = stats.totalMh > 0 ? (stats.totalQty / stats.totalMh) : 0;
            employeeList.push({
                employee: stats.employee,
                processType: stats.processType,
                avgHtp: avgHtp,
                totalQty: stats.totalQty
            });
        });

        const pickList = employeeList
            .filter(e => e.processType.includes('PICK'))
            .sort((a, b) => b.avgHtp - a.avgHtp)
            .slice(0, 10);

        const packList = employeeList
            .filter(e => e.processType.includes('PACK'))
            .sort((a, b) => b.avgHtp - a.avgHtp)
            .slice(0, 10);

        ui.historyTopPickList.innerHTML = '';
        ui.historyTopPackList.innerHTML = '';

        if (pickList.length === 0) {
            ui.historyTopPickList.innerHTML = '<div class="text-gray-500 text-center py-4">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
        } else {
            pickList.forEach((item, index) => {
                const rank = index + 1;
                const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
                
                let medalOrNumber = '';
                if (rank === 1) {
                    medalOrNumber = '<span class="medal-icon">ü•á</span>';
                } else if (rank === 2) {
                    medalOrNumber = '<span class="medal-icon">ü•à</span>';
                } else if (rank === 3) {
                    medalOrNumber = '<span class="medal-icon">ü•â</span>';
                } else {
                    medalOrNumber = `<span class="rank-number">${rank}</span>`;
                }
                
                const div = document.createElement('div');
                div.className = `top-performer-item ${rankClass}`;
                div.innerHTML = `
                    ${medalOrNumber}
                    <span class="performer-name">${item.employee.split('(')[0].trim()}</span>
                    <span class="performer-htp">${item.avgHtp.toFixed(1)} HTP</span>
                `;
                div.addEventListener('click', () => showEmployeeDetailModal(item.employee, 'PICK(ÏßëÌíà)'));
                ui.historyTopPickList.appendChild(div);
            });
        }

        if (packList.length === 0) {
            ui.historyTopPackList.innerHTML = '<div class="text-gray-500 text-center py-4">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
        } else {
            packList.forEach((item, index) => {
                const rank = index + 1;
                const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
                
                let medalOrNumber = '';
                if (rank === 1) {
                    medalOrNumber = '<span class="medal-icon">ü•á</span>';
                } else if (rank === 2) {
                    medalOrNumber = '<span class="medal-icon">ü•à</span>';
                } else if (rank === 3) {
                    medalOrNumber = '<span class="medal-icon">ü•â</span>';
                } else {
                    medalOrNumber = `<span class="rank-number">${rank}</span>`;
                }
                
                const div = document.createElement('div');
                div.className = `top-performer-item ${rankClass}`;
                div.innerHTML = `
                    ${medalOrNumber}
                    <span class="performer-name">${item.employee.split('(')[0].trim()}</span>
                    <span class="performer-htp">${item.avgHtp.toFixed(1)} HTP</span>
                `;
                div.addEventListener('click', () => showEmployeeDetailModal(item.employee, 'PACK(Ìè¨Ïû•)'));
                ui.historyTopPackList.appendChild(div);
            });
        }
    }

    // Employee Search (Í∞ÑÎã® Î≤ÑÏ†Ñ)
    const historyEmployeeSearch = document.getElementById('history-employee-search');
    const historyShowAllBtn = document.getElementById('history-show-all-btn');

    if (historyEmployeeSearch) {
        historyEmployeeSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            if (searchTerm === '') {
                document.getElementById('history-employee-results').innerHTML = 
                    '<div class="text-center py-10 text-gray-400">ÏÇ¨ÏõêÏùÑ Í≤ÄÏÉâÌïòÍ±∞ÎÇò "Ï†ÑÏ≤¥ Î≥¥Í∏∞"Î•º ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</div>';
                return;
            }
            const filtered = historyEmployeeData.filter(emp => 
                emp.employee.toLowerCase().includes(searchTerm)
            );
            renderEmployeeAnalysisCards(filtered);
        });
    }

    if (historyShowAllBtn) {
        historyShowAllBtn.addEventListener('click', () => {
            renderEmployeeAnalysisCards(historyEmployeeData.slice(0, 20));
        });
    }

    function renderEmployeeAnalysisCards(employees) {
        const resultsContainer = document.getElementById('history-employee-results');
        resultsContainer.innerHTML = '';

        if (employees.length === 0) {
            resultsContainer.innerHTML = '<div class="text-center py-10 text-gray-400">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
            return;
        }

        employees.forEach((emp) => {
            const card = document.createElement('div');
            card.className = 'employee-analysis-card';
            
            const rank = historyEmployeeData.findIndex(e => e.employee === emp.employee) + 1;
            const rankBadge = rank <= 3 ? (rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â') : `#${rank}`;

            card.innerHTML = `
                <div class="employee-name-header">
                    <span>${emp.employee.split('(')[0].trim()}</span>
                    <span style="font-size: 1.5rem;">${rankBadge}</span>
                </div>
                
                <div class="employee-stats-grid">
                    <div class="employee-stat-item">
                        <div class="employee-stat-label">ÌèâÍ∑† HTP</div>
                        <div class="employee-stat-value" style="color: ${emp.avgHtp >= 90 ? '#4ade80' : '#f87171'};">
                            ${emp.avgHtp.toFixed(1)}
                        </div>
                    </div>
                    <div class="employee-stat-item">
                        <div class="employee-stat-label">Ï¥ù Í∑ºÎ¨¥ÏùºÏàò</div>
                        <div class="employee-stat-value">${emp.totalDays}Ïùº</div>
                    </div>
                    <div class="employee-stat-item">
                        <div class="employee-stat-label">ÎàÑÏ†Å ÏûëÏóÖÎüâ</div>
                        <div class="employee-stat-value">${emp.totalQty.toLocaleString()}</div>
                    </div>
                    <div class="employee-stat-item">
                        <div class="employee-stat-label">ÏµúÏ†Å Í≥µÏ†ï</div>
                        <div class="employee-stat-value">
                            <span class="performance-badge ${emp.bestProcess.toLowerCase()}">
                                ${emp.bestProcess} ${emp.bestProcessHtp.toFixed(1)}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="best-performance-section">
                    <div class="best-performance-title">‚≠ê ÏµúÍ≥† Ìö®Ïú® ÏûëÏóÖ ÏúÑÏπò</div>
                    <div class="best-performance-detail">
                        ${emp.bestProcess === 'PICK' && emp.bestPP ? 
                            `<strong>PICK (ÏßëÌíà)</strong><br/>üîπ ÏµúÍ≥† Ìö®Ïú® PP: <strong>${emp.bestPP}</strong><br/>üîπ HTP: <strong style="color: #4ade80;">${emp.bestPPHtp.toFixed(1)}</strong>` :
                            emp.bestProcess === 'PACK' && emp.bestPackType ?
                            `<strong>PACK (Ìè¨Ïû•)</strong><br/>üîπ ÏµúÍ≥† Ìö®Ïú® Ìå© Ï¢ÖÎ•ò: <strong>${emp.bestPackType}</strong><br/>üîπ HTP: <strong style="color: #fbbf24;">${emp.bestPackTypeHtp.toFixed(1)}</strong>` :
                            'Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ï§ë...'}
                    </div>
                </div>
            `;

            card.addEventListener('click', () => {
                const processType = emp.bestProcess === 'PICK' ? 'PICK(ÏßëÌíà)' : 'PACK(Ìè¨Ïû•)';
                showEmployeeDetailModal(emp.employee, processType);
            });

            resultsContainer.appendChild(card);
        });
    }

    function showEmployeeDetailModal(employeeName, processType) {
        // Î±ÉÏßÄ Î®ºÏ†Ä Í≥ÑÏÇ∞
        ensureBadgesCalculated();
        
        // ÏÇ¨Ïõê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const employeeBadge = employeeBadges[employeeName];
        
        if (!employeeBadge) {
            showModal(`${employeeName}Ïùò Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
            return;
        }
        
        const badges = employeeBadge.badges || [];
        const records = employeeBadge.records || {};
        
        // ÌòÑÏû¨ ÌÖåÎßà ÌôïÏù∏
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        
        // ÌÖåÎßàÎ≥Ñ ÏÉâÏÉÅ Ï†ïÏùò
        const colors = isDark ? {
            title: 'text-white',
            subtitle: 'text-yellow-400',
            noBadge: 'text-gray-400',
            cardBg: 'bg-gray-800',
            labelText: 'text-gray-400',
            valueGreen: 'text-green-400',
            valueBlue: 'text-blue-400',
            valuePurple: 'text-purple-400',
            valueOrange: 'text-orange-400',
            valueRed: 'text-red-400'
        } : {
            title: 'text-gray-900',
            subtitle: 'text-orange-600',
            noBadge: 'text-gray-500',
            cardBg: 'bg-gradient-to-br from-blue-50 to-purple-50',
            labelText: 'text-gray-600',
            valueGreen: 'text-green-600',
            valueBlue: 'text-blue-600',
            valuePurple: 'text-purple-600',
            valueOrange: 'text-orange-600',
            valueRed: 'text-red-600'
        };
        
        // Î±ÉÏßÄ HTML ÏÉùÏÑ±
        let badgesHTML = '';
        if (badges.length > 0) {
            badgesHTML = badges.map(badge => 
                `<span class="inline-block px-3 py-1 m-1 rounded-lg bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold shadow-lg cursor-help transition-transform hover:scale-110" title="üìå ${badge.desc || 'ÌäπÎ≥ÑÌïú Î±ÉÏßÄ'}">
                    ${badge.name}
                </span>`
            ).join('');
        } else {
            badgesHTML = `<p class="${colors.noBadge}">ÏïÑÏßÅ ÌöçÎìùÌïú Î±ÉÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>`;
        }
        
        // Î™®Îã¨ ÎÇ¥Ïö© ÏÉùÏÑ±
        const modalContent = `
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4 ${colors.title}">üë§ ${employeeName}</h2>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2 ${colors.subtitle}">üèÖ ÌöçÎìù Î±ÉÏßÄ</h3>
                    <div class="flex flex-wrap">
                        ${badgesHTML}
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="${colors.cardBg} p-4 rounded-lg shadow-md border ${isDark ? 'border-gray-700' : 'border-blue-200'}">
                        <p class="${colors.labelText} text-sm font-semibold">ÏµúÍ≥† HTP</p>
                        <p class="text-2xl font-bold ${colors.valueGreen}">${records.maxHtp || 0}</p>
                    </div>
                    <div class="${colors.cardBg} p-4 rounded-lg shadow-md border ${isDark ? 'border-gray-700' : 'border-blue-200'}">
                        <p class="${colors.labelText} text-sm font-semibold">ÌèâÍ∑† HTP</p>
                        <p class="text-2xl font-bold ${colors.valueBlue}">${records.avgHtp ? records.avgHtp.toFixed(1) : 0}</p>
                    </div>
                    <div class="${colors.cardBg} p-4 rounded-lg shadow-md border ${isDark ? 'border-gray-700' : 'border-blue-200'}">
                        <p class="${colors.labelText} text-sm font-semibold">Ï¥ù Í∑ºÎ¨¥Ïùº</p>
                        <p class="text-2xl font-bold ${colors.valuePurple}">${records.totalDays || 0}Ïùº</p>
                    </div>
                    <div class="${colors.cardBg} p-4 rounded-lg shadow-md border ${isDark ? 'border-gray-700' : 'border-blue-200'}">
                        <p class="${colors.labelText} text-sm font-semibold">Ï¥ù ÏûëÏóÖÎüâ</p>
                        <p class="text-2xl font-bold ${colors.valueOrange}">${(records.totalQty || 0).toLocaleString()}</p>
                    </div>
                </div>
                
                <div class="${colors.cardBg} p-4 rounded-lg shadow-md border ${isDark ? 'border-gray-700' : 'border-blue-200'}">
                    <p class="${colors.labelText} text-sm font-semibold">Ïó∞ÏÜç Í∑ºÎ¨¥ ÏµúÎåÄ</p>
                    <p class="text-xl font-bold ${colors.valueRed}">${records.maxConsecutiveDays || 0}Ïùº üî•</p>
                </div>
            </div>
        `;
        
        showEmployeeModal(modalContent);
    }

    function exportHistoryToExcel() {
        showModal('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Í∏∞Îä•ÏùÄ Í≥ß Ï∂îÍ∞ÄÎê† ÏòàÏ†ïÏûÖÎãàÎã§.');
    }

    function exportHistoryToPDF() {
        showModal('PDF Î¶¨Ìè¨Ìä∏ Í∏∞Îä•ÏùÄ Í≥ß Ï∂îÍ∞ÄÎê† ÏòàÏ†ïÏûÖÎãàÎã§.');
    }

    // üöÄ ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¶âÏãú Ï¥àÍ∏∞Ìôî
    // üöÄ ÌéòÏù¥ÏßÄ ÏôÑÏ†ÑÌûà Î°úÎìúÎêú ÌõÑ Ï¥àÍ∏∞Ìôî (Î™®Îì† Ìï®Ïàò Ï†ïÏùò ÌõÑ)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        // Ïù¥ÎØ∏ Î°úÎìúÎê®
        initializePage();
    }
    
    function initializePage() {
        console.log('üéØ ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî ÏãúÏûë');
        
        // Ìã∞Ïª§ Ï¶âÏãú ÌëúÏãú (Îç∞Ïù¥ÌÑ∞ ÏóÜÏñ¥ÎèÑ ÏïàÎÇ¥ Î©îÏãúÏßÄ ÌëúÏãú)
        if (typeof updateTicker === 'function') {
            updateTicker([]);
            console.log('‚úÖ Ìã∞Ïª§ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        } else {
            console.warn('‚ö†Ô∏è updateTicker Ìï®Ïàò ÏïÑÏßÅ Ï†ïÏùò ÏïàÎê®');
        }
        
        // ÌÖåÎßà Ï†ÅÏö©
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        console.log('‚úÖ ÌÖåÎßà Ï†ÅÏö© ÏôÑÎ£å:', savedTheme);
        
        // üÜï ÏûêÎèôÏúºÎ°ú ÏµúÍ∑º 7Ïùº ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
        console.log('üì¶ ÏµúÍ∑º 7Ïùº ÌûàÏä§ÌÜ†Î¶¨ ÏûêÎèô Î°úÎìú ÏãúÏûë...');
        setTimeout(() => {
            if (typeof loadHistoryData === 'function') {
                loadHistoryData(7).then(() => {
                    console.log('‚úÖ Ï¥àÍ∏∞ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú ÏôÑÎ£å');
                }).catch(err => {
                    console.log('‚ö†Ô∏è Ï¥àÍ∏∞ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú Ïã§Ìå®:', err.message);
                });
            }
        }, 500); // 0.5Ï¥à ÌõÑ Ïã§Ìñâ (Firebase Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞)
    }
</script>
</body>
</html>