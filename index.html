<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GWJ2 CFC PICK & PACK HTP TOOL_Bennett (v2.0.0)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/qogmlwo000/gwj2pickpackhtp/main/Bennett.ico" type="image/x-icon">

    <!-- Open Graph Meta Tags for Link Preview -->
    <meta property="og:title" content="CFC PICK & PACK HTP TOOL_Bennett">
    <meta property="og:description" content="ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì‹¤ì‹œê°„ìœ¼ë¡œ HTP ë°ì´í„°ë¥¼ ê³µìœ í•˜ê³  ë¶„ì„í•˜ì„¸ìš”.">
    <meta property="og:image" content="https://github.com/qogmlwo000/gwj2pickpackhtp/blob/main/Bennett.png?raw=true">
    <meta property="og:url" content="https://qogmlwo000.github.io/gwj2pickpackhtpcfc/">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use xlsx-js-style for advanced styling in Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add pako.js for Gzip compression to handle large data -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <!-- Add Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add Chart.js Datalabels plugin for displaying values on charts -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scrollbar-width: thin; scrollbar-color: #4a5568 #2d3748; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 4px; }
        
        /* Layout adjustments for sidebar */
        .app-container { display: flex; height: 100vh; }
        #sidebar {
            width: 300px;
            transition: margin-left 0.3s ease-in-out, transform 0.3s ease-in-out;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 40;
            transform: translateX(-100%);
        }
        #sidebar.open { transform: translateX(0); }
        #main-content {
            transition: margin-left 0.3s ease-in-out;
            width: 100%;
        }

        @media (min-width: 1024px) {
            #sidebar {
                position: static;
                transform: translateX(0);
            }
            #main-content {
                flex: 1;
                min-width: 0; /* Prevents content from overflowing */
            }
            .app-container.sidebar-collapsed #sidebar {
                margin-left: -300px;
            }
            #sidebar-toggle-desktop { display: block; }
            #sidebar-toggle-mobile { display: none; }
        }
        @media (max-width: 1023px) {
            #sidebar-toggle-desktop { display: none; }
            #sidebar-toggle-mobile { display: block; }
        }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-connected { background-color: #22c55e; }
        .status-disconnected { background-color: #ef4444; }
        .status-loading { background-color: #f59e0b; animation: pulse 1.5s infinite; }
        .loader { border: 4px solid #4a5568; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .filter-btn.active { background-color: #2563eb; color: white; }
        .filter-group-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; }
        
        #main-title { animation: color-cycle 10s infinite linear; }
        @keyframes color-cycle {
            0%   { color: #FF0000; } 14%  { color: #FF7F00; } 28%  { color: #FFFF00; }
            42%  { color: #00FF00; } 57%  { color: #0000FF; } 71%  { color: #4B0082; }
            85%  { color: #9400D3; } 100% { color: #FF0000; }
        }
        
        #ticker-container { overflow: hidden; white-space: nowrap; position: relative; }
        #ticker-text { position: absolute; animation: ticker-scroll 20s linear infinite; color: #FFD700; font-weight: bold; }
        @keyframes ticker-scroll {
            0%   { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .sortable { cursor: pointer; position: relative; }
        .sort-indicator { display: inline-block; width: 1em; height: 1em; margin-left: 4px; vertical-align: middle; opacity: 0.5; transition: opacity 0.2s; }
        .sortable:hover .sort-indicator { opacity: 1; }
        .sort-indicator.asc, .sort-indicator.desc { opacity: 1; color: #60a5fa; }

        /* Table Container: Full height with horizontal scroll */
        .table-container { 
            flex-grow: 1; /* Take up remaining vertical space */
            overflow: auto; /* Enable both vertical and horizontal scrolling */
            -webkit-overflow-scrolling: touch; /* Momentum-based scrolling on iOS */
        }
        
        /* Table Border Styles */
        #data-table th, #data-table td {
            border-right: 1px solid #374151;
            white-space: nowrap; /* Prevent text wrapping in cells */
        }
        #data-table th:last-child, #data-table td:last-child {
            border-right: none;
        }

        /* Hide column if it has this class */
        .hidden-col {
            display: none;
        }

        /* --- Custom Checkbox Styles --- */
        .form-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.1rem;
            height: 1.1rem;
            border: 1px solid #6b7280; /* gray-500 */
            border-radius: 0.25rem;
            background-color: #4b5563; /* gray-600 */
            transition: background-color 0.2s, border-color 0.2s;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            flex-shrink: 0;
        }
        .form-checkbox:checked {
            background-color: #3b82f6; /* blue-500 */
            border-color: #3b82f6;
        }
        .form-checkbox:checked::after {
            content: 'âœ”';
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
        }
        .form-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }

        /* --- View Switcher Tabs --- */
        .view-tab {
            transition: background-color 0.2s, color 0.2s;
        }
        .view-tab.active {
            background-color: #3b82f6;
            color: white;
        }

        /* --- Chart Modal --- */
        #chart-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        #chart-modal-content {
            max-height: 80vh;
        }

        /* --- Dashboard KPI Card --- */
        .kpi-card {
            background-color: #1f2937; /* gray-800 */
            border-left: 4px solid #3b82f6; /* blue-500 */
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200">

<div id="app-container" class="app-container">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-gray-800 p-4 flex-shrink-0 flex flex-col space-y-4 overflow-y-auto">
        <h2 class="text-xl font-bold text-white border-b border-gray-700 pb-2">âš™ï¸ í•„í„° ë° ì„¤ì •</h2>
        
        <!-- Time Filters -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">â° ì‹œê°„ëŒ€ë³„ í•„í„°</h3>
            <div class="space-y-2">
                <label class="flex items-center space-x-2 text-sm cursor-pointer"><input type="checkbox" id="all-hours-checkbox" class="form-checkbox" checked><span>ì „ì²´ ì‹œê°„</span></label>
                <div id="hour-filters" class="filter-group-grid pt-2 border-t border-gray-600"></div>
                <div class="flex space-x-2 pt-2 border-t border-gray-600">
                    <button id="select-all-hours" class="text-xs py-1 px-2 rounded bg-gray-600 hover:bg-gray-500 w-full">ëª¨ë‘ ì„ íƒ</button>
                    <button id="deselect-all-hours" class="text-xs py-1 px-2 rounded bg-gray-600 hover:bg-gray-500 w-full">ëª¨ë‘ í•´ì œ</button>
                </div>
            </div>
        </div>

        <!-- Floor Filters -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">ğŸ“¶ ì¸µë³„ í•„í„° (ì§‘í’ˆ)</h3>
            <div id="floor-filters" class="space-y-2"></div>
            <div class="flex space-x-2 pt-2 mt-2 border-t border-gray-600">
                <button id="select-all-floors" class="text-xs py-1 px-2 rounded bg-gray-600 hover:bg-gray-500 w-full">ëª¨ë‘ ì„ íƒ</button>
                <button id="deselect-all-floors" class="text-xs py-1 px-2 rounded bg-gray-600 hover:bg-gray-500 w-full">ëª¨ë‘ í•´ì œ</button>
            </div>
        </div>

        <!-- Pack Type Filters -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">ğŸ“¦ íŒ© ì¢…ë¥˜ í•„í„° (í¬ì¥)</h3>
            <div id="pack-type-filters" class="space-y-2"></div>
             <div class="flex space-x-2 pt-2 mt-2 border-t border-gray-600">
                <button id="select-all-packtypes" class="text-xs py-1 px-2 rounded bg-gray-600 hover:bg-gray-500 w-full">ëª¨ë‘ ì„ íƒ</button>
                <button id="deselect-all-packtypes" class="text-xs py-1 px-2 rounded bg-gray-600 hover:bg-gray-500 w-full">ëª¨ë‘ í•´ì œ</button>
            </div>
        </div>
        
        <!-- Target HTP Settings -->
        <div class="bg-gray-700 p-3 rounded-lg">
            <h3 class="font-semibold mb-2 text-white">ğŸ¯ Target HTP ì„¤ì •</h3>
            <div id="target-htp-settings" class="space-y-2 text-sm"></div>
        </div>
    </aside>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 flex flex-col">
        <div class="w-full bg-gray-800 shadow-lg p-4 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button id="sidebar-toggle-desktop" class="p-2 rounded-md hover:bg-gray-700 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <button id="sidebar-toggle-mobile" class="p-2 rounded-md hover:bg-gray-700 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div>
                        <h1 id="main-title" class="text-2xl font-extrabold">ğŸš€ GWJ2 CFC OB PICK & PACK HTP TOOL</h1>
                        <p class="text-gray-400 text-sm">í•œ ëª…ì´ ì—‘ì…€ì„ ì˜¬ë¦¬ë©´ ëª¨ë‘ì—ê²Œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <div id="status-indicator" class="flex items-center">
                    <div class="status-dot status-disconnected"></div>
                    <span class="font-medium text-sm">ì—°ê²° ìƒíƒœ: í™•ì¸ ì¤‘...</span>
                </div>
            </div>
        </div>

        <div class="p-4 space-y-4 flex flex-col flex-shrink-0">
            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-800 p-3 rounded-lg flex items-center space-x-2">
                    <button id="filter-all" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md hover:bg-gray-600 active">ì „ì²´</button>
                    <button id="filter-pick" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md hover:bg-gray-600">ğŸŸ¦ PICK</button>
                    <button id="filter-pack" class="filter-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md hover:bg-gray-600">ğŸŸ¨ PACK</button>
                </div>
                <div class="bg-gray-800 p-3 rounded-lg flex items-center">
                    <input type="text" id="search-input" placeholder="ğŸ” ì´ë¦„(ì›ë°”ì½”ë“œ) ê²€ìƒ‰..." class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="bg-gray-800 p-3 rounded-lg flex items-center space-x-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="low-htp-toggle" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                        <span class="ml-3 text-sm font-medium">ğŸš¨ ì €ì¡°ìë§Œ ë³´ê¸°</span>
                    </label>
                    <button id="capture-btn" class="py-2 px-3 text-sm font-semibold rounded-md hover:bg-gray-600">ğŸ“· ìº¡ì²˜</button>
                    <button id="export-btn" class="py-2 px-3 text-sm font-semibold rounded-md hover:bg-gray-600">ğŸ“Š ì—‘ì…€</button>
                </div>
            </div>
            
            <!-- Ticker -->
            <div id="ticker-container" class="bg-gray-800 p-2 rounded-lg text-sm">
                <div id="ticker-text-wrapper" class="relative w-full h-5 overflow-hidden">
                    <span id="ticker-text">Top/Low HTP ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
                </div>
            </div>

            <!-- Stats & Upload -->
            <div class="bg-gray-800 p-3 rounded-lg flex flex-col md:flex-row justify-between items-center text-sm">
                 <div id="stats-display" class="text-gray-300 mb-2 md:mb-0 text-center md:text-left">
                    í‘œì‹œ ê·¸ë£¹: <span class="font-bold text-white">-</span> | 
                    ì‘ì—…ì ìˆ˜: <span class="font-bold text-white">-</span> | 
                    ì´ ì‘ì—…ëŸ‰: <span class="font-bold text-white">-</span> | 
                    í‰ê·  HTP: <span class="font-bold text-white">-</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-updated" class="font-semibold text-gray-200">ë°ì´í„° ì—†ìŒ</span></p>
                        <p>ì—…ë¡œë”: <span id="last-uploader" class="font-semibold text-gray-200">ë°ì´í„° ì—†ìŒ</span></p>
                    </div>
                    <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls">
                    <label for="file-upload" class="cursor-pointer py-2 px-4 rounded-lg border-0 text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700">ì—‘ì…€ ì—…ë¡œë“œ</label>
                </div>
            </div>
        </div>

        <!-- View Switcher -->
        <div class="px-4 pt-2">
            <div class="bg-gray-800 p-1 rounded-lg flex space-x-1">
                <button id="table-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md active">ë°ì´í„° ë³´ê¸°</button>
                <button id="dashboard-view-btn" class="view-tab flex-1 py-2 px-3 text-sm font-semibold rounded-md">ëŒ€ì‹œë³´ë“œ</button>
            </div>
        </div>

        <!-- Table View -->
        <div id="table-view" class="flex flex-col flex-grow min-h-0">
            <div id="loader-container" class="flex-1 flex justify-center items-center hidden"><div class="loader"></div></div>
            <div class="table-container px-4 pb-4">
                <table id="data-table" class="min-w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="processType">ì§‘í’ˆ/í¬ì¥<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="employee">ì´ë¦„(ì›ë°”ì½”ë“œ)<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="unitQty">ì‘ì—…ëŸ‰<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="location">ë¡œì¼€ì´ì…˜ ë° ì‘ì—…ëŒ€<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="processPathName">PP<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="packType">íŒ© ì¢…ë¥˜<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="mh">M/H<span class="sort-indicator"></span></th>
                            <th scope="col" class="px-4 py-3 sortable" data-sort-key="htp">HTP<span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-gray-800">
                        <tr id="placeholder-row"><td colspan="8" class="text-center py-10 text-gray-500">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden flex-col flex-grow min-h-0 p-4 space-y-4 overflow-y-auto">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ì´ ì‘ì—…ì ìˆ˜</h4>
                    <p id="kpi-total-workers" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ì´ ì‘ì—…ëŸ‰ (Unit)</h4>
                    <p id="kpi-total-qty" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow">
                    <h4 class="text-gray-400 text-sm font-medium">ì „ì²´ í‰ê·  HTP</h4>
                    <p id="kpi-avg-htp" class="text-3xl font-bold text-white">0.0</p>
                </div>
                <div class="kpi-card p-4 rounded-lg shadow border-l-red-500">
                    <h4 class="text-gray-400 text-sm font-medium">ì €ì¡°ì ìˆ˜</h4>
                    <p id="kpi-low-performers" class="text-3xl font-bold text-red-400">0</p>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                <!-- Process Comparison Chart -->
                <div class="bg-gray-800 p-4 rounded-lg xl:col-span-1">
                    <h3 class="text-lg font-semibold mb-2 text-white">í”„ë¡œì„¸ìŠ¤ë³„ ë¹„êµ</h3>
                    <div class="relative h-64 md:h-80">
                        <canvas id="process-comparison-chart"></canvas>
                    </div>
                </div>
                <!-- Hourly HTP Trend -->
                <div class="bg-gray-800 p-4 rounded-lg xl:col-span-2">
                    <h3 class="text-lg font-semibold mb-2 text-white">ì‹œê°„ëŒ€ë³„ HTP íŠ¸ë Œë“œ</h3>
                    <div class="relative h-64 md:h-80">
                        <canvas id="hourly-htp-chart"></canvas>
                    </div>
                </div>
                <!-- Floor HTP Chart -->
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-white">ì¸µë³„ í‰ê·  HTP (ì§‘í’ˆ)</h3>
                    <div class="relative h-96">
                        <canvas id="floor-htp-chart"></canvas>
                    </div>
                </div>
                <!-- Pack Type Chart -->
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-white">íŒ© ì¢…ë¥˜ë³„ ì‘ì—…ëŸ‰ (í¬ì¥)</h3>
                    <div class="relative h-96">
                        <canvas id="pack-type-chart"></canvas>
                    </div>
                </div>
                <!-- Performer Lists -->
                <div class="bg-gray-800 p-4 rounded-lg lg:col-span-2 xl:col-span-1">
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 h-full">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-white">ğŸ† Top 5 Performers</h3>
                            <ul id="top-performers-list" class="space-y-2 text-sm">
                                <!-- JS will populate this -->
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-white">ğŸš¨ Low 5 Performers</h3>
                            <ul id="low-performers-list" class="space-y-2 text-sm">
                                <!-- JS will populate this -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Chart Modal -->
<div id="chart-modal-backdrop" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div id="chart-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl p-6 relative flex flex-col">
        <h3 id="chart-modal-title" class="text-xl font-bold text-white mb-4">ê°œì¸ HTP ì¶”ì´</h3>
        <div class="flex-grow min-h-0">
             <canvas id="individual-htp-chart"></canvas>
        </div>
        <button id="chart-modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
</div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, Bytes } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- UI Elements ---
        const ui = {
            appContainer: document.getElementById('app-container'),
            fileUpload: document.getElementById('file-upload'),
            tableBody: document.getElementById('data-table-body'),
            tableHeader: document.querySelector('#data-table thead'),
            placeholderRow: document.getElementById('placeholder-row'),
            loaderContainer: document.getElementById('loader-container'),
            statusIndicator: document.getElementById('status-indicator'),
            lastUpdatedEl: document.getElementById('last-updated'),
            lastUploaderEl: document.getElementById('last-uploader'),
            sidebar: document.getElementById('sidebar'),
            sidebarToggleDesktop: document.getElementById('sidebar-toggle-desktop'),
            sidebarToggleMobile: document.getElementById('sidebar-toggle-mobile'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            floorFilters: document.getElementById('floor-filters'),
            packTypeFilters: document.getElementById('pack-type-filters'),
            hourFilters: document.getElementById('hour-filters'),
            searchInput: document.getElementById('search-input'),
            lowHtpToggle: document.getElementById('low-htp-toggle'),
            statsDisplay: document.getElementById('stats-display'),
            captureBtn: document.getElementById('capture-btn'),
            exportBtn: document.getElementById('export-btn'),
            targetHtpSettings: document.getElementById('target-htp-settings'),
            tickerText: document.getElementById('ticker-text'),
            tableViewBtn: document.getElementById('table-view-btn'),
            dashboardViewBtn: document.getElementById('dashboard-view-btn'),
            tableView: document.getElementById('table-view'),
            dashboardView: document.getElementById('dashboard-view'),
            chartModalBackdrop: document.getElementById('chart-modal-backdrop'),
            chartModalTitle: document.getElementById('chart-modal-title'),
            chartModalClose: document.getElementById('chart-modal-close'),
            // New Dashboard UI Elements
            kpi: {
                totalWorkers: document.getElementById('kpi-total-workers'),
                totalQty: document.getElementById('kpi-total-qty'),
                avgHtp: document.getElementById('kpi-avg-htp'),
                lowPerformers: document.getElementById('kpi-low-performers'),
            },
            topPerformersList: document.getElementById('top-performers-list'),
            lowPerformersList: document.getElementById('low-performers-list'),
        };

        // --- Global State ---
        let globalRawData = []; 
        let state = {
            filters: {
                process: 'all', search: '', lowHtp: false,
                hours: new Set(), floors: new Set(), packTypes: new Set()
            },
            sort: {
                key: 'htp', // Default sort key
                direction: 'asc' // 'asc', 'desc', or null
            },
            charts: { // To hold chart instances
                floorHtp: null,
                packType: null,
                individualHtp: null,
                processComparison: null,
                hourlyHtp: null,
            }
        };
        let targetHtpValues = {};

        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyAKxH0QXnVTQMpfWJYdMUhHoMIwF89bgjU",
			authDomain: "gwj2-cfchtp-tool.firebaseapp.com",
			projectId: "gwj2-cfchtp-tool",
			storageBucket: "gwj2-cfchtp-tool.firebasestorage.app",
			messagingSenderId: "870169870004",
			appId: "1:870169870004:web:aaf9034bb1dd5eb07621e1",
			measurementId: "G-0E55KNF6GB"
        };
        let db, auth, userId, dataDocRef;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            dataDocRef = doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'htpData', 'latestCompressed');
        } catch(e) {
            console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
            updateStatus('disconnected', 'Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                updateStatus('connected', 'ì‹¤ì‹œê°„ ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                ui.fileUpload.disabled = false;
                setupRealtimeListener();
            } else {
                try { await signInAnonymously(auth); } catch (error) {
                    console.error("ìµëª… ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                    updateStatus('disconnected', 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        });

        // --- Realtime Listener ---
        function setupRealtimeListener() {
            onSnapshot(dataDocRef, (docSnap) => {
                showLoader();
                if (docSnap.exists()) {
                    const dataPayload = docSnap.data();
                    try {
                        const compressedBytes = dataPayload.compressedData;
                        if (!compressedBytes) throw new Error("ì••ì¶•ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

                        const compressedUint8Array = compressedBytes.toUint8Array();
                        const decompressedString = pako.ungzip(compressedUint8Array, { to: 'string' });
                        const parsedData = JSON.parse(decompressedString); 

                        // Convert date strings back to Date objects
                        globalRawData = parsedData.map(item => ({
                            ...item,
                            htpStart: new Date(item.htpStart),
                            htpEnd: new Date(item.htpEnd),
                        }));

                        ui.lastUploaderEl.textContent = dataPayload.uploaderId.substring(0, 8) + '...';
                        ui.lastUpdatedEl.textContent = new Date(dataPayload.timestamp).toLocaleString('ko-KR');
                        
                        initializeFiltersFromData(globalRawData);
                        applyFiltersAndRender();
                    } catch (error) {
                        console.error("ë°ì´í„° ì••ì¶• í•´ì œ ë˜ëŠ” íŒŒì‹± ì˜¤ë¥˜:", error);
                        showModal("ì„œë²„ë¡œë¶€í„° ë°›ì€ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                        globalRawData = [];
                        applyFiltersAndRender();
                    }
                } else {
                    globalRawData = [];
                    initializeFiltersFromData([]);
                    applyFiltersAndRender();
                }
                hideLoader();
            }, (error) => {
                console.error("ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜:", error);
                updateStatus('disconnected', 'ë°ì´í„° ìˆ˜ì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                hideLoader();
            });
        }
        
        // --- Event Listeners ---
        function toggleMobileSidebar() {
            const isOpen = ui.sidebar.classList.toggle('open');
            ui.sidebarOverlay.classList.toggle('hidden', !isOpen);
        }
        function toggleDesktopSidebar() {
            ui.appContainer.classList.toggle('sidebar-collapsed');
        }

        ui.sidebarToggleMobile.addEventListener('click', toggleMobileSidebar);
        ui.sidebarToggleDesktop.addEventListener('click', toggleDesktopSidebar);
        ui.sidebarOverlay.addEventListener('click', toggleMobileSidebar);

        ui.fileUpload.addEventListener('change', handleFileUpload);
        ui.searchInput.addEventListener('input', (e) => {
            state.filters.search = e.target.value.toLowerCase();
            applyFiltersAndRender();
        });
        ui.lowHtpToggle.addEventListener('change', (e) => {
            state.filters.lowHtp = e.target.checked;
            applyFiltersAndRender();
        });
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                state.filters.process = e.currentTarget.id.replace('filter-', '');
                applyFiltersAndRender();
            });
        });
        ui.captureBtn.addEventListener('click', captureTable);
        ui.exportBtn.addEventListener('click', exportToExcel);

        ui.tableHeader.addEventListener('click', (e) => {
            const headerCell = e.target.closest('.sortable');
            if (!headerCell) return;

            const sortKey = headerCell.dataset.sortKey;
            if (state.sort.key === sortKey) {
                if (state.sort.direction === 'asc') state.sort.direction = 'desc';
                else if (state.sort.direction === 'desc') {
                    state.sort.key = 'htp'; 
                    state.sort.direction = 'asc';
                }
            } else {
                state.sort.key = sortKey;
                state.sort.direction = 'asc';
            }
            applyFiltersAndRender();
        });

        // View switcher logic
        ui.tableViewBtn.addEventListener('click', () => {
            ui.tableView.classList.remove('hidden');
            ui.dashboardView.classList.add('hidden');
            ui.tableViewBtn.classList.add('active');
            ui.dashboardViewBtn.classList.remove('active');
        });

        ui.dashboardViewBtn.addEventListener('click', () => {
            ui.tableView.classList.add('hidden');
            ui.dashboardView.classList.remove('hidden');
            ui.dashboardView.classList.add('flex'); // Use flex for proper layout
            ui.tableViewBtn.classList.remove('active');
            ui.dashboardViewBtn.classList.add('active');
        });
        
        // Individual Chart Modal Logic
        ui.tableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row || row.id === 'placeholder-row') return;
            const employeeCell = row.querySelector('td:nth-child(2)');
            const processCell = row.querySelector('td:nth-child(1)');
            if(employeeCell && processCell) {
                const employeeName = employeeCell.textContent.replace(/[ğŸ‘‘]\s*/g, '');
                const processType = processCell.textContent; // "PICK(ì§‘í’ˆ)" or "PACK(í¬ì¥)"
                showIndividualTrend(employeeName, processType);
            }
        });

        ui.chartModalClose.addEventListener('click', () => {
            ui.chartModalBackdrop.classList.add('hidden');
            ui.chartModalBackdrop.classList.remove('flex');
        });
        ui.chartModalBackdrop.addEventListener('click', (e) => {
            if (e.target === ui.chartModalBackdrop) {
                ui.chartModalBackdrop.classList.add('hidden');
                ui.chartModalBackdrop.classList.remove('flex');
            }
        });


        // --- Data Processing Constants ---
        const PACK_TYPE_MAP = {
            "ë©”ë‰´ì–¼íŒ©": "179_1.3F_MA_S_OG_", "ë©”ë‰´ì–¼íŒ© ë©€í‹°": "179_1.3F_MA_M_OG_", "ACE LINE": "179-1.2F-MA-ACE-OG-",
            "ì˜¤í† ë°± 1.2": "179_1.3F_AB_R1.2_OG_", "ì˜¤í† ë°± 2.5": "179_1.3F_AB_R2.5_OG_", "ì˜¤í† ë°± 4.0": "179_1.3F_AB_R4.0_OG_",
            "ì˜¤í† ë°± RTPB": "179_1.3F_AB_T1_OG_", "ì˜¤í† ë°± ë©€í‹°": "179_1.3F_AB_M_OG_", "CFC ë©”ë‰´ì–¼íŒ©": "190_6.2F_MA_S_OG_",
            "CFC ë©”ë‰´ì–¼íŒ© ë©€í‹°": "190_6.2F_MA_M_OG_", "CFC ì˜¤í† ë°± 2.5": "190_6.2F_AB_R2.5_OG_", "CFC ì˜¤í† ë°± 4.0": "190_6.2F_AB_R4.0_OG_",
            "CFC ì˜¤í† ë°± RTPB": "190_6.2G_AB_T1_OG_"
        };
        const DEFAULT_PACK_TYPE = "ê¸°íƒ€";
        const MANAGERS_LIST = ['26485305', '94354606', '66476877', '21284456', '24856615', '21019991', '87406548', '29801698', '27407697', '92816677', '65712250', '29787775', '37005613', '24304330', '27507426', '97224272', '92718820', '83689729', '36148186', '98659377', '97724155', '96792527', '24624169', '64118293', '50908038', '21220693', '41310393', '30997520', '66536830', '92733138', '77358628', '39359504', '25657753', '29229926', '46802436', '58548628', '93246435', '42103385', '26152514', '95383395', '55540763', '53909931', '28996527', '96358817', '56805916', '62613130', '47848283', '39678603', '58728654', '38876677', '68100618', '56334308'];
        
        const TARGET_HTP_DEFAULTS = {
            "Manual SINGULATION": { value: 100, keywords: ['ManualPack', '179_1.3F_MA_S_OG_'] },
            "Manual MULTI":       { value: 120, keywords: ['7F_Multi_AGV', '179_1.3F_MA_M_OG_'] },
            "ACE LINE":           { value: 150, keywords: ['ACE', '179-1.2F-MA-ACE-OG-'] },
            "Autobagger 1.2":     { value: 380, keywords: ['Autobag1.2', '179_1.3F_AB_R1.2_OG_', 'AGV_Autobag1.2DW'] },
            "Autobagger 2.5":     { value: 350, keywords: ['Autobag2.5', '179_1.3F_AB_R2.5_OG_'] },
            "Autobagger 4.0":     { value: 280, keywords: ['Autobag4.0', '179_1.3F_AB_R4.0_OG_'] },
            "Autobagger RTPB":    { value: 150, keywords: ['Autobag_RTPB1', '179_1.3F_AB_T1_OG_'] },
            "Auto MULTI":         { value: 250, keywords: ['AGV_Multi_Autobag4.0', '179_1.3F_AB_M_OG_'] },
            "CFC Manual S":       { value: 100, keywords: ['190_6.2F_MA_S_OG_'] },
            "CFC Manual M":       { value: 120, keywords: ['190_6.2F_MA_M_OG_'] },
            "CFC Autobag 2.5":    { value: 350, keywords: ['190_6.2F_AB_R2.5_OG_'] },
            "CFC Autobag 4.0":    { value: 280, keywords: ['190_6.2F_AB_R4.0_OG_'] },
            "CFC Autobag RTPB":   { value: 150, keywords: ['190_6.2G_AB_T1_OG_'] },
            "PICK":               { value: 90, keywords: [] }
        };
        for(const key in TARGET_HTP_DEFAULTS) {
            targetHtpValues[key] = TARGET_HTP_DEFAULTS[key].value;
        }

        // --- Data Processing & Filtering ---
        function getPackType(location, processTask, processPathName) {
            if (processTask === 'PACK(PACKING)' && processPathName.includes('AGV_Multi_Autobag4.0') && location.startsWith('Pack at Rebin (Test')) {
                return "ì˜¤í† ë°± ë©€í‹°";
            }
            if (typeof location !== 'string') return DEFAULT_PACK_TYPE;
            for (const [name, prefix] of Object.entries(PACK_TYPE_MAP)) {
                if (location.startsWith(prefix)) return name;
            }
            return DEFAULT_PACK_TYPE;
        }

        function getTargetHtp(item) {
            if (item.processType.includes('PICK')) {
                return targetHtpValues['PICK'] || 0;
            }
            if (item.processType.includes('PACK')) {
                const processPathName = item.processPathName || "";
                for (const name in TARGET_HTP_DEFAULTS) {
                    if (name === "PICK") continue;
                    const config = TARGET_HTP_DEFAULTS[name];
                    if (config.keywords.some(keyword => processPathName.includes(keyword))) {
                        return targetHtpValues[name] || 0;
                    }
                }
                return targetHtpValues["Manual SINGULATION"] || 0;
            }
            return 0;
        }

        function parseExcelData(data) {
            if (data.length < 2) return [];
            const headers = data[0].map(h => h ? h.toString().toLowerCase().trim() : '');
            const COLS_TO_LOAD = {
                workDate: 'work date', employee: 'employee', unitQty: 'unit qty', location: 'location', floor: 'floor',
                processPathName: 'process path name', htpStart: 'htp start', htpEnd: 'htp end', processTask: 'process(task)',
                contractType: 'contract type'
            };
            const colIndices = {};
            const missingCols = [];
            for (const key in COLS_TO_LOAD) {
                const index = headers.indexOf(COLS_TO_LOAD[key]);
                if (index === -1 && key !== 'contractType') { // contractType is optional
                    missingCols.push(COLS_TO_LOAD[key]);
                }
                colIndices[key] = index;
            }
            if (missingCols.length > 0) throw new Error(`ì—‘ì…€ íŒŒì¼ì— ë‹¤ìŒ í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤:\n[${missingCols.join(', ')}]`);

            const rawData = data.slice(1).map(row => {
                const combineDateTime = (dateValue, timeValue) => {
                    if (!dateValue || !timeValue) return null;
                    let datePart = (typeof dateValue === 'number') ? new Date(Date.UTC(1899, 11, 30) + dateValue * 24 * 60 * 60 * 1000) : new Date(dateValue);
                    if (isNaN(datePart.getTime())) return null;
                    let timePart;
                    if (typeof timeValue === 'number') timePart = new Date(Date.UTC(1899, 11, 30) + timeValue * 24 * 60 * 60 * 1000);
                    else if (typeof timeValue === 'string') {
                        const parts = timeValue.split(':');
                        timePart = new Date(0);
                        timePart.setUTCHours(parts[0] || 0, parts[1] || 0, parts[2] || 0, 0);
                    } else timePart = timeValue;
                    if (isNaN(timePart.getTime())) return null;
                    return new Date(Date.UTC(datePart.getUTCFullYear(), datePart.getUTCMonth(), datePart.getUTCDate(), timePart.getUTCHours(), timePart.getUTCMinutes(), timePart.getUTCSeconds()));
                };
                const htpStart = combineDateTime(row[colIndices.workDate], row[colIndices.htpStart]);
                const htpEnd = combineDateTime(row[colIndices.workDate], row[colIndices.htpEnd]);
                if (!htpStart || !htpEnd) return null;
                
                // *** FIX: Exclude data with 0 or negative duration ***
                const durationSeconds = (htpEnd - htpStart) / 1000;
                if (durationSeconds <= 0) return null;

                let processTask = row[colIndices.processTask] || '';
                const location = row[colIndices.location] || '';
                const processPathName = row[colIndices.processPathName] || '';

                // Remap REBIN to PACK for new Autobag Multi format
                if (processTask === 'REBIN(REBIN)' && location.startsWith('Pack at Rebin (Test') && processPathName === '0. AGV_Multi_Autobag4.0 + ì¼ë°˜ì¡´ í†µí•©') {
                    processTask = 'PACK(PACKING)';
                }

                return {
                    employee: row[colIndices.employee] || '', unitQty: parseInt(row[colIndices.unitQty] || 0),
                    location: location, floor: row[colIndices.floor] || '',
                    processPathName: processPathName, processTask: processTask,
                    contractType: colIndices.contractType !== -1 ? (row[colIndices.contractType] || '').toUpperCase() : '',
                    htpStart: htpStart, htpEnd: htpEnd
                };
            }).filter(item => {
                if (!item || !item.employee || item.unitQty <= 0) return false;
                if (item.employee === 'AGV_Agent') return false;
                return item.processTask === 'PICK(PICKING)' || item.processTask === 'PACK(PACKING)';
            });
            
            return rawData;
        }

        /**
         * Aggregates raw data into groups for display.
         * This function is updated to ensure M/H calculation is accurate.
         */
        function aggregateData(rawData) {
            const aggregatedMap = new Map();

            rawData.forEach(item => {
                let key;
                let packType = null;

                if (item.processTask === 'PICK(PICKING)') {
                    key = `${item.employee}|${item.floor}|PICK`;
                    packType = 'ì§‘í’ˆ';
                } else { // PACK(PACKING)
                    packType = getPackType(item.location, item.processTask, item.processPathName);
                    key = `${item.employee}|${packType}|PACK`;
                }

                const durationSeconds = (item.htpEnd - item.htpStart) / 1000;
                if (durationSeconds <= 0) return; 

                if (!aggregatedMap.has(key)) {
                    const empIdMatch = item.employee.match(/\((.*?)\)/);
                    const empId = empIdMatch ? empIdMatch[1] : '';
                    aggregatedMap.set(key, {
                        processType: item.processTask.includes('PICK') ? 'PICK(ì§‘í’ˆ)' : 'PACK(í¬ì¥)',
                        employee: item.employee,
                        floor: item.floor,
                        unitQty: 0,
                        totalSeconds: 0,
                        location: item.location,
                        processPathName: item.processPathName,
                        packType: packType,
                        isManager: MANAGERS_LIST.includes(empId),
                        isPerm: item.contractType === 'PERM'
                    });
                }

                const group = aggregatedMap.get(key);
                group.unitQty += item.unitQty;
                group.totalSeconds += durationSeconds;
                
                // Update with the last seen location/path for representative display
                group.location = item.location;
                group.processPathName = item.processPathName;
                group.floor = item.floor;
            });

            const finalData = [];
            for (const group of aggregatedMap.values()) {
                const mh = group.totalSeconds > 0 ? group.totalSeconds / 3600 : 0;
                finalData.push({
                    ...group,
                    mh: mh.toFixed(4),
                    htp: (mh > 0 ? group.unitQty / mh : 0).toFixed(1),
                });
            }

            return finalData;
        }
        
        function initializeFiltersFromData(rawData) {
            const allPackTypes = new Set();
            const floors = new Set();

            rawData.forEach(item => {
                if(item.processTask.includes('PICK')) {
                    if(item.floor) floors.add(item.floor);
                } else if (item.processTask.includes('PACK')) {
                    allPackTypes.add(getPackType(item.location, item.processTask, item.processPathName));
                }
            });
            
            createFilterCheckboxes(ui.packTypeFilters, Array.from(allPackTypes).sort(), 'packTypes', 'packtypes');
            createFilterCheckboxes(ui.floorFilters, Array.from(floors).sort(), 'floors', 'floors');
            createTimeFilters();
            createTargetHtpSettings();
        }

        function createTimeFilters() {
            const allHoursCheckbox = document.getElementById('all-hours-checkbox');
            ui.hourFilters.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const hour = i.toString().padStart(2, '0');
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-sm cursor-pointer';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.value = i;
                checkbox.className = 'form-checkbox hour-checkbox';
                checkbox.addEventListener('change', (e) => {
                    const hourVal = parseInt(e.target.value);
                    if (e.target.checked) {
                        state.filters.hours.add(hourVal);
                        allHoursCheckbox.checked = false;
                    } else {
                        state.filters.hours.delete(hourVal);
                    }
                    if (state.filters.hours.size === 0) {
                        allHoursCheckbox.checked = true;
                    }
                    applyFiltersAndRender();
                });
                label.appendChild(checkbox);
                const text = document.createElement('span');
                text.textContent = hour;
                label.appendChild(text);
                ui.hourFilters.appendChild(label);
            }
            allHoursCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.querySelectorAll('.hour-checkbox').forEach(cb => cb.checked = false);
                    state.filters.hours.clear();
                    applyFiltersAndRender();
                }
            });
            document.getElementById('select-all-hours').addEventListener('click', () => {
                allHoursCheckbox.checked = false;
                document.querySelectorAll('.hour-checkbox').forEach(cb => {
                    cb.checked = true;
                    state.filters.hours.add(parseInt(cb.value));
                });
                applyFiltersAndRender();
            });
            document.getElementById('deselect-all-hours').addEventListener('click', () => {
                allHoursCheckbox.checked = true;
                document.querySelectorAll('.hour-checkbox').forEach(cb => cb.checked = false);
                state.filters.hours.clear();
                applyFiltersAndRender();
            });
        }

        function createFilterCheckboxes(container, items, filterType, type) {
            container.innerHTML = '';
            items.forEach(item => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-sm cursor-pointer';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.value = item;
                checkbox.className = `form-checkbox ${type}-checkbox`;
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) state.filters[filterType].add(item);
                    else state.filters[filterType].delete(item);
                    applyFiltersAndRender();
                });
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${item}`));
                container.appendChild(label);
            });
            
            const selectAllBtn = document.getElementById(`select-all-${type}`);
            const deselectAllBtn = document.getElementById(`deselect-all-${type}`);

            if (selectAllBtn && deselectAllBtn) {
                selectAllBtn.onclick = () => {
                    container.querySelectorAll('input').forEach(cb => { cb.checked = true; state.filters[filterType].add(cb.value); });
                    applyFiltersAndRender();
                };
                deselectAllBtn.onclick = () => {
                    container.querySelectorAll('input').forEach(cb => { cb.checked = false; state.filters[filterType].delete(cb.value); });
                    applyFiltersAndRender();
                };
            }
        }

        function createTargetHtpSettings() {
            ui.targetHtpSettings.innerHTML = '';
            for (const key in TARGET_HTP_DEFAULTS) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between';
                const label = document.createElement('label');
                label.textContent = key + ':';
                const input = document.createElement('input');
                input.type = 'number';
                input.value = targetHtpValues[key];
                input.className = 'w-20 bg-gray-800 border border-gray-600 rounded-md py-1 px-2 text-sm text-right';
                input.addEventListener('change', (e) => {
                    targetHtpValues[key] = parseFloat(e.target.value) || 0;
                    applyFiltersAndRender();
                });
                div.appendChild(label);
                div.appendChild(input);
                ui.targetHtpSettings.appendChild(div);
            }
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoader();
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    const parsedData = parseExcelData(jsonData);
                    await saveDataToFirestore(parsedData);

                } catch (error) {
                    console.error("íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                    showModal(error.message || "íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    hideLoader();
                }
            };
            reader.onerror = (error) => { console.error("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:", error); showModal("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); hideLoader(); };
            reader.readAsArrayBuffer(file);
        }

        async function saveDataToFirestore(data) {
            try {
                // To store Date objects in Firestore, they must be converted to a serializable format like ISO strings.
                const serializableData = data.map(item => ({
                    ...item,
                    htpStart: item.htpStart.toISOString(),
                    htpEnd: item.htpEnd.toISOString(),
                }));
                const jsonString = JSON.stringify(serializableData);
                const compressedData = pako.gzip(jsonString);
                const compressedBytes = Bytes.fromUint8Array(compressedData);

                const payload = { 
                    compressedData: compressedBytes, 
                    uploaderId: userId, 
                    timestamp: new Date().toISOString() 
                };
                
                await setDoc(dataDocRef, payload);
            } catch (error) {
                console.error("Firestore ì €ì¥ ì˜¤ë¥˜:", error);
                showModal("ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì´ ë„ˆë¬´ í¬ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                hideLoader();
            }
        }

        function applyFiltersAndRender() {
            if (globalRawData.length === 0) {
                renderTable([]);
                updateDashboard([]);
                return;
            };

            // 1. Filter raw data by time (pre-aggregation)
            let timeFilteredRawData = [...globalRawData];
            if (state.filters.hours.size > 0) {
                timeFilteredRawData = timeFilteredRawData.filter(item => {
                    const itemHour = item.htpStart.getUTCHours();
                    return state.filters.hours.has(itemHour);
                });
            }
            
            // 2. Aggregate the time-filtered raw data
            let aggregatedData = aggregateData(timeFilteredRawData);

            // 3. Apply display filters (process, search, lowHtp, floor, packType) to the aggregated data
            let displayFilteredData = aggregatedData;
            if (state.filters.process === 'pick') {
                displayFilteredData = displayFilteredData.filter(item => item.processType === 'PICK(ì§‘í’ˆ)');
            } else if (state.filters.process === 'pack') {
                displayFilteredData = displayFilteredData.filter(item => item.processType === 'PACK(í¬ì¥)');
            }
            if (state.filters.search) displayFilteredData = displayFilteredData.filter(item => item.employee.toLowerCase().includes(state.filters.search));
            if (state.filters.lowHtp) displayFilteredData = displayFilteredData.filter(item => parseFloat(item.htp) < getTargetHtp(item));
            
            // Apply floor and pack type filters post-aggregation
            let finalDisplayData = displayFilteredData;
            if (state.filters.floors.size > 0 && state.filters.packTypes.size > 0) {
                 finalDisplayData = displayFilteredData.filter(item => 
                    (item.processType.includes('PICK') && state.filters.floors.has(item.floor)) ||
                    (item.processType.includes('PACK') && state.filters.packTypes.has(item.packType))
                );
            } else if (state.filters.floors.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => item.processType.includes('PICK') && state.filters.floors.has(item.floor));
            } else if (state.filters.packTypes.size > 0) {
                finalDisplayData = displayFilteredData.filter(item => item.processType.includes('PACK') && state.filters.packTypes.has(item.packType));
            }
            
            // 4. Sort the final data
            if (state.sort.key && state.sort.direction) {
                const numericKeys = ['unitQty', 'mh', 'htp'];
                finalDisplayData.sort((a, b) => {
                    const key = state.sort.key;
                    const valA = a[key];
                    const valB = b[key];

                    let compareResult;
                    if (numericKeys.includes(key)) {
                        compareResult = parseFloat(valA) - parseFloat(valB);
                    } else {
                        compareResult = (valA || '').toString().localeCompare((valB || '').toString());
                    }

                    return state.sort.direction === 'asc' ? compareResult : -compareResult;
                });
            }

            // 5. Render all components
            renderTable(finalDisplayData);
            updateDashboard(finalDisplayData, timeFilteredRawData); // Pass raw data for hourly trend
            updateColumnVisibility(finalDisplayData);
            updateStats(finalDisplayData);
            updateTicker(finalDisplayData);
            updateSortIndicators();
        }

        function renderTable(data) {
            ui.tableBody.innerHTML = '';
            if (data.length === 0) {
                ui.tableBody.appendChild(ui.placeholderRow);
                ui.placeholderRow.classList.remove('hidden');
                updateStats([]);
                updateTicker([]);
                return;
            }
            ui.placeholderRow.classList.add('hidden');

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-gray-700';
                
                let processTypeColor = item.processType.includes('PICK') ? 'text-blue-400' : 'text-yellow-400';
                const targetHtp = getTargetHtp(item);
                let htpColor = parseFloat(item.htp) < targetHtp ? 'text-red-400' : 'text-green-400';
                
                let empDisplay = item.employee;
                let empColor = 'text-gray-200'; // Default to white

                if (item.isManager) {
                    empDisplay = `ğŸ‘‘ ${item.employee}`;
                    empColor = 'text-yellow-300 font-bold';
                } else if (item.isPerm) {
                    empColor = 'text-lime-400'; // Lime green for contract workers
                }

                row.innerHTML = `
                    <td class="px-4 py-3 font-medium ${processTypeColor}">${item.processType}</td>
                    <td class="px-4 py-3 ${empColor}">${empDisplay}</td>
                    <td class="px-4 py-3 text-gray-200">${item.unitQty}</td>
                    <td class="px-4 py-3 text-gray-200">${item.location || '-'}</td>
                    <td class="px-4 py-3 text-gray-200">${item.processPathName || '-'}</td>
                    <td class="px-4 py-3 text-gray-200">${item.packType}</td>
                    <td class="px-4 py-3 text-gray-200">${item.mh}</td>
                    <td class="px-4 py-3 font-bold ${htpColor}">${parseFloat(item.htp) < targetHtp && targetHtp > 0 ? 'ğŸš¨ ' : ''}${item.htp}</td>
                `;
                ui.tableBody.appendChild(row);
            });
        }

        function updateColumnVisibility(data) {
            const locationColHeader = ui.tableHeader.querySelector('th[data-sort-key="location"]');
            if (!locationColHeader) return;
            
            const locationColIndex = Array.from(locationColHeader.parentNode.children).indexOf(locationColHeader);
            const isLocationEmpty = data.length > 0 && data.every(item => !item.location);
            
            document.querySelectorAll(`#data-table th:nth-child(${locationColIndex + 1}), #data-table td:nth-child(${locationColIndex + 1})`)
                .forEach(cell => {
                    cell.classList.toggle('hidden-col', isLocationEmpty);
                });
        }

        function updateSortIndicators() {
            ui.tableHeader.querySelectorAll('.sortable').forEach(th => {
                const indicator = th.querySelector('.sort-indicator');
                const key = th.dataset.sortKey;
                indicator.classList.remove('asc', 'desc');
                indicator.textContent = '';
                if (key === state.sort.key && state.sort.direction) {
                    indicator.classList.add(state.sort.direction);
                    indicator.textContent = state.sort.direction === 'asc' ? 'â–²' : 'â–¼';
                }
            });
        }

        function updateStats(data) {
            const visibleRows = data.length;
            const visibleWorkers = new Set(data.map(d => d.employee)).size;
            const totalQty = data.reduce((sum, d) => sum + d.unitQty, 0);
            const totalMh = data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const avgHtp = totalMh > 0 ? (totalQty / totalMh).toFixed(2) : '0.00';

            ui.statsDisplay.innerHTML = `
                í‘œì‹œ ê·¸ë£¹: <span class="font-bold text-white">${visibleRows}</span> | 
                ì‘ì—…ì ìˆ˜: <span class="font-bold text-white">${visibleWorkers}</span> | 
                ì´ ì‘ì—…ëŸ‰: <span class="font-bold text-white">${totalQty.toLocaleString()}</span> | 
                í‰ê·  HTP: <span class="font-bold text-white">${avgHtp}</span>`;
        }
        
        function updateTicker(data) {
            if (data.length === 0) {
                ui.tickerText.textContent = "Top/Low HTP ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
                return;
            }
            const sortedByHtp = [...data].sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            const top3 = sortedByHtp.slice(0, 3);
            const low3 = sortedByHtp.filter(d => d.htp > 0).slice(-3).reverse();

            const formatTickerItem = (item) => `${item.employee.split('(')[0].trim()} (${item.htp})`;
            
            const topStr = "ğŸ†Top3: " + (top3.length > 0 ? top3.map(formatTickerItem).join(', ') : '-');
            const lowStr = "ğŸš¨Low3: " + (low3.length > 0 ? low3.map(formatTickerItem).join(', ') : '-');
            
            ui.tickerText.textContent = `${topStr}        ${lowStr}`;
        }

        function captureTable() {
            const tableEl = document.getElementById('data-table');
            showModal('ìº¡ì²˜ ì¤‘...', 1500);
            html2canvas(tableEl).then(canvas => {
                canvas.toBlob(blob => {
                    try {
                        navigator.clipboard.write([new ClipboardItem({'image/png': blob})])
                            .then(() => showModal('í…Œì´ë¸”ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'))
                            .catch(err => {
                                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                                showModal('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                            });
                    } catch (error) {
                         console.error('í´ë¦½ë³´ë“œ API ì˜¤ë¥˜:', error);
                         showModal('í´ë¦½ë³´ë“œ APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” í™˜ê²½ì…ë‹ˆë‹¤.');
                    }
                });
            });
        }

        function exportToExcel() {
            const dataToExport = Array.from(ui.tableBody.querySelectorAll('tr')).filter(tr => !tr.id.includes('placeholder'));
            if (dataToExport.length === 0) {
                showModal('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const pickData = [];
            const packData = [];

            dataToExport.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = {
                    'ì§‘í’ˆ/í¬ì¥': cells[0].textContent,
                    'ì´ë¦„(ì›ë°”ì½”ë“œ)': cells[1].textContent.replace(/[ğŸ‘‘ğŸ•]\s*|\[ê³„ì•½ì§\]\s*/g, ''),
                    'ì‘ì—…ëŸ‰': Number(cells[2].textContent),
                    'ë¡œì¼€ì´ì…˜ ë° ì‘ì—…ëŒ€': cells[3].textContent,
                    'PP': cells[4].textContent,
                    'íŒ© ì¢…ë¥˜': cells[5].textContent,
                    'M/H': parseFloat(cells[6].textContent),
                    'HTP': parseFloat(cells[7].textContent.replace('ğŸš¨ ', ''))
                };
                if (rowData['ì§‘í’ˆ/í¬ì¥'].includes('PICK')) {
                    pickData.push(rowData);
                } else {
                    packData.push(rowData);
                }
            });

            // Sort data by HTP (ascending) before exporting
            pickData.sort((a, b) => a.HTP - b.HTP);
            packData.sort((a, b) => a.HTP - b.HTP);

            const wb = XLSX.utils.book_new();

            const createStyledSheet = (data, sheetName) => {
                if (!data || data.length === 0) return;

                const headers = Object.keys(data[0]);
                const ws = XLSX.utils.json_to_sheet(data, { header: headers });

                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4F81BD" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
                };
                const cellStyle = {
                    alignment: { horizontal: "center", vertical: "center" },
                    border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
                };

                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const headerAddr = XLSX.utils.encode_cell({ c: C, r: 0 });
                    if (ws[headerAddr]) ws[headerAddr].s = headerStyle;

                    for (let R = 1; R <= range.e.r; ++R) {
                        const cellAddr = XLSX.utils.encode_cell({ c: C, r: R });
                        if (ws[cellAddr]) {
                            if (!ws[cellAddr].s) ws[cellAddr].s = {};
                            Object.assign(ws[cellAddr].s, cellStyle);
                            // Apply number formats
                            if (typeof ws[cellAddr].v === 'number') {
                                if (headers[C] === 'M/H') ws[cellAddr].z = '0.0000';
                                else if (headers[C] === 'HTP') ws[cellAddr].z = '0.0';
                                else if (headers[C] === 'ì‘ì—…ëŸ‰') ws[cellAddr].z = '0';
                            }
                        }
                    }
                }

                const colWidths = headers.map((header, i) => {
                    const maxLength = Math.max(
                        header.length,
                        ...data.map(row => (row[header] ? row[header].toString().length : 0))
                    );
                    return { wch: maxLength + 2 };
                });
                ws['!cols'] = colWidths;
                ws['!autofilter'] = { ref: ws['!ref'] };
                ws['!freeze'] = { ySplit: 1 };

                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            };

            createStyledSheet(pickData, "PICK(ì§‘í’ˆ)");
            createStyledSheet(packData, "PACK(í¬ì¥)");

            if (wb.SheetNames.length > 0) {
                XLSX.writeFile(wb, "HTP_Data_Export_Styled.xlsx");
            } else {
                showModal('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }


        function updateStatus(status, message) {
            const dot = ui.statusIndicator.querySelector('.status-dot');
            const text = ui.statusIndicator.querySelector('span');
            dot.className = 'status-dot';
            if (status === 'connected') dot.classList.add('status-connected');
            else if (status === 'disconnected') dot.classList.add('status-disconnected');
            else if (status === 'loading') dot.classList.add('status-loading');
            text.textContent = message;
        }

        function showLoader() { ui.loaderContainer.classList.remove('hidden'); ui.tableView.classList.add('hidden'); }
        function hideLoader() { ui.loaderContainer.classList.add('hidden'); ui.tableView.classList.remove('hidden'); }
        
        // Custom Modal instead of alert()
        function showModal(message, duration = 3000) {
            const modal = document.createElement('div');
            modal.className = 'fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-fade-in-out';
            modal.textContent = message;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fade-in-out {
                    0% { opacity: 0; transform: translateY(-20px); }
                    10% { opacity: 1; transform: translateY(0); }
                    90% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-20px); }
                }
                .animate-fade-in-out {
                    animation: fade-in-out ${duration / 1000}s ease-in-out forwards;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(modal);

            setTimeout(() => {
                modal.remove();
                style.remove();
            }, duration);
        }
        
        // --- Charting & Dashboard Functions ---
        Chart.register(ChartDataLabels); // **IMPORTANT: Register the plugin**

        function updateDashboard(filteredAggregatedData, timeFilteredRawData) {
            updateKpiCards(filteredAggregatedData);
            updatePerformersLists(filteredAggregatedData);
            updateFloorHtpChart(filteredAggregatedData);
            updatePackTypeChart(filteredAggregatedData);
            updateProcessComparisonChart(filteredAggregatedData);
            updateHourlyTrendChart(timeFilteredRawData); // Use raw data for this
        }
        
        function generateColors(numColors) {
            const colors = [
                'rgba(59, 130, 246, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(34, 197, 94, 0.7)',
                'rgba(245, 158, 11, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)',
                'rgba(16, 185, 129, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(99, 102, 241, 0.7)'
            ];
            const result = [];
            for (let i = 0; i < numColors; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        function updateKpiCards(data) {
            const totalWorkers = new Set(data.map(d => d.employee)).size;
            const totalQty = data.reduce((sum, d) => sum + d.unitQty, 0);
            const totalMh = data.reduce((sum, d) => sum + parseFloat(d.mh), 0);
            const avgHtp = totalMh > 0 ? (totalQty / totalMh) : 0;
            const lowPerformers = data.filter(d => parseFloat(d.htp) < getTargetHtp(d)).length;

            ui.kpi.totalWorkers.textContent = totalWorkers.toLocaleString();
            ui.kpi.totalQty.textContent = totalQty.toLocaleString();
            ui.kpi.avgHtp.textContent = avgHtp.toFixed(1);
            ui.kpi.lowPerformers.textContent = lowPerformers.toLocaleString();
        }

        function updatePerformersLists(data) {
            ui.topPerformersList.innerHTML = '';
            ui.lowPerformersList.innerHTML = '';

            if (data.length === 0) {
                ui.topPerformersList.innerHTML = '<li class="text-gray-500">ë°ì´í„° ì—†ìŒ</li>';
                ui.lowPerformersList.innerHTML = '<li class="text-gray-500">ë°ì´í„° ì—†ìŒ</li>';
                return;
            }

            const sortedByHtp = [...data].sort((a, b) => parseFloat(b.htp) - parseFloat(a.htp));
            const top5 = sortedByHtp.slice(0, 5);
            const low5 = sortedByHtp.filter(d => d.htp > 0).slice(-5).reverse();

            const createListItem = (item, isTop) => {
                const color = isTop ? 'text-green-400' : 'text-red-400';
                return `<li class="flex justify-between items-center bg-gray-700 p-2 rounded-md">
                            <span>${item.employee.split('(')[0].trim()} <span class="text-xs text-gray-400">${item.processType.split('(')[0]}</span></span>
                            <span class="font-bold ${color}">${item.htp}</span>
                        </li>`;
            };

            top5.forEach(item => ui.topPerformersList.innerHTML += createListItem(item, true));
            low5.forEach(item => ui.lowPerformersList.innerHTML += createListItem(item, false));

            if (top5.length === 0) ui.topPerformersList.innerHTML = '<li class="text-gray-500">ë°ì´í„° ì—†ìŒ</li>';
            if (low5.length === 0) ui.lowPerformersList.innerHTML = '<li class="text-gray-500">ë°ì´í„° ì—†ìŒ</li>';
        }

        function updateFloorHtpChart(data) {
            const pickData = data.filter(d => d.processType.includes('PICK'));
            const floorData = new Map();

            pickData.forEach(item => {
                if (!floorData.has(item.floor)) {
                    floorData.set(item.floor, { totalQty: 0, totalMh: 0 });
                }
                const floor = floorData.get(item.floor);
                floor.totalQty += item.unitQty;
                floor.totalMh += parseFloat(item.mh);
            });

            const sortedFloors = Array.from(floorData.keys()).sort();
            const labels = sortedFloors;
            const avgHtps = sortedFloors.map(floor => {
                 const d = floorData.get(floor);
                 const weightedAvgHtp = d.totalMh > 0 ? (d.totalQty / d.totalMh) : 0;
                 return weightedAvgHtp.toFixed(1);
            });


            const ctx = document.getElementById('floor-htp-chart').getContext('2d');
            if (state.charts.floorHtp) {
                state.charts.floorHtp.destroy();
            }
            state.charts.floorHtp = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'í‰ê·  HTP',
                        data: avgHtps,
                        backgroundColor: generateColors(labels.length),
                        borderColor: '#4b5563',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#d1d5db' } },
                        x: { ticks: { color: '#d1d5db' } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#FFFFFF',
                            font: { weight: 'bold' },
                            formatter: (value) => value > 0 ? value : ''
                        }
                    }
                }
            });
        }

        function updatePackTypeChart(data) {
            const packData = data.filter(d => d.processType.includes('PACK'));
            let packTypeData = new Map();
            let totalQuantity = 0;

            packData.forEach(item => {
                if (!packTypeData.has(item.packType)) {
                    packTypeData.set(item.packType, 0);
                }
                const currentQty = packTypeData.get(item.packType);
                packTypeData.set(item.packType, currentQty + item.unitQty);
                totalQuantity += item.unitQty;
            });
            
            // Group small slices into 'ê¸°íƒ€'
            const otherThreshold = 0.02; // 2%
            let otherQuantity = 0;
            const finalPackData = new Map();
            
            packTypeData.forEach((qty, type) => {
                if (totalQuantity > 0 && (qty / totalQuantity) < otherThreshold) {
                    otherQuantity += qty;
                } else {
                    finalPackData.set(type, qty);
                }
            });

            if (otherQuantity > 0) {
                finalPackData.set('ê¸°íƒ€', (finalPackData.get('ê¸°íƒ€') || 0) + otherQuantity);
            }

            const labels = Array.from(finalPackData.keys());
            const quantities = Array.from(finalPackData.values());

            const ctx = document.getElementById('pack-type-chart').getContext('2d');
            if (state.charts.packType) {
                state.charts.packType.destroy();
            }
            state.charts.packType = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì‘ì—…ëŸ‰',
                        data: quantities,
                        backgroundColor: generateColors(labels.length),
                        borderColor: '#374151',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#d1d5db' } },
                        datalabels: {
                            color: '#FFFFFF',
                            textAlign: 'center',
                            font: { weight: 'bold' },
                            formatter: (value, context) => {
                                const percentage = totalQuantity > 0 ? (value / totalQuantity * 100).toFixed(1) : 0;
                                const label = context.chart.data.labels[context.dataIndex];
                                if (parseFloat(percentage) < 5) return ''; // Hide label for very small slices
                                return `${label}\n${percentage}%`;
                            }
                        }
                    }
                }
            });
        }

        function updateProcessComparisonChart(data) {
            const processStats = {
                PICK: { totalQty: 0, totalMh: 0 },
                PACK: { totalQty: 0, totalMh: 0 },
            };

            data.forEach(item => {
                const type = item.processType.includes('PICK') ? 'PICK' : 'PACK';
                processStats[type].totalQty += item.unitQty;
                processStats[type].totalMh += parseFloat(item.mh);
            });

            const pickHtp = processStats.PICK.totalMh > 0 ? (processStats.PICK.totalQty / processStats.PICK.totalMh) : 0;
            const packHtp = processStats.PACK.totalMh > 0 ? (processStats.PACK.totalQty / processStats.PACK.totalMh) : 0;

            const ctx = document.getElementById('process-comparison-chart').getContext('2d');
            if (state.charts.processComparison) {
                state.charts.processComparison.destroy();
            }
            state.charts.processComparison = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['PICK(ì§‘í’ˆ)', 'PACK(í¬ì¥)'],
                    datasets: [{
                        label: 'ì´ ì‘ì—…ëŸ‰',
                        data: [processStats.PICK.totalQty, processStats.PACK.totalQty],
                        backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)'],
                        borderColor: '#374151',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#d1d5db' } },
                        datalabels: {
                             color: '#fff',
                             font: { weight: 'bold' },
                             formatter: (value, context) => {
                                const label = context.chart.data.labels[context.dataIndex];
                                const htp = label.includes('PICK') ? pickHtp : packHtp;
                                return `${value.toLocaleString()}\n(Avg ${htp.toFixed(0)} HTP)`;
                             }
                        }
                    }
                }
            });
        }

        function updateHourlyTrendChart(rawData) {
             const hourlyData = new Map();
             for(let i=0; i<24; i++) {
                hourlyData.set(i, { unitQty: 0, totalSeconds: 0 });
             }

             rawData.forEach(item => {
                const hour = item.htpStart.getUTCHours();
                const stats = hourlyData.get(hour);
                if(stats){
                    stats.unitQty += item.unitQty;
                    stats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
                }
             });

            const sortedHours = Array.from(hourlyData.keys()).sort((a, b) => a - b);
            const labels = sortedHours.map(hour => `${hour.toString().padStart(2, '0')}:00`);
            const htpValues = sortedHours.map(hour => {
                const stats = hourlyData.get(hour);
                if (!stats || stats.totalSeconds <= 0) return 0;
                const mh = stats.totalSeconds / 3600;
                return (stats.unitQty / mh).toFixed(1);
            });

            const ctx = document.getElementById('hourly-htp-chart').getContext('2d');
            if (state.charts.hourlyHtp) {
                state.charts.hourlyHtp.destroy();
            }
            state.charts.hourlyHtp = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì‹œê°„ë³„ í‰ê·  HTP',
                        data: htpValues,
                        fill: true,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, ticks: { color: '#d1d5db' } },
                        x: { ticks: { color: '#d1d5db', maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false }
                    }
                }
            });
        }

        function showIndividualTrend(employeeName, processType) {
            const targetProcessTask = processType.includes('PICK') ? 'PICK(PICKING)' : 'PACK(PACKING)';
            const employeeData = globalRawData.filter(d => d.employee === employeeName && d.processTask === targetProcessTask);
            
            if (employeeData.length === 0) {
                showModal(`${employeeName.split('(')[0]} ë‹˜ì˜ í•´ë‹¹ ê³µì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            const hourlyData = new Map();
            employeeData.forEach(item => {
                const hour = item.htpStart.getUTCHours(); // Use UTC hours for consistency
                if (!hourlyData.has(hour)) {
                    hourlyData.set(hour, { unitQty: 0, totalSeconds: 0 });
                }
                const hourStats = hourlyData.get(hour);
                hourStats.unitQty += item.unitQty;
                hourStats.totalSeconds += (item.htpEnd - item.htpStart) / 1000;
            });

            const sortedHours = Array.from(hourlyData.keys()).sort((a, b) => a - b);
            
            const labels = sortedHours.map(hour => `${hour}ì‹œ`);
            const htpValues = sortedHours.map(hour => {
                const stats = hourlyData.get(hour);
                const mh = stats.totalSeconds / 3600;
                return mh > 0 ? (stats.unitQty / mh).toFixed(1) : 0;
            });

            ui.chartModalTitle.textContent = `${employeeName} ë‹˜ì˜ ì‹œê°„ëŒ€ë³„ HTP (${processType.split('(')[0]})`;
            const ctx = document.getElementById('individual-htp-chart').getContext('2d');
            if (state.charts.individualHtp) {
                state.charts.individualHtp.destroy();
            }
            state.charts.individualHtp = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì‹œê°„ë³„ HTP',
                        data: htpValues,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#d1d5db' } },
                        x: { ticks: { color: '#d1d5db' } }
                    },
                    plugins: { 
                        legend: { labels: { color: '#d1d5db' } },
                        datalabels: {
                            align: 'top',
                            color: '#FFFFFF'
                        }
                    }
                }
            });

            ui.chartModalBackdrop.classList.remove('hidden');
            ui.chartModalBackdrop.classList.add('flex');
        }

        // Initialize on page load
        initializeFiltersFromData([]);

    </script>
</body>
</html>